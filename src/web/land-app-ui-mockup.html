<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Land App - Advanced Land Management Platform</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <style>
        :root {
            /* Material Design 3 Color System */
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            
            --md-sys-color-tertiary: #7D5260;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #FFD8E4;
            --md-sys-color-on-tertiary-container: #31111D;
            
            --md-sys-color-surface: #FEF7FF;
            --md-sys-color-surface-dim: #DED8E1;
            --md-sys-color-surface-bright: #FEF7FF;
            --md-sys-color-surface-container-lowest: #FFFFFF;
            --md-sys-color-surface-container-low: #F7F2FA;
            --md-sys-color-surface-container: #F3EDF7;
            --md-sys-color-surface-container-high: #ECE6F0;
            --md-sys-color-surface-container-highest: #E6E0E9;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-on-surface-variant: #49454F;
            
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
            
            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #F9DEDC;
            --md-sys-color-on-error-container: #410E0B;
            
            /* Land Management Semantic Colors */
            --land-color-vegetation: #4CAF50;
            --land-color-water: #2196F3;
            --land-color-soil: #8D6E63;
            --land-color-crops: #FF9800;
            --land-color-warning: #FF5722;
            
            /* Material Design 3 Elevation */
            --md-sys-elevation-level0: 0px 0px 0px 0px rgba(0, 0, 0, 0.00), 0px 0px 0px 0px rgba(0, 0, 0, 0.00);
            --md-sys-elevation-level1: 0px 1px 2px 0px rgba(0, 0, 0, 0.30), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-level2: 0px 1px 2px 0px rgba(0, 0, 0, 0.30), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-level3: 0px 1px 3px 0px rgba(0, 0, 0, 0.30), 0px 4px 8px 3px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-level4: 0px 2px 3px 0px rgba(0, 0, 0, 0.30), 0px 6px 10px 4px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-level5: 0px 4px 4px 0px rgba(0, 0, 0, 0.30), 0px 8px 12px 6px rgba(0, 0, 0, 0.15);
            
            /* Typography Scale */
            --md-sys-typescale-display-large-font: 'Google Sans';
            --md-sys-typescale-display-large-size: 57px;
            --md-sys-typescale-display-large-weight: 400;
            --md-sys-typescale-display-large-line-height: 64px;
            
            --md-sys-typescale-headline-large-font: 'Google Sans';
            --md-sys-typescale-headline-large-size: 32px;
            --md-sys-typescale-headline-large-weight: 400;
            --md-sys-typescale-headline-large-line-height: 40px;
            
            --md-sys-typescale-headline-medium-font: 'Google Sans';
            --md-sys-typescale-headline-medium-size: 28px;
            --md-sys-typescale-headline-medium-weight: 400;
            --md-sys-typescale-headline-medium-line-height: 36px;
            
            --md-sys-typescale-title-large-font: 'Google Sans';
            --md-sys-typescale-title-large-size: 22px;
            --md-sys-typescale-title-large-weight: 400;
            --md-sys-typescale-title-large-line-height: 28px;
            
            --md-sys-typescale-title-medium-font: 'Google Sans';
            --md-sys-typescale-title-medium-size: 16px;
            --md-sys-typescale-title-medium-weight: 500;
            --md-sys-typescale-title-medium-line-height: 24px;
            
            --md-sys-typescale-body-large-font: 'Google Sans';
            --md-sys-typescale-body-large-size: 16px;
            --md-sys-typescale-body-large-weight: 400;
            --md-sys-typescale-body-large-line-height: 24px;
            
            --md-sys-typescale-body-medium-font: 'Google Sans';
            --md-sys-typescale-body-medium-size: 14px;
            --md-sys-typescale-body-medium-weight: 400;
            --md-sys-typescale-body-medium-line-height: 20px;
            
            --md-sys-typescale-label-large-font: 'Google Sans';
            --md-sys-typescale-label-large-size: 14px;
            --md-sys-typescale-label-large-weight: 500;
            --md-sys-typescale-label-large-line-height: 20px;
            
            /* Shape System */
            --md-sys-shape-corner-none: 0px;
            --md-sys-shape-corner-extra-small: 4px;
            --md-sys-shape-corner-small: 8px;
            --md-sys-shape-corner-medium: 12px;
            --md-sys-shape-corner-large: 16px;
            --md-sys-shape-corner-extra-large: 28px;
            --md-sys-shape-corner-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--md-sys-typescale-body-medium-font), -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: var(--md-sys-typescale-body-medium-size);
            font-weight: var(--md-sys-typescale-body-medium-weight);
            line-height: var(--md-sys-typescale-body-medium-line-height);
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            overflow: hidden;
        }

        /* Material 3 Header */
        .header {
            background: var(--md-sys-color-surface-container);
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            position: relative;
            z-index: 1000;
            box-shadow: var(--md-sys-elevation-level2);
        }

        .back-to-dashboard {
            display: flex;
            align-items: center;
        }

        .dashboard-back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            background: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
            border-radius: var(--md-sys-shape-corner-medium);
            cursor: pointer;
            font-family: var(--md-sys-typescale-body-medium-font);
            font-size: var(--md-sys-typescale-body-medium-size);
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .dashboard-back-btn:hover {
            background: var(--md-sys-color-surface-container-high);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .dashboard-back-btn:active {
            background: var(--md-sys-color-surface-container-highest);
            transform: scale(0.98);
        }

        .dashboard-back-btn i {
            font-size: 20px;
        }

        .header-title {
            flex: 0 0 auto;
            text-align: left;
            font-family: var(--md-sys-typescale-body-large-font);
            font-size: var(--md-sys-typescale-body-large-size);
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            outline: none;
            padding: 8px 16px;
            border-radius: var(--md-sys-shape-corner-medium);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            cursor: text;
            position: relative;
            background: var(--md-sys-color-surface-container);
            border: 1px solid var(--md-sys-color-outline-variant);
            margin-left: 16px;
            min-width: 200px;
            max-width: 400px;
        }

        .header-title:hover {
            background: var(--md-sys-color-surface-container-high);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .header-title:focus {
            background: var(--md-sys-color-surface-container-highest);
            border: 2px solid var(--md-sys-color-primary);
            box-shadow: var(--md-sys-elevation-level2);
        }

        .header-title::before {
            content: "✏️";
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 12px;
        }

        .header-title:hover::before {
            opacity: 0.7;
        }

        /* OSM Panel Styles */
        .osm-panel {
            position: fixed;
            top: 64px;
            right: -450px;
            width: 450px;
            height: calc(100vh - 64px);
            background: var(--md-sys-color-surface-container);
            border-left: 1px solid var(--md-sys-color-outline-variant);
            box-shadow: var(--md-sys-elevation-level3);
            transition: right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            z-index: 1400;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .osm-panel.visible {
            right: 0;
        }

        .osm-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--md-sys-color-surface-container-high);
        }

        .osm-header h3 {
            margin: 0;
            font-family: var(--md-sys-typescale-title-medium-font);
            font-size: var(--md-sys-typescale-title-medium-size);
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .osm-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .osm-features-section h4,
        .osm-history-section h4,
        .osm-results-section h4 {
            margin: 0 0 12px 0;
            font-family: var(--md-sys-typescale-title-small-font);
            font-size: 16px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .section-description {
            margin: 0 0 20px 0;
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            line-height: 1.4;
        }

        /* Smart Query Input */
        .query-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        #smartQueryInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-family: var(--md-sys-typescale-body-medium-font);
            font-size: var(--md-sys-typescale-body-medium-size);
        }

        #smartQueryInput:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 2px rgba(103, 80, 164, 0.2);
        }

        .query-submit-btn {
            padding: 12px;
            background: var(--land-color-vegetation);
            color: white;
            border: none;
            border-radius: var(--md-sys-shape-corner-medium);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .query-submit-btn:hover {
            background: #43A047;
        }

        .query-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-chip {
            padding: 6px 12px;
            background: var(--md-sys-color-surface-container-high);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 16px;
            cursor: pointer;
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            background: var(--md-sys-color-primary-container);
            border-color: var(--md-sys-color-primary);
        }

        /* Preset Grid */
        .preset-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .preset-card {
            padding: 16px;
            background: var(--md-sys-color-surface-container-high);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-large);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .preset-card:hover {
            background: var(--md-sys-color-primary-container);
            border-color: var(--md-sys-color-primary);
            transform: translateY(-2px);
            box-shadow: var(--md-sys-elevation-level2);
        }

        .preset-card i {
            font-size: 24px;
            color: var(--land-color-vegetation);
        }

        .preset-card span {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        /* Query Builder */
        .builder-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .builder-select,
        .builder-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-small);
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-size: 14px;
        }

        .build-query-btn {
            padding: 10px 16px;
            background: var(--md-sys-color-secondary);
            color: var(--md-sys-color-on-secondary);
            border: none;
            border-radius: var(--md-sys-shape-corner-medium);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .build-query-btn:hover {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        /* History */
        .history-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-small);
            margin-bottom: 8px;
        }

        .history-query {
            flex: 1;
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
        }

        .history-rerun,
        .history-favorite {
            padding: 4px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            border-radius: var(--md-sys-shape-corner-small);
            transition: background-color 0.2s;
        }

        .history-rerun:hover,
        .history-favorite:hover {
            background: var(--md-sys-color-surface-container-high);
        }

        .history-favorite.favorited {
            color: var(--land-color-crops);
        }

        /* Results */
        .result-count {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: normal;
        }

        .results-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .results-btn {
            padding: 8px 16px;
            background: var(--md-sys-color-surface-container-high);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
            transition: all 0.2s;
        }

        .results-btn:hover {
            background: var(--md-sys-color-primary-container);
            border-color: var(--md-sys-color-primary);
        }

        .results-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .result-item {
            padding: 12px;
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-small);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .result-item:hover {
            background: var(--md-sys-color-surface-container-high);
            border-color: var(--md-sys-color-primary);
        }

        .result-name {
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 4px;
        }

        .result-type {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-distance {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            float: right;
        }

        /* Feature Toggle Styles */
        .feature-category {
            margin-bottom: 24px;
            background: var(--md-sys-color-surface-container-low);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 16px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .category-title {
            margin: 0 0 16px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-title i {
            font-size: 20px;
            color: var(--land-color-vegetation);
        }

        .feature-toggles {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .feature-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--md-sys-shape-corner-small);
            transition: background-color 0.2s;
        }

        .feature-toggle:hover {
            background: var(--md-sys-color-surface-container);
        }

        .feature-toggle input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--md-sys-color-outline);
            border-radius: 12px;
            transition: background-color 0.3s;
            cursor: pointer;
            flex-shrink: 0;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .feature-toggle input[type="checkbox"]:checked + .toggle-slider {
            background: var(--land-color-vegetation);
        }

        .feature-toggle input[type="checkbox"]:checked + .toggle-slider::before {
            transform: translateX(20px);
        }

        .feature-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            flex: 1;
        }

        .active-features-list {
            min-height: 100px;
        }

        .no-features {
            text-align: center;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
            margin: 20px 0;
            padding: 20px;
            background: var(--md-sys-color-surface-container-low);
            border-radius: var(--md-sys-shape-corner-medium);
            border: 1px dashed var(--md-sys-color-outline-variant);
        }

        .active-feature-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-small);
            margin-bottom: 8px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .active-feature-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .active-feature-name {
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .active-feature-count {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            background: var(--md-sys-color-surface-container-highest);
            padding: 4px 8px;
            border-radius: 12px;
        }

        /* OSM Feature Inspection Panel */
        .osm-inspection-panel {
            position: fixed;
            top: 64px;
            right: -500px;
            width: 500px;
            height: calc(100vh - 64px);
            background: var(--md-sys-color-surface-container);
            border-left: 1px solid var(--md-sys-color-outline-variant);
            box-shadow: var(--md-sys-elevation-level4);
            transition: right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            z-index: 1500;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .osm-inspection-panel.visible {
            right: 0;
        }

        .inspection-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--md-sys-color-surface-container-high);
        }

        .inspection-header h3 {
            margin: 0;
            font-family: var(--md-sys-typescale-title-medium-font);
            font-size: var(--md-sys-typescale-title-medium-size);
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .inspection-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .inspection-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            gap: 16px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .feature-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-medium);
        }

        .feature-icon {
            width: 48px;
            height: 48px;
            background: var(--land-color-vegetation);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .feature-title {
            flex: 1;
        }

        .feature-name {
            font-size: 20px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            margin: 0 0 4px 0;
        }

        .feature-category {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            margin: 0;
        }

        .feature-section {
            margin-bottom: 24px;
        }

        .feature-section h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feature-property {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .feature-property:last-child {
            border-bottom: none;
        }

        .property-label {
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            text-transform: capitalize;
        }

        .property-value {
            color: var(--md-sys-color-on-surface);
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }

        .property-value a {
            color: var(--land-color-vegetation);
            text-decoration: none;
        }

        .property-value a:hover {
            text-decoration: underline;
        }

        .coordinates-section {
            background: var(--md-sys-color-surface-container-low);
            padding: 16px;
            border-radius: var(--md-sys-shape-corner-medium);
            margin-bottom: 24px;
        }

        .coordinates-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .coord-item {
            text-align: center;
        }

        .coord-label {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .coord-value {
            font-family: monospace;
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
            background: var(--md-sys-color-surface);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .action-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: var(--md-sys-shape-corner-medium);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn.primary {
            background: var(--land-color-vegetation);
            color: white;
        }

        .action-btn.primary:hover {
            background: #43A047;
            box-shadow: var(--md-sys-elevation-level2);
        }

        .action-btn.secondary {
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .action-btn.secondary:hover {
            background: var(--md-sys-color-surface-container-highest);
        }

        .related-features {
            background: var(--md-sys-color-surface-container-low);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 16px;
        }

        .related-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
            margin: 0 -8px;
            padding: 8px;
        }

        .related-item:hover {
            background: var(--md-sys-color-surface-container);
        }

        .related-icon {
            width: 32px;
            height: 32px;
            background: var(--md-sys-color-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .related-info {
            flex: 1;
        }

        .related-name {
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin: 0 0 2px 0;
        }

        .related-distance {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            margin: 0;
        }

        /* Polygon Information Panel */
        .polygon-info-panel {
            position: fixed;
            top: 64px;
            right: -550px;
            width: 550px;
            height: calc(100vh - 64px);
            background: var(--md-sys-color-surface-container);
            border-left: 1px solid var(--md-sys-color-outline-variant);
            box-shadow: var(--md-sys-elevation-level4);
            transition: right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            z-index: 1600;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .polygon-info-panel.visible {
            right: 0;
        }

        /* Context Menu Styles */
        .context-menu {
            position: fixed;
            background: var(--md-sys-color-surface-container);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            box-shadow: var(--md-sys-elevation-level3);
            padding: 8px 0;
            min-width: 200px;
            z-index: 10000;
            display: none;
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: var(--md-sys-color-on-surface);
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background: var(--md-sys-color-surface-container-high);
        }

        .context-menu-item i {
            font-size: 18px;
            color: var(--md-sys-color-primary);
        }

        .context-menu-separator {
            height: 1px;
            background: var(--md-sys-color-outline-variant);
            margin: 4px 0;
        }

        /* Plan Selection Modal */
        .plan-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .plan-selection-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .plan-selection-dialog {
            background: var(--md-sys-color-surface);
            border-radius: var(--md-sys-shape-corner-large);
            box-shadow: var(--md-sys-elevation-level5);
            padding: 24px;
            min-width: 400px;
            max-width: 500px;
            max-height: 70vh;
            overflow: hidden;
        }

        .plan-selection-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .plan-selection-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .plan-selection-content {
            max-height: 300px;
            overflow-y: auto;
        }

        .plan-option {
            padding: 12px;
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .plan-option:hover {
            background: var(--md-sys-color-surface-container);
            border-color: var(--md-sys-color-primary);
        }

        .plan-option.selected {
            background: var(--md-sys-color-primary-container);
            border-color: var(--md-sys-color-primary);
        }

        .plan-option-icon {
            width: 40px;
            height: 40px;
            background: var(--md-sys-color-primary);
            border-radius: var(--md-sys-shape-corner-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-primary);
        }

        .plan-option-info h4 {
            margin: 0 0 4px 0;
            font-size: 16px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .plan-option-info p {
            margin: 0;
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .plan-selection-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
        }

        .plan-action-btn {
            padding: 10px 24px;
            border-radius: var(--md-sys-shape-corner-full);
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plan-action-btn.secondary {
            background: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
        }

        .plan-action-btn.primary {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .plan-action-btn:hover {
            box-shadow: var(--md-sys-elevation-level1);
        }

        .polygon-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--md-sys-color-surface-container-high);
        }

        .polygon-header h3 {
            margin: 0;
            font-family: var(--md-sys-typescale-title-medium-font);
            font-size: var(--md-sys-typescale-title-medium-size);
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .polygon-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .polygon-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            gap: 16px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .area-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 32px;
            padding: 24px;
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-large);
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .area-icon {
            width: 64px;
            height: 64px;
            background: var(--land-color-vegetation);
            border-radius: var(--md-sys-shape-corner-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            flex-shrink: 0;
        }

        .area-info {
            flex: 1;
        }

        .area-name {
            font-size: 24px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            margin: 0 0 8px 0;
        }

        .area-type {
            font-size: 16px;
            color: var(--md-sys-color-on-surface-variant);
            margin: 0 0 8px 0;
        }

        .area-size {
            font-size: 14px;
            color: var(--land-color-vegetation);
            font-weight: 500;
            margin: 0;
        }

        .area-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--md-sys-color-surface-container-low);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 16px;
            text-align: center;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            margin: 0 0 4px 0;
        }

        .stat-label {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .area-details {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .detail-section {
            background: var(--md-sys-color-surface-container-low);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 20px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .detail-section h4 {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
        }

        .detail-value {
            color: var(--md-sys-color-on-surface);
            font-weight: 500;
        }

        .polygon-actions {
            margin-top: 24px;
            display: flex;
            gap: 12px;
        }

        .polygon-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: var(--md-sys-shape-corner-medium);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .polygon-btn.primary {
            background: var(--land-color-vegetation);
            color: white;
        }

        .polygon-btn.primary:hover {
            background: #43A047;
            box-shadow: var(--md-sys-elevation-level2);
        }

        .polygon-btn.secondary {
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .polygon-btn.secondary:hover {
            background: var(--md-sys-color-surface-container-highest);
        }

        /* Learning Center Styles */
        .learning-center {
            display: none;
            min-height: 100vh;
            height: 100vh;
            background: var(--md-sys-color-surface);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            overflow: hidden;
            flex-direction: column;
        }

        .learning-center.active {
            display: flex !important;
        }

        .learning-header {
            background: linear-gradient(135deg, var(--md-sys-color-surface) 0%, var(--md-sys-color-surface-container-low) 100%);
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            color: var(--md-sys-color-on-surface);
            padding: 40px 32px;
            box-shadow: 0 1px 6px 0 rgba(32, 33, 36, 0.28);
            position: relative;
            flex-shrink: 0;
        }

        .learning-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: var(--md-sys-shape-corner-full);
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            transition: all 0.15s cubic-bezier(0.4, 0.0, 0.2, 1);
            z-index: 10;
            box-shadow: 0 1px 3px 0 rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
        }

        .learning-close-btn:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 2px 6px 2px rgba(60, 64, 67, 0.15), 0 8px 24px 4px rgba(60, 64, 67, 0.15);
            transform: translateY(-1px);
        }

        .learning-close-btn:active {
            transform: translateY(0px);
            box-shadow: 0 1px 3px 0 rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
        }

        .learning-header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 40px;
        }

        .learning-title {
            font-family: var(--md-sys-typescale-headline-medium-font);
            font-size: var(--md-sys-typescale-headline-medium-size);
            font-weight: var(--md-sys-typescale-headline-medium-weight);
            color: var(--md-sys-color-on-surface);
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .learning-title i {
            font-size: 32px;
            color: var(--land-color-vegetation);
        }

        .learning-subtitle {
            font-family: var(--md-sys-typescale-body-large-font);
            font-size: var(--md-sys-typescale-body-large-size);
            color: var(--md-sys-color-on-surface-variant);
            margin: 0;
        }

        .learning-stats {
            display: flex;
            gap: 24px;
        }

        .stat-card {
            background: var(--md-sys-color-surface-container-high);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 16px;
            padding: 24px 20px;
            text-align: center;
            min-width: 140px;
            box-shadow: 0 1px 3px 0 rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
            transition: all 0.15s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .stat-card:hover {
            box-shadow: 0 2px 6px 2px rgba(60, 64, 67, 0.15), 0 8px 24px 4px rgba(60, 64, 67, 0.15);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            line-height: 1;
            margin-bottom: 4px;
            color: var(--md-sys-color-on-surface);
        }

        .stat-label {
            font-size: var(--md-sys-typescale-body-medium-size);
            color: var(--md-sys-color-on-surface-variant);
        }

        .learning-nav {
            background: var(--md-sys-color-surface);
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            padding: 16px 32px;
            display: flex;
            gap: 4px;
            overflow-x: auto;
            flex-shrink: 0;
            box-shadow: 0 1px 3px 0 rgba(60, 64, 67, 0.08);
        }

        .learning-nav-btn {
            background: none;
            border: 1px solid transparent;
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--md-sys-typescale-body-medium-font);
            font-size: var(--md-sys-typescale-body-medium-size);
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            border-radius: 24px;
            transition: all 0.15s cubic-bezier(0.4, 0.0, 0.2, 1);
            white-space: nowrap;
            position: relative;
        }

        .learning-nav-btn:hover {
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
            border-color: var(--md-sys-color-outline-variant);
        }

        .learning-nav-btn.active {
            background: var(--land-color-vegetation);
            color: white;
            border-color: var(--land-color-vegetation);
            box-shadow: 0 1px 3px 0 rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
        }

        .learning-nav-btn.active:hover {
            background: #43A047;
            border-color: #43A047;
        }

        .learning-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .learning-content-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px;
        }

        .learning-section {
            display: none;
        }

        .learning-section.active {
            display: block;
        }

        .learning-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 32px;
            margin-bottom: 40px;
        }

        .learning-card {
            background: var(--md-sys-color-surface-container);
            border-radius: 16px;
            border: 1px solid var(--md-sys-color-outline-variant);
            overflow: hidden;
            transition: all 0.25s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 1px 3px 0 rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
        }

        .learning-card:hover {
            box-shadow: 0 2px 6px 2px rgba(60, 64, 67, 0.15), 0 8px 24px 4px rgba(60, 64, 67, 0.15);
            transform: translateY(-4px);
            border-color: var(--md-sys-color-outline);
        }

        .learning-card.featured {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--md-sys-color-primary-container) 0%, var(--md-sys-color-secondary-container) 100%);
        }

        .card-header {
            padding: 20px 24px 0 24px;
        }

        .card-header h3 {
            margin: 0;
            font-family: var(--md-sys-typescale-title-medium-font);
            font-size: var(--md-sys-typescale-title-medium-size);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--md-sys-color-on-surface);
        }

        .current-course {
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .course-thumbnail {
            flex-shrink: 0;
        }

        .course-thumbnail img {
            width: 120px;
            height: 80px;
            border-radius: var(--md-sys-shape-corner-medium);
            object-fit: cover;
        }

        .course-info {
            flex: 1;
        }

        .course-info h4 {
            margin: 0 0 4px 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .course-info p {
            margin: 0 0 12px 0;
            color: var(--md-sys-color-on-surface-variant);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--md-sys-color-surface-container-highest);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--md-sys-color-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .continue-btn {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            padding: 12px 24px;
            border-radius: var(--md-sys-shape-corner-medium);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .continue-btn:hover {
            background: var(--md-sys-color-primary);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .quick-actions {
            padding: 24px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .quick-action {
            background: var(--md-sys-color-surface-container-high);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 16px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            color: var(--md-sys-color-on-surface);
        }

        .quick-action:hover {
            background: var(--md-sys-color-surface-container-highest);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .activity-list {
            padding: 24px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon.completed {
            background: var(--land-color-vegetation);
            color: white;
        }

        .activity-icon.quiz {
            background: var(--md-sys-color-secondary);
            color: var(--md-sys-color-on-secondary);
        }

        .activity-icon.certificate {
            background: var(--md-sys-color-tertiary);
            color: var(--md-sys-color-on-tertiary);
        }

        .activity-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .activity-title {
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .activity-time {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .recommendation-list {
            padding: 24px;
        }

        .recommendation-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .recommendation-item:last-child {
            border-bottom: none;
        }

        .rec-thumbnail {
            width: 48px;
            height: 48px;
            background: var(--md-sys-color-primary-container);
            border-radius: var(--md-sys-shape-corner-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-primary-container);
            flex-shrink: 0;
        }

        .rec-content {
            flex: 1;
        }

        .rec-content h4 {
            margin: 0 0 4px 0;
            font-size: 16px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .rec-content p {
            margin: 0 0 8px 0;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }

        .rec-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .difficulty {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .difficulty.beginner {
            background: var(--land-color-vegetation);
            color: white;
        }

        .difficulty.intermediate {
            background: var(--land-color-crops);
            color: white;
        }

        .difficulty.advanced {
            background: var(--land-color-warning);
            color: white;
        }

        .rating {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
        }

        /* Course Library Styles */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 40px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .section-header h2 {
            margin: 0;
            font-family: var(--md-sys-typescale-headline-medium-font);
            font-size: 32px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
            letter-spacing: -0.25px;
        }

        .course-filters {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            background: var(--md-sys-color-surface-container);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 20px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            transition: all 0.15s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .filter-btn:hover {
            background: var(--md-sys-color-surface-container-high);
            border-color: var(--md-sys-color-outline);
        }

        .filter-btn.active {
            background: var(--land-color-vegetation);
            color: white;
            border-color: var(--land-color-vegetation);
            box-shadow: 0 1px 3px 0 rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
        }

        .track-section {
            margin-bottom: 48px;
        }

        .track-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0 0 24px 0;
            font-family: var(--md-sys-typescale-title-large-font);
            font-size: var(--md-sys-typescale-title-large-size);
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }

        .course-card {
            background: var(--md-sys-color-surface-container);
            border-radius: 16px;
            border: 1px solid var(--md-sys-color-outline-variant);
            overflow: hidden;
            transition: all 0.25s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 1px 3px 0 rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
        }

        .course-card:hover {
            box-shadow: 0 2px 6px 2px rgba(60, 64, 67, 0.15), 0 8px 24px 4px rgba(60, 64, 67, 0.15);
            transform: translateY(-4px);
            border-color: var(--md-sys-color-outline);
        }

        .course-image {
            position: relative;
            overflow: hidden;
        }

        .course-image img {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }

        .course-duration {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .course-content {
            padding: 20px;
        }

        .course-content h4 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .course-content p {
            margin: 0 0 16px 0;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
            line-height: 1.4;
        }

        .course-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .course-progress {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .course-progress span {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            white-space: nowrap;
        }

        /* AI Tutor Styles */
        .ai-tutor-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .ai-tutor-header {
            display: flex;
            align-items: center;
            gap: 24px;
            padding: 32px;
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-large);
            margin-bottom: 32px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .ai-avatar {
            width: 80px;
            height: 80px;
            background: var(--md-sys-color-primary);
            border-radius: var(--md-sys-shape-corner-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-primary);
            font-size: 40px;
            flex-shrink: 0;
        }

        .ai-intro {
            flex: 1;
        }

        .ai-intro h2 {
            margin: 0 0 8px 0;
            font-family: var(--md-sys-typescale-headline-medium-font);
            font-size: var(--md-sys-typescale-headline-medium-size);
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .ai-intro p {
            margin: 0;
            color: var(--md-sys-color-on-surface-variant);
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--land-color-vegetation);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .ai-suggestions {
            margin-bottom: 32px;
        }

        .ai-suggestions h3 {
            margin: 0 0 20px 0;
            font-family: var(--md-sys-typescale-title-medium-font);
            font-size: var(--md-sys-typescale-title-medium-size);
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .suggestion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .suggestion-card {
            background: var(--md-sys-color-surface-container);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .suggestion-card:hover {
            background: var(--md-sys-color-surface-container-high);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .suggestion-card i {
            font-size: 24px;
            color: var(--md-sys-color-primary);
            margin-bottom: 12px;
        }

        .suggestion-card h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .suggestion-card p {
            margin: 0;
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .ai-chat {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-large);
            border: 1px solid var(--md-sys-color-outline-variant);
            overflow: hidden;
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 24px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 24px;
        }

        .message:last-child {
            margin-bottom: 0;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            background: var(--md-sys-color-primary);
            border-radius: var(--md-sys-shape-corner-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-primary);
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 16px 20px;
        }

        .message-content p {
            margin: 0 0 12px 0;
            color: var(--md-sys-color-on-surface);
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul {
            margin: 12px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin-bottom: 8px;
            color: var(--md-sys-color-on-surface);
        }

        .chat-input-area {
            padding: 24px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
            background: var(--md-sys-color-surface-container-low);
        }

        .chat-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 8px 16px;
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            background: none;
            font-family: var(--md-sys-typescale-body-medium-font);
            font-size: var(--md-sys-typescale-body-medium-size);
            color: var(--md-sys-color-on-surface);
        }

        .chat-input::placeholder {
            color: var(--md-sys-color-on-surface-variant);
        }

        .chat-attach-btn, .chat-voice-btn, .chat-send-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--md-sys-shape-corner-small);
            color: var(--md-sys-color-on-surface-variant);
            transition: all 0.2s;
        }

        .chat-attach-btn:hover, .chat-voice-btn:hover, .chat-send-btn:hover {
            background: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
        }

        /* Achievements Styles */
        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .achievements-header h2 {
            margin: 0;
            font-family: var(--md-sys-typescale-headline-medium-font);
            font-size: var(--md-sys-typescale-headline-medium-size);
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .achievement-stats {
            display: flex;
            gap: 32px;
        }

        .achievement-stat {
            text-align: center;
        }

        .stat-number {
            display: block;
            font-size: 32px;
            font-weight: 700;
            color: var(--md-sys-color-primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 4px;
        }

        .achievements-grid {
            display: grid;
            gap: 32px;
        }

        .achievement-category h3 {
            margin: 0 0 20px 0;
            font-family: var(--md-sys-typescale-title-medium-font);
            font-size: var(--md-sys-typescale-title-medium-size);
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .certificates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .certificate-card {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-large);
            border: 1px solid var(--md-sys-color-outline-variant);
            padding: 24px;
            text-align: center;
            transition: all 0.2s;
        }

        .certificate-card.earned {
            border-color: var(--land-color-vegetation);
            background: linear-gradient(135deg, var(--md-sys-color-surface-container) 0%, var(--md-sys-color-primary-container) 100%);
        }

        .certificate-card.in-progress {
            border-color: var(--land-color-crops);
        }

        .certificate-card.locked {
            opacity: 0.6;
            background: var(--md-sys-color-surface-container-low);
        }

        .certificate-card:hover:not(.locked) {
            box-shadow: var(--md-sys-elevation-level2);
            transform: translateY(-2px);
        }

        .certificate-icon {
            width: 64px;
            height: 64px;
            background: var(--md-sys-color-primary);
            border-radius: var(--md-sys-shape-corner-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-primary);
            font-size: 32px;
            margin: 0 auto 16px auto;
        }

        .certificate-card.earned .certificate-icon {
            background: var(--land-color-vegetation);
        }

        .certificate-card.in-progress .certificate-icon {
            background: var(--land-color-crops);
        }

        .certificate-card.locked .certificate-icon {
            background: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface-variant);
        }

        .certificate-card h4 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .certificate-card p {
            margin: 0 0 12px 0;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }

        .certificate-score {
            background: var(--land-color-vegetation);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            display: inline-block;
        }

        .certificate-progress {
            margin-top: 12px;
        }

        .certificate-requirements {
            color: var(--md-sys-color-on-surface-variant);
            font-size: 14px;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .badge {
            background: var(--md-sys-color-surface-container);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 20px;
            text-align: center;
            transition: all 0.2s;
        }

        .badge.earned {
            background: linear-gradient(135deg, var(--md-sys-color-primary-container) 0%, var(--land-color-vegetation) 100%);
            border-color: var(--land-color-vegetation);
            color: white;
        }

        .badge.in-progress {
            border-color: var(--land-color-crops);
        }

        .badge.locked {
            opacity: 0.6;
        }

        .badge:hover:not(.locked) {
            box-shadow: var(--md-sys-elevation-level1);
            transform: translateY(-2px);
        }

        .badge i {
            font-size: 32px;
            margin-bottom: 8px;
            display: block;
        }

        .badge span {
            font-size: 14px;
            font-weight: 500;
        }

        .leaderboard {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-large);
            border: 1px solid var(--md-sys-color-outline-variant);
            overflow: hidden;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-item.current-user {
            background: var(--md-sys-color-primary-container);
            font-weight: 600;
        }

        .rank {
            width: 32px;
            height: 32px;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-radius: var(--md-sys-shape-corner-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--md-sys-shape-corner-full);
            background: var(--md-sys-color-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .points {
            font-weight: 600;
            color: var(--md-sys-color-primary);
        }

        /* Help Center Styles */
        .help-header {
            margin-bottom: 32px;
        }

        .help-header h2 {
            margin: 0 0 20px 0;
            font-family: var(--md-sys-typescale-headline-medium-font);
            font-size: var(--md-sys-typescale-headline-medium-size);
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .help-search {
            max-width: 600px;
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--md-sys-color-surface-container);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 12px 16px;
        }

        .search-container i {
            color: var(--md-sys-color-on-surface-variant);
        }

        .search-container input {
            flex: 1;
            border: none;
            outline: none;
            background: none;
            font-family: var(--md-sys-typescale-body-medium-font);
            font-size: var(--md-sys-typescale-body-medium-size);
            color: var(--md-sys-color-on-surface);
        }

        .search-container input::placeholder {
            color: var(--md-sys-color-on-surface-variant);
        }

        .help-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }

        .help-category {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-large);
            border: 1px solid var(--md-sys-color-outline-variant);
            overflow: hidden;
        }

        .category-header {
            padding: 20px 24px;
            background: var(--md-sys-color-surface-container-high);
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-header h3 {
            margin: 0;
            font-family: var(--md-sys-typescale-title-medium-font);
            font-size: var(--md-sys-typescale-title-medium-size);
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .category-header i {
            color: var(--md-sys-color-primary);
        }

        .help-articles {
            padding: 16px 0;
        }

        .help-article {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            color: var(--md-sys-color-on-surface);
            text-decoration: none;
            transition: background 0.2s;
        }

        .help-article:hover {
            background: var(--md-sys-color-surface-container-highest);
        }

        .help-article i {
            color: var(--md-sys-color-on-surface-variant);
        }

        .video-tutorials {
            padding: 16px;
            display: grid;
            gap: 16px;
        }

        .video-card {
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-medium);
            overflow: hidden;
            transition: all 0.2s;
        }

        .video-card:hover {
            box-shadow: var(--md-sys-elevation-level1);
        }

        .video-thumbnail {
            position: relative;
        }

        .video-thumbnail img {
            width: 100%;
            height: 90px;
            object-fit: cover;
        }

        .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .video-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .video-card h4 {
            margin: 0 0 4px 0;
            padding: 12px 16px 0 16px;
            font-size: 16px;
            font-weight: 600;
            color: var(--md-sys-color-on-surface);
        }

        .video-card p {
            margin: 0;
            padding: 0 16px 12px 16px;
            font-size: 14px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .help-contact {
            margin-top: 40px;
            display: flex;
            justify-content: center;
        }

        .contact-card {
            background: var(--md-sys-color-primary-container);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 32px;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .contact-card i {
            font-size: 48px;
            color: var(--md-sys-color-primary);
            margin-bottom: 16px;
        }

        .contact-card h3 {
            margin: 0 0 12px 0;
            font-family: var(--md-sys-typescale-title-large-font);
            font-size: var(--md-sys-typescale-title-large-size);
            font-weight: 600;
            color: var(--md-sys-color-on-primary-container);
        }

        .contact-card p {
            margin: 0 0 24px 0;
            color: var(--md-sys-color-on-primary-container);
        }

        .contact-btn {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            padding: 12px 24px;
            border-radius: var(--md-sys-shape-corner-medium);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.2s;
            margin: 0 auto;
        }

        .contact-btn:hover {
            box-shadow: var(--md-sys-elevation-level2);
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: auto;
            flex-shrink: 0;
        }

        .header-actions button {
            background: none;
            border: none;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: var(--md-sys-shape-corner-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 20px;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            position: relative;
        }

        .header-actions button:hover {
            background-color: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
        }

        .header-actions button:active {
            background-color: var(--md-sys-color-surface-container-highest);
        }

        /* Material 3 Navigation Rail */
        .navigation-rail {
            width: 80px;
            flex-shrink: 0;
            background: var(--md-sys-color-surface-container);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 12px;
            gap: 24px;
            border-right: 1px solid var(--md-sys-color-outline-variant);
            z-index: 100;
            order: 1;
        }

        .nav-item {
            width: 56px;
            height: 56px;
            border-radius: var(--md-sys-shape-corner-large);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            color: var(--md-sys-color-on-surface-variant);
            text-decoration: none;
            gap: 4px;
            font-size: 24px;
        }

        .nav-item:hover {
            background-color: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
        }

        .nav-item.active {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .nav-item-label {
            font-family: var(--md-sys-typescale-label-large-font);
            font-size: 10px;
            font-weight: var(--md-sys-typescale-label-large-weight);
            margin-top: 4px;
            text-align: center;
            line-height: 1;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 64px);
            overflow: hidden;
            position: relative;
        }

        /* Plans Panel Sidebar */
        .sidebar {
            width: 280px;
            flex-shrink: 0;
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            transition: width 0.3s ease;
            order: 2;
            display: block !important;
            position: relative !important;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-weight: 600;
            font-size: 16px;
        }

        .sidebar.collapsed .sidebar-title {
            display: none;
        }

        .sidebar-item {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover {
            background: #f5f5f5;
        }

        .sidebar-item.active {
            background: #e8f5e9;
            border-left-color: #4CAF50;
        }

        .sidebar-item i {
            width: 20px;
            text-align: center;
            color: #666;
        }

        .sidebar-item.active i {
            color: #4CAF50;
        }

        .sidebar-item-text {
            flex: 1;
            font-size: 14px;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }

        .sidebar-item-text:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-item-text:focus {
            outline: 2px solid #4CAF50;
            background-color: white;
            color: #333;
        }

        .sidebar.collapsed .sidebar-item-text {
            display: none;
        }

        .sidebar-item-count {
            background: #e0e0e0;
            color: #666;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .sidebar.collapsed .sidebar-item-count {
            display: none;
        }

        /* Plan folder styles */
        .plan-chevron {
            margin-right: 8px;
            transition: transform 0.2s;
            cursor: pointer;
            color: #999;
        }

        .plan-chevron.expanded {
            transform: rotate(90deg);
        }

        .plan-features {
            display: none;
            margin-left: 20px;
            border-left: 1px solid #e0e0e0;
        }

        .plan-features.expanded {
            display: block;
        }

        .feature-item {
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            transition: background 0.2s;
            border-left: 2px solid transparent;
        }

        .feature-item:hover {
            background: #f9f9f9;
        }

        .feature-item.selected {
            background: #e3f2fd;
            border-left-color: #2196F3;
        }

        .feature-icon {
            width: 16px;
            text-align: center;
            color: #666;
        }

        .feature-name {
            flex: 1;
            font-size: 12px;
        }

        .feature-info {
            font-size: 11px;
            color: #999;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: var(--md-sys-color-surface-container);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            box-shadow: var(--md-sys-elevation-level3);
            padding: 8px 0;
            min-width: 120px;
            z-index: 2000;
            display: none;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: var(--md-sys-color-surface-container-high);
        }

        .context-menu-item i {
            width: 16px;
            color: #666;
        }

        /* Analysis Report Panel */
        .analysis-panel {
            position: fixed;
            top: 64px;
            right: -450px;
            width: 450px;
            height: calc(100vh - 64px);
            background: var(--md-sys-color-surface-container);
            box-shadow: var(--md-sys-elevation-level3);
            transition: right 0.3s cubic-bezier(0.2, 0.0, 0, 1.0);
            z-index: 1500;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--md-sys-color-outline-variant);
        }

        .analysis-panel.visible {
            right: 0;
        }

        .analysis-header {
            padding: 20px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            background: var(--md-sys-color-surface-container-high);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .analysis-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .analysis-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .analysis-close:hover {
            background: #e9ecef;
        }

        .analysis-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .analysis-section {
            padding: 20px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .analysis-section:last-child {
            border-bottom: none;
        }

        .analysis-header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .dashboard-toggle {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
        }

        .dashboard-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
            background: linear-gradient(135deg, #45a049, #3d8b40);
        }

        /* Dashboard Panel Styles */
        .dashboard-panel {
            position: fixed;
            top: 64px;
            right: -60%;
            bottom: 0;
            width: 60%;
            background: var(--md-sys-color-surface);
            z-index: 2000;
            overflow-y: auto;
            transition: right 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--md-sys-elevation-level4);
            border-left: 1px solid var(--md-sys-color-outline-variant);
        }

        .dashboard-panel.visible {
            right: 0;
        }

        /* Adjust layer controls when dashboard is open */
        .dashboard-panel.visible ~ .main-container .layer-controls {
            right: calc(60% + 20px);
        }

        /* Map controls now in fixed toolbar - no adjustment needed */

        .dashboard-header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(33, 150, 243, 0.3);
        }

        .dashboard-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dashboard-header-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .dashboard-minimize {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .dashboard-minimize:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .dashboard-close {
            background: rgba(244, 67, 54, 0.8);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .dashboard-close:hover {
            background: rgba(244, 67, 54, 1);
            transform: translateY(-1px);
        }

        .dashboard-content {
            padding: 30px;
            background: #f8f9fa;
            min-height: calc(100vh - 140px);
        }

        .dashboard-grid {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* KPI Cards */
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .kpi-card {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: var(--md-sys-elevation-level1);
            border: 1px solid var(--md-sys-color-outline-variant);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .kpi-card:hover {
            box-shadow: var(--md-sys-elevation-level2);
            background: var(--md-sys-color-surface-container-high);
        }

        .kpi-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            line-height: 1;
        }

        .kpi-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
            margin-top: 4px;
        }

        /* Charts */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-large);
            overflow: hidden;
            box-shadow: var(--md-sys-elevation-level1);
            border: 1px solid var(--md-sys-color-outline-variant);
            transition: box-shadow 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .chart-container:hover {
            box-shadow: var(--md-sys-elevation-level2);
        }

        .chart-header {
            background: var(--md-sys-color-surface-container-high);
            padding: 16px 20px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .chart-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-content {
            padding: 20px;
        }

        /* Tables */
        .tables-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }

        .table-container {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-large);
            overflow: hidden;
            box-shadow: var(--md-sys-elevation-level1);
            border: 1px solid var(--md-sys-color-outline-variant);
            transition: box-shadow 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .table-container:hover {
            box-shadow: var(--md-sys-elevation-level2);
        }

        .table-header {
            background: var(--md-sys-color-surface-container-high);
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .table-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e9ecef;
            font-size: 14px;
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-excellent { color: #28a745; font-weight: 600; }
        .status-good { color: #28a745; font-weight: 600; }
        .status-moderate { color: #ffc107; font-weight: 600; }
        .status-poor { color: #dc3545; font-weight: 600; }

        .rating-high { color: #28a745; font-weight: 600; }
        .rating-medium { color: #ffc107; font-weight: 600; }
        .rating-low { color: #dc3545; font-weight: 600; }

        /* Risk Assessment */
        .risk-section {
            width: 100%;
        }

        .risk-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            border: 1px solid #e9ecef;
        }

        .risk-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .risk-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .risk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .risk-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .risk-low { background: #d4edda; border-left-color: #28a745; }
        .risk-medium { background: #fff3cd; border-left-color: #ffc107; }
        .risk-high { background: #f8d7da; border-left-color: #dc3545; }

        .risk-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .risk-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .risk-value {
            font-weight: 700;
            font-size: 16px;
            margin: 2px 0;
        }

        .risk-desc {
            font-size: 12px;
            color: #666;
        }

        /* Actions */
        .actions-section {
            width: 100%;
        }

        .actions-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            border: 1px solid #e9ecef;
        }

        .actions-header {
            background: #f8f9fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .actions-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .actions-list {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .action-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 16px;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            align-items: center;
        }

        .action-priority {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-high { background: #f8d7da; color: #721c24; }
        .priority-medium { background: #fff3cd; color: #856404; }
        .priority-low { background: #d4edda; color: #155724; }

        .action-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .action-desc {
            color: #666;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .action-timeline {
            color: #888;
            font-size: 12px;
            font-style: italic;
        }

        .action-status {
            padding: 4px 12px;
            border-radius: 4px;
            background: #e9ecef;
            color: #495057;
            font-size: 12px;
            font-weight: 500;
        }

        .analysis-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-section-title i {
            color: #4CAF50;
        }

        .analysis-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .analysis-metric:last-child {
            border-bottom: none;
        }

        .analysis-metric-label {
            font-size: 14px;
            color: #666;
        }

        .analysis-metric-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .analysis-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666;
            flex-direction: column;
            gap: 12px;
        }

        .analysis-loading i {
            font-size: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            background: var(--md-sys-color-surface-dim);
            order: 3;
            min-width: 0;
            min-height: 0;
        }

        #map_div {
            width: 100%;
            height: 100% !important;
            position: absolute !important;
            top: 0;
            left: 0;
        }

        /* Layer Controls (Top Right) */
        .layer-controls {
            position: absolute;
            top: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
            transition: right 0.3s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        /* Map Controls styling moved to toolbar-container section above */

        /* Move layer controls when analysis panel is visible */
        .analysis-panel.visible ~ .main-container .layer-controls {
            right: 470px;
        }

        /* Map controls now in fixed toolbar - no adjustment needed */

        .map-control-button {
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            width: 44px;
            height: 44px;
            border-radius: var(--md-sys-shape-corner-medium);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--md-sys-color-on-surface);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .map-control-button:hover {
            background: var(--md-sys-color-surface-container-high);
            box-shadow: var(--md-sys-elevation-level2);
        }

        /* Material 3 Layer Dropdown */
        .layer-dropdown-container {
            position: relative;
        }

        .layer-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--md-sys-color-surface-container);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            box-shadow: var(--md-sys-elevation-level3);
            min-width: 200px;
            z-index: 1001;
            display: none;
            overflow: hidden;
        }

        .layer-dropdown.show {
            display: block;
        }

        .layer-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            cursor: pointer;
            transition: background-color 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            font-size: var(--md-sys-typescale-body-medium-size);
            color: var(--md-sys-color-on-surface);
        }

        .layer-option:last-child {
            border-bottom: none;
        }

        .layer-option:hover {
            background-color: var(--md-sys-color-surface-container-high);
        }

        .layer-option.active {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .layer-option i {
            width: 20px;
            font-size: 20px;
            text-align: center;
        }

        .layer-option span {
            font-weight: var(--md-sys-typescale-label-large-weight);
        }

        /* Overlay Dropdown Styles */
        .overlay-dropdown-container {
            position: relative;
        }

        .overlay-dropdown {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 280px;
            max-width: 320px;
            z-index: 1001;
            display: none;
            overflow: hidden;
            max-height: 80vh;
            overflow-y: auto;
        }

        .overlay-dropdown.show {
            display: block;
        }

        .overlay-section {
            border-bottom: 1px solid #f0f0f0;
        }

        .overlay-section:last-child {
            border-bottom: none;
        }

        .overlay-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            padding: 8px 16px 4px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .overlay-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .overlay-option:hover {
            background-color: #f5f5f5;
        }

        .overlay-option input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .overlay-option i {
            width: 16px;
            font-size: 14px;
            text-align: center;
            color: #666;
        }

        .overlay-option span {
            font-weight: 500;
            flex: 1;
        }

        .overlay-option.active {
            background-color: #e8f5e8;
        }

        .overlay-option.active i {
            color: #4CAF50;
        }

        /* Special styling for overlay layers */
        .roads-overlay {
            filter: hue-rotate(120deg) saturate(200%) contrast(150%);
        }

        /* Overlay Controls */
        .overlay-controls {
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .opacity-control {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .opacity-control label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .opacity-slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .opacity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .opacity-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .opacity-slider::-webkit-slider-track {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(to right, #ddd 0%, #4CAF50 100%);
        }

        .opacity-slider::-moz-range-track {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(to right, #ddd 0%, #4CAF50 100%);
            border: none;
        }

        /* Drawing Tools - Positioned on Map */
        .drawing-tools {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 8px 4px;
            box-shadow: var(--md-sys-elevation-level3);
            z-index: 1000;
        }

        /* Map Controls - Positioned on Map */
        .map-controls {
            position: absolute;
            bottom: 80px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 8px 4px;
            box-shadow: var(--md-sys-elevation-level3);
            z-index: 1000;
        }

        .drawing-tool {
            width: 48px;
            height: 48px;
            border: 1px solid var(--md-sys-color-outline-variant);
            background: var(--md-sys-color-surface);
            cursor: pointer;
            border-radius: var(--md-sys-shape-corner-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-surface);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            font-size: 20px;
        }

        .drawing-tool:hover {
            background: var(--md-sys-color-surface-container-high);
            box-shadow: var(--md-sys-elevation-level1);
            border-color: var(--md-sys-color-primary);
        }

        .drawing-tool.active {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-color: var(--md-sys-color-primary);
        }

        /* Material 3 Floating Action Buttons */
        .fab-container {
            position: absolute;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            z-index: 1000;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: var(--md-sys-shape-corner-large);
            border: none;
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--md-sys-elevation-level3);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .fab:hover {
            box-shadow: var(--md-sys-elevation-level4);
            transform: scale(1.05);
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab.secondary {
            background: var(--md-sys-color-secondary);
            color: var(--md-sys-color-on-secondary);
        }

        .fab.surface {
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
            box-shadow: var(--md-sys-elevation-level2);
        }

        .fab.surface:hover {
            box-shadow: var(--md-sys-elevation-level3);
        }

        /* Extended FAB for primary actions */
        .fab.extended {
            width: auto;
            padding: 0 24px;
            gap: 8px;
            font-family: var(--md-sys-typescale-label-large-font);
            font-size: var(--md-sys-typescale-label-large-size);
            font-weight: var(--md-sys-typescale-label-large-weight);
        }

        .fab.extended span {
            white-space: nowrap;
        }

        /* Real-time Monitoring Section */
        .realtime-section {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-extra-large);
            padding: 24px;
            box-shadow: var(--md-sys-elevation-level2);
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .realtime-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .realtime-header h4 {
            font-family: var(--md-sys-typescale-title-large-font);
            font-size: var(--md-sys-typescale-title-large-size);
            font-weight: var(--md-sys-typescale-title-large-weight);
            color: var(--md-sys-color-on-surface);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--md-sys-color-on-surface-variant);
            font-family: var(--md-sys-typescale-body-medium-font);
            font-size: var(--md-sys-typescale-body-medium-size);
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .monitoring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .monitor-card {
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 20px;
            border: 1px solid var(--md-sys-color-outline-variant);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .monitor-card:hover {
            box-shadow: var(--md-sys-elevation-level1);
            background: var(--md-sys-color-surface-container-highest);
        }

        .monitor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .monitor-card-title {
            font-family: var(--md-sys-typescale-title-medium-font);
            font-size: var(--md-sys-typescale-title-medium-size);
            font-weight: var(--md-sys-typescale-title-medium-weight);
            color: var(--md-sys-color-on-surface);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .monitor-card-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: var(--md-sys-shape-corner-full);
            font-size: 12px;
            font-weight: 500;
        }

        .monitor-card-status.active {
            background: var(--land-color-vegetation);
            color: white;
        }

        .monitor-card-status.warning {
            background: var(--land-color-warning);
            color: white;
        }

        .monitor-card-status.inactive {
            background: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface-variant);
        }

        .monitor-card-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .monitor-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .monitor-metric:last-child {
            border-bottom: none;
        }

        .monitor-metric-label {
            font-size: var(--md-sys-typescale-body-medium-size);
            color: var(--md-sys-color-on-surface-variant);
        }

        .monitor-metric-value {
            font-size: var(--md-sys-typescale-body-medium-size);
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .monitor-metric-value.good {
            color: var(--land-color-vegetation);
        }

        .monitor-metric-value.warning {
            color: var(--land-color-warning);
        }

        .satellite-card {
            background: linear-gradient(135deg, var(--md-sys-color-primary-container), var(--md-sys-color-surface-container-high));
        }

        .alerts-card {
            background: linear-gradient(135deg, var(--md-sys-color-secondary-container), var(--md-sys-color-surface-container-high));
        }

        .system-card {
            background: linear-gradient(135deg, var(--md-sys-color-tertiary-container), var(--md-sys-color-surface-container-high));
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--md-sys-color-outline-variant);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--land-color-vegetation);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Profile and Settings Section */
        .profile-section {
            display: none;
            padding: 40px;
            background: var(--md-sys-color-surface);
            max-width: 1200px;
            margin: 0 auto;
        }

        .profile-section.active {
            display: block;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-bottom: 40px;
            padding: 32px;
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-extra-large);
            box-shadow: var(--md-sys-elevation-level1);
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: var(--md-sys-shape-corner-full);
            background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-primary);
            font-size: 48px;
            box-shadow: var(--md-sys-elevation-level2);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-family: var(--md-sys-typescale-headline-large-font);
            font-size: var(--md-sys-typescale-headline-large-size);
            font-weight: var(--md-sys-typescale-headline-large-weight);
            color: var(--md-sys-color-on-surface);
            margin: 0 0 8px 0;
        }

        .profile-role {
            font-family: var(--md-sys-typescale-title-medium-font);
            font-size: var(--md-sys-typescale-title-medium-size);
            color: var(--md-sys-color-on-surface-variant);
            margin: 0 0 16px 0;
        }

        .profile-stats {
            display: flex;
            gap: 24px;
            margin-top: 16px;
        }

        .profile-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .profile-stat-value {
            font-family: var(--md-sys-typescale-title-large-font);
            font-size: var(--md-sys-typescale-title-large-size);
            font-weight: var(--md-sys-typescale-title-large-weight);
            color: var(--md-sys-color-primary);
        }

        .profile-stat-label {
            font-size: var(--md-sys-typescale-body-medium-size);
            color: var(--md-sys-color-on-surface-variant);
        }

        .profile-actions {
            display: flex;
            gap: 12px;
        }

        .profile-button {
            padding: 12px 24px;
            border-radius: var(--md-sys-shape-corner-full);
            border: 1px solid var(--md-sys-color-outline);
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            font-family: var(--md-sys-typescale-label-large-font);
            font-size: var(--md-sys-typescale-label-large-size);
            font-weight: var(--md-sys-typescale-label-large-weight);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-button:hover {
            background: var(--md-sys-color-surface-container-high);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .profile-button.primary {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-color: var(--md-sys-color-primary);
        }

        .profile-button.primary:hover {
            box-shadow: var(--md-sys-elevation-level2);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }

        .settings-card {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-extra-large);
            padding: 24px;
            box-shadow: var(--md-sys-elevation-level1);
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .settings-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .settings-card-title {
            font-family: var(--md-sys-typescale-title-large-font);
            font-size: var(--md-sys-typescale-title-large-size);
            font-weight: var(--md-sys-typescale-title-large-weight);
            color: var(--md-sys-color-on-surface);
            margin: 0;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-info {
            flex: 1;
        }

        .settings-item-title {
            font-family: var(--md-sys-typescale-body-large-font);
            font-size: var(--md-sys-typescale-body-large-size);
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin: 0 0 4px 0;
        }

        .settings-item-description {
            font-size: var(--md-sys-typescale-body-medium-size);
            color: var(--md-sys-color-on-surface-variant);
            margin: 0;
        }

        .settings-toggle {
            position: relative;
            width: 52px;
            height: 32px;
            background: var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-full);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .settings-toggle.active {
            background: var(--md-sys-color-primary);
        }

        .settings-toggle-handle {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 28px;
            height: 28px;
            background: white;
            border-radius: var(--md-sys-shape-corner-full);
            transition: transform 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .settings-toggle.active .settings-toggle-handle {
            transform: translateX(20px);
        }

        .settings-select {
            padding: 8px 16px;
            border-radius: var(--md-sys-shape-corner-small);
            border: 1px solid var(--md-sys-color-outline);
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-family: var(--md-sys-typescale-body-medium-font);
            font-size: var(--md-sys-typescale-body-medium-size);
            min-width: 120px;
        }

        .settings-select:focus {
            outline: 2px solid var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
        }

        /* Collaboration System */
        .collaboration-panel {
            position: fixed;
            top: 64px;
            right: -400px;
            width: 400px;
            height: calc(100vh - 64px);
            background: var(--md-sys-color-surface-container);
            box-shadow: var(--md-sys-elevation-level3);
            transition: right 0.3s cubic-bezier(0.2, 0.0, 0, 1.0);
            z-index: 1600;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--md-sys-color-outline-variant);
        }

        .collaboration-panel.visible {
            right: 0;
        }

        .collaboration-header {
            padding: 20px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            background: var(--md-sys-color-surface-container-high);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collaboration-title {
            font-family: var(--md-sys-typescale-title-large-font);
            font-size: var(--md-sys-typescale-title-large-size);
            font-weight: var(--md-sys-typescale-title-large-weight);
            color: var(--md-sys-color-on-surface);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .collaboration-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .collaboration-section {
            padding: 20px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .collaboration-section:last-child {
            border-bottom: none;
        }

        .collaboration-section-title {
            font-family: var(--md-sys-typescale-title-medium-font);
            font-size: var(--md-sys-typescale-title-medium-size);
            font-weight: var(--md-sys-typescale-title-medium-weight);
            color: var(--md-sys-color-on-surface);
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .share-button {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            padding: 12px 24px;
            border-radius: var(--md-sys-shape-corner-full);
            cursor: pointer;
            font-family: var(--md-sys-typescale-label-large-font);
            font-size: var(--md-sys-typescale-label-large-size);
            font-weight: var(--md-sys-typescale-label-large-weight);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            width: 100%;
            justify-content: center;
            margin-bottom: 16px;
            box-shadow: var(--md-sys-elevation-level1);
        }

        .share-button:hover {
            box-shadow: var(--md-sys-elevation-level2);
        }

        .collaborator-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .collaborator-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: var(--md-sys-shape-corner-medium);
            background: var(--md-sys-color-surface-container-high);
            transition: background-color 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .collaborator-item:hover {
            background: var(--md-sys-color-surface-container-highest);
        }

        .collaborator-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--md-sys-shape-corner-full);
            background: var(--md-sys-color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-primary);
            font-weight: 500;
            font-size: 14px;
            position: relative;
        }

        .collaborator-status {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--md-sys-color-surface-container-high);
        }

        .collaborator-status.online {
            background: var(--land-color-vegetation);
        }

        .collaborator-status.away {
            background: var(--land-color-warning);
        }

        .collaborator-status.offline {
            background: var(--md-sys-color-outline);
        }

        .collaborator-info {
            flex: 1;
        }

        .collaborator-name {
            font-family: var(--md-sys-typescale-body-medium-font);
            font-size: var(--md-sys-typescale-body-medium-size);
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin: 0 0 2px 0;
        }

        .collaborator-role {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            margin: 0;
        }

        .collaborator-actions {
            display: flex;
            gap: 4px;
        }

        .collaborator-action {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: var(--md-sys-shape-corner-small);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-surface-variant);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .collaborator-action:hover {
            background: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface);
        }

        .permission-badge {
            padding: 4px 8px;
            border-radius: var(--md-sys-shape-corner-small);
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .permission-badge.owner {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .permission-badge.editor {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .permission-badge.viewer {
            background: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface-variant);
        }

        .recent-activity {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--md-sys-shape-corner-small);
            background: var(--md-sys-color-surface-container-highest);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 16px;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: var(--md-sys-typescale-body-medium-size);
            color: var(--md-sys-color-on-surface);
            margin: 0 0 2px 0;
        }

        .activity-time {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            margin: 0;
        }

        .share-link-container {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 12px;
        }

        .share-link-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-small);
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-family: var(--md-sys-typescale-body-medium-font);
            font-size: var(--md-sys-typescale-body-medium-size);
        }

        .share-link-input:focus {
            outline: 2px solid var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
        }

        .copy-button {
            padding: 12px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-small);
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .copy-button:hover {
            background: var(--md-sys-color-surface-container-high);
        }

        .comments-section {
            border-top: 1px solid var(--md-sys-color-outline-variant);
            margin-top: 16px;
            padding-top: 16px;
        }

        .comment-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .comment-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-medium);
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-family: var(--md-sys-typescale-body-medium-font);
            font-size: var(--md-sys-typescale-body-medium-size);
            resize: vertical;
            min-height: 60px;
        }

        .comment-input:focus {
            outline: 2px solid var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
        }

        .comment-send {
            padding: 12px;
            border: none;
            border-radius: var(--md-sys-shape-corner-medium);
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            cursor: pointer;
            align-self: flex-end;
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .comment-item {
            display: flex;
            gap: 12px;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--md-sys-shape-corner-full);
            background: var(--md-sys-color-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-secondary);
            font-size: 12px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 12px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .comment-author {
            font-size: var(--md-sys-typescale-body-medium-size);
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .comment-time {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .comment-text {
            font-size: var(--md-sys-typescale-body-medium-size);
            color: var(--md-sys-color-on-surface);
            margin: 0;
        }

        /* AI Assistant Integration */
        .ai-section {
            background: linear-gradient(135deg, var(--md-sys-color-primary-container), var(--md-sys-color-surface-container));
            border-radius: var(--md-sys-shape-corner-extra-large);
            padding: 24px;
            box-shadow: var(--md-sys-elevation-level2);
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .ai-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .ai-header h4 {
            font-family: var(--md-sys-typescale-title-large-font);
            font-size: var(--md-sys-typescale-title-large-size);
            font-weight: var(--md-sys-typescale-title-large-weight);
            color: var(--md-sys-color-on-surface);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--land-color-vegetation);
            color: white;
            border-radius: var(--md-sys-shape-corner-full);
            font-size: 12px;
            font-weight: 500;
        }

        .ai-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            height: 400px;
        }

        .ai-chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-large);
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .ai-message {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .ai-message:last-child {
            margin-bottom: 0;
        }

        .ai-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--md-sys-shape-corner-full);
            background: var(--md-sys-color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--md-sys-color-on-primary);
            flex-shrink: 0;
        }

        .ai-message.user .ai-avatar {
            background: var(--md-sys-color-secondary);
            color: var(--md-sys-color-on-secondary);
        }

        .ai-message-content {
            flex: 1;
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 12px 16px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .ai-message.user .ai-message-content {
            background: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .ai-message-content p {
            margin: 0 0 8px 0;
            font-size: var(--md-sys-typescale-body-medium-size);
            color: var(--md-sys-color-on-surface);
        }

        .ai-message-content p:last-child {
            margin-bottom: 0;
        }

        .ai-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .suggestion-chip {
            padding: 8px 16px;
            background: var(--md-sys-color-surface-container-highest);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-full);
            font-size: 13px;
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .suggestion-chip:hover {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .ai-thinking {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--md-sys-color-on-surface-variant);
            font-style: italic;
            padding: 8px 0;
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--md-sys-color-on-surface-variant);
            animation: thinking 1.4s ease-in-out infinite both;
        }

        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        .thinking-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes thinking {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .ai-input-area {
            display: flex;
            gap: 8px;
            padding: 16px;
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-large);
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .ai-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-medium);
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-family: var(--md-sys-typescale-body-medium-font);
            font-size: var(--md-sys-typescale-body-medium-size);
            resize: none;
            min-height: 44px;
        }

        .ai-input:focus {
            outline: 2px solid var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
        }

        .ai-input-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .ai-action-button {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: var(--md-sys-shape-corner-medium);
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .ai-action-button:hover {
            box-shadow: var(--md-sys-elevation-level2);
        }

        .ai-action-button.secondary {
            background: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
        }

        .ai-insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .ai-insight-card {
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 16px;
            border: 1px solid var(--md-sys-color-outline-variant);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .ai-insight-card:hover {
            box-shadow: var(--md-sys-elevation-level1);
            background: var(--md-sys-color-surface-container-highest);
        }

        .ai-insight-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .ai-insight-icon {
            color: var(--md-sys-color-primary);
            font-size: 18px;
        }

        .ai-insight-title {
            font-family: var(--md-sys-typescale-title-small-font);
            font-size: var(--md-sys-typescale-title-small-size);
            font-weight: var(--md-sys-typescale-title-small-weight);
            color: var(--md-sys-color-on-surface);
            margin: 0;
        }

        .ai-insight-content {
            font-size: var(--md-sys-typescale-body-small-size);
            color: var(--md-sys-color-on-surface-variant);
            margin: 0;
        }

        /* Funding Opportunities Section */
        .funding-section {
            background: var(--md-sys-color-surface);
            border-radius: var(--md-sys-shape-corner-extra-large);
            padding: 32px;
            margin-top: 24px;
        }

        .funding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }

        .funding-title {
            font-family: var(--md-sys-typescale-headline-medium-font);
            font-size: var(--md-sys-typescale-headline-medium-size);
            font-weight: var(--md-sys-typescale-headline-medium-weight);
            color: var(--md-sys-color-on-surface);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .funding-stats {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .funding-stat {
            text-align: center;
        }

        .funding-stat-value {
            font-family: var(--md-sys-typescale-title-large-font);
            font-size: var(--md-sys-typescale-title-large-size);
            font-weight: var(--md-sys-typescale-title-large-weight);
            color: var(--md-sys-color-primary);
            margin: 0;
        }

        .funding-stat-label {
            font-size: var(--md-sys-typescale-body-small-size);
            color: var(--md-sys-color-on-surface-variant);
            margin: 0;
        }

        .funding-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .funding-search {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .funding-search-input {
            width: 100%;
            padding: 16px 20px 16px 48px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-medium);
            background: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
            font-family: var(--md-sys-typescale-body-large-font);
            font-size: var(--md-sys-typescale-body-large-size);
        }

        .funding-search-input:focus {
            outline: 2px solid var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
        }

        .funding-search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--md-sys-color-on-surface-variant);
            pointer-events: none;
        }

        .funding-filter-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .funding-filter-chip {
            padding: 8px 16px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-full);
            background: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            font-size: var(--md-sys-typescale-label-large-size);
            font-weight: var(--md-sys-typescale-label-large-weight);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .funding-filter-chip:hover {
            background: var(--md-sys-color-surface-container-high);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .funding-filter-chip.active {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-color: var(--md-sys-color-primary);
        }

        .funding-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 24px;
        }

        .funding-card {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 24px;
            box-shadow: var(--md-sys-elevation-level1);
            border: 1px solid var(--md-sys-color-outline-variant);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            position: relative;
            overflow: hidden;
        }

        .funding-card:hover {
            box-shadow: var(--md-sys-elevation-level3);
            transform: translateY(-2px);
        }

        .funding-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 16px;
        }

        .funding-card-title {
            font-family: var(--md-sys-typescale-title-medium-font);
            font-size: var(--md-sys-typescale-title-medium-size);
            font-weight: var(--md-sys-typescale-title-medium-weight);
            color: var(--md-sys-color-on-surface);
            margin: 0 0 8px 0;
            line-height: 1.3;
        }

        .funding-card-provider {
            font-size: var(--md-sys-typescale-body-medium-size);
            color: var(--md-sys-color-primary);
            margin: 0;
            font-weight: 500;
        }

        .funding-amount {
            text-align: right;
            flex-shrink: 0;
        }

        .funding-amount-value {
            font-family: var(--md-sys-typescale-title-large-font);
            font-size: var(--md-sys-typescale-title-large-size);
            font-weight: var(--md-sys-typescale-title-large-weight);
            color: var(--land-color-vegetation);
            margin: 0;
            line-height: 1;
        }

        .funding-amount-currency {
            font-size: var(--md-sys-typescale-body-small-size);
            color: var(--md-sys-color-on-surface-variant);
            margin: 0;
        }

        .funding-card-description {
            font-size: var(--md-sys-typescale-body-medium-size);
            color: var(--md-sys-color-on-surface-variant);
            margin: 0 0 16px 0;
            line-height: 1.4;
        }

        .funding-card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 16px 0;
        }

        .funding-tag {
            padding: 4px 8px;
            background: var(--md-sys-color-surface-container-highest);
            color: var(--md-sys-color-on-surface-variant);
            border-radius: var(--md-sys-shape-corner-small);
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .funding-tag.priority {
            background: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }

        .funding-tag.deadline-soon {
            background: var(--land-color-warning);
            color: white;
        }

        .funding-card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
        }

        .funding-detail {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .funding-detail-label {
            font-size: var(--md-sys-typescale-body-small-size);
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .funding-detail-value {
            font-size: var(--md-sys-typescale-body-medium-size);
            color: var(--md-sys-color-on-surface);
            font-weight: 500;
        }

        .funding-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .funding-action-button {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: var(--md-sys-shape-corner-medium);
            cursor: pointer;
            font-family: var(--md-sys-typescale-label-large-font);
            font-size: var(--md-sys-typescale-label-large-size);
            font-weight: var(--md-sys-typescale-label-large-weight);
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .funding-action-button.primary {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .funding-action-button.primary:hover {
            box-shadow: var(--md-sys-elevation-level2);
        }

        .funding-action-button.secondary {
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
            border: 1px solid var(--md-sys-color-outline);
        }

        .funding-action-button.secondary:hover {
            background: var(--md-sys-color-surface-container-highest);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .funding-match-score {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            border-radius: var(--md-sys-shape-corner-full);
            background: var(--land-color-vegetation);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            box-shadow: var(--md-sys-elevation-level2);
        }

        .funding-ai-assistant {
            background: linear-gradient(135deg, var(--md-sys-color-tertiary-container), var(--md-sys-color-surface-container));
            border-radius: var(--md-sys-shape-corner-large);
            padding: 24px;
            margin-top: 32px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .funding-ai-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .funding-ai-title {
            font-family: var(--md-sys-typescale-title-medium-font);
            font-size: var(--md-sys-typescale-title-medium-size);
            font-weight: var(--md-sys-typescale-title-medium-weight);
            color: var(--md-sys-color-on-surface);
            margin: 0;
        }

        .funding-ai-suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .funding-ai-suggestion {
            background: var(--md-sys-color-surface-container-high);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 16px;
            border: 1px solid var(--md-sys-color-outline-variant);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .funding-ai-suggestion:hover {
            background: var(--md-sys-color-surface-container-highest);
            box-shadow: var(--md-sys-elevation-level1);
        }

        .funding-ai-suggestion-title {
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
            margin: 0 0 6px 0;
        }

        .funding-ai-suggestion-text {
            font-size: var(--md-sys-typescale-body-small-size);
            color: var(--md-sys-color-on-surface-variant);
            margin: 0;
        }

        /* Info Panel */
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 384px; /* Navigation rail (80px) + Sidebar (280px) + padding (24px) */
            right: 20px;
            background: var(--md-sys-color-surface-container);
            border-radius: var(--md-sys-shape-corner-large);
            box-shadow: var(--md-sys-elevation-level3);
            padding: 20px;
            display: none;
            z-index: 1000;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .sidebar.collapsed ~ .map-container .info-panel {
            left: 164px; /* Navigation rail (80px) + Collapsed sidebar (60px) + padding (24px) */
        }

        .info-panel.visible {
            display: block;
        }

        .info-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .info-panel-title {
            font-size: 18px;
            font-weight: 600;
        }

        .info-panel-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .info-panel-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .info-value {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        .info-unit {
            font-size: 14px;
            font-weight: 400;
            color: #666;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.visible {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        /* Sharing Settings */
        .share-link {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 20px;
            word-break: break-all;
        }

        .collaborator-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .collaborator-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }

        .collaborator-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #4CAF50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .collaborator-info {
            flex: 1;
        }

        .collaborator-name {
            font-weight: 500;
            font-size: 14px;
        }

        .collaborator-email {
            font-size: 12px;
            color: #666;
        }

        .collaborator-role {
            padding: 4px 8px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .collaborator-remove {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 18px;
        }

        /* Report Panel */
        .report-panel {
            position: fixed;
            top: 60px;
            right: -400px;
            width: 400px;
            height: calc(100vh - 60px);
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1500;
            display: flex;
            flex-direction: column;
        }

        .report-panel.visible {
            right: 0;
        }

        .report-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .report-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .metric-card {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .metric-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 600;
            color: #4CAF50;
        }

        .metric-subtitle {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .sidebar {
                position: absolute !important;
                z-index: 1001;
                height: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                order: 2 !important;
            }

            .sidebar.mobile-visible {
                transform: translateX(0);
            }

            .drawing-tools {
                left: 20px;
            }

            .info-panel {
                left: 20px;
            }

            .report-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="back-to-dashboard">
            <button class="dashboard-back-btn" onclick="goBackToDashboard()">
                <i class="material-symbols-rounded">arrow_back</i>
                <span>Dashboard</span>
            </button>
        </div>
        <div class="header-title" contenteditable="true" id="headerTitle">
            Awesome Test Map
        </div>
        <div class="header-actions">
            <button id="searchBtn" title="Search">
                <i class="fas fa-search"></i>
                <span class="mat-mdc-button-touch-target"></span>
            </button>
            <button id="layersBtn" title="Layers">
                <i class="fas fa-layer-group"></i>
                <span class="mat-mdc-button-touch-target"></span>
            </button>
            <button id="downloadBtn" title="Download">
                <i class="fas fa-download"></i>
                <span class="mat-mdc-button-touch-target"></span>
            </button>
            <button id="shareBtn" title="Share">
                <i class="fas fa-share-alt"></i>
                <span class="mat-mdc-button-touch-target"></span>
            </button>
            <button id="learningBtn" title="Learning Center">
                <i class="fas fa-graduation-cap"></i>
                <span class="mat-mdc-button-touch-target"></span>
            </button>
            <button id="settingsBtn" title="Settings">
                <i class="fas fa-cog"></i>
                <span class="mat-mdc-button-touch-target"></span>
            </button>
            <button id="userBtn" title="User">
                <i class="fas fa-user-circle"></i>
                <span class="mat-mdc-button-touch-target"></span>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Material 3 Navigation Rail -->
        <nav class="navigation-rail">
            <div class="nav-item active" data-section="map">
                <i class="material-symbols-rounded">map</i>
                <span class="nav-item-label">Map</span>
            </div>
            <div class="nav-item" data-section="analytics">
                <i class="material-symbols-rounded">analytics</i>
                <span class="nav-item-label">Analytics</span>
            </div>
            <div class="nav-item" data-section="satellite">
                <i class="material-symbols-rounded">satellite</i>
                <span class="nav-item-label">Satellite</span>
            </div>
            <div class="nav-item" data-section="agriculture">
                <i class="material-symbols-rounded">agriculture</i>
                <span class="nav-item-label">Crops</span>
            </div>
            <div class="nav-item" data-section="water">
                <i class="material-symbols-rounded">water_drop</i>
                <span class="nav-item-label">Water</span>
            </div>
            <div class="nav-item" data-section="osm">
                <i class="material-symbols-rounded">location_on</i>
                <span class="nav-item-label">OSM</span>
            </div>
            <div class="nav-item" data-section="climate">
                <i class="material-symbols-rounded">thermostat</i>
                <span class="nav-item-label">Climate</span>
            </div>
            <div class="nav-item" data-section="field">
                <i class="material-symbols-rounded">smartphone</i>
                <span class="nav-item-label">Field</span>
            </div>
            <div class="nav-item" data-section="funding">
                <i class="material-symbols-rounded">monetization_on</i>
                <span class="nav-item-label">Funding</span>
            </div>
            <!-- Profile at bottom -->
            <div style="margin-top: auto;"></div>
            <div class="nav-item" data-section="profile" id="profileNavItem">
                <i class="material-symbols-rounded">account_circle</i>
                <span class="nav-item-label">Profile</span>
            </div>
        </nav>

        <!-- Plans Panel -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">Plans</span>
                <button id="newPlanBtn" style="background: none; border: none; cursor: pointer;">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div class="plan-container" data-plan-id="plan-1">
                <div class="sidebar-item active">
                    <i class="fas fa-chevron-right plan-chevron"></i>
                    <i class="fas fa-border-all"></i>
                    <span class="sidebar-item-text" contenteditable="true" id="planName">Boundary</span>
                    <span class="sidebar-item-count">0</span>
                </div>
                <div class="plan-features">
                    <!-- Features will be dynamically added here -->
                </div>
            </div>
        </aside>


        <!-- Map Container -->
        <div class="map-container">
            <!-- Drawing Tools (Top Left of Map) -->
            <div class="drawing-tools">
                <button class="drawing-tool" id="drawPoint" title="Draw Point">
                    <i class="material-symbols-rounded">location_on</i>
                </button>
                <button class="drawing-tool" id="drawPolygon" title="Draw Polygon">
                    <i class="material-symbols-rounded">polyline</i>
                </button>
                <button class="drawing-tool" id="drawRectangle" title="Draw Rectangle">
                    <i class="material-symbols-rounded">crop_square</i>
                </button>
                <button class="drawing-tool" id="drawCircle" title="Draw Circle">
                    <i class="material-symbols-rounded">circle</i>
                </button>
                <button class="drawing-tool" id="measureTool" title="Measure">
                    <i class="material-symbols-rounded">straighten</i>
                </button>
                <button class="drawing-tool" id="deleteTool" title="Delete">
                    <i class="material-symbols-rounded">delete</i>
                </button>
            </div>

            <!-- Map Controls (Bottom Left of Map) -->
            <div class="map-controls">
                <button class="map-control-button" id="zoomInBtn">
                    <i class="material-symbols-rounded">add</i>
                </button>
                <button class="map-control-button" id="zoomOutBtn">
                    <i class="material-symbols-rounded">remove</i>
                </button>
                <button class="map-control-button" id="locateBtn">
                    <i class="material-symbols-rounded">my_location</i>
                </button>
                <button class="map-control-button" id="fullscreenBtn">
                    <i class="material-symbols-rounded">fullscreen</i>
                </button>
            </div>

            <!-- Layer Controls (Top Right) -->
            <div class="layer-controls">
                <div class="layer-dropdown-container">
                    <button class="map-control-button" id="layersMapBtn" title="Select Base Layer">
                        <i class="material-symbols-rounded">map</i>
                    </button>
                    <div class="layer-dropdown" id="layerDropdown">
                        <div class="layer-option" data-layer="osm">
                            <i class="material-symbols-rounded">map</i>
                            <span>OpenStreetMap</span>
                        </div>
                        <div class="layer-option" data-layer="satellite">
                            <i class="material-symbols-rounded">satellite</i>
                            <span>Aerial Imagery</span>
                        </div>
                        <div class="layer-option" data-layer="sentinel2">
                            <i class="material-symbols-rounded">satellite_alt</i>
                            <span>Sentinel-2 Imagery</span>
                        </div>
                        <div class="layer-option" data-layer="ndvi">
                            <i class="material-symbols-rounded">eco</i>
                            <span>Sentinel-2 NDVI</span>
                        </div>
                    </div>
                </div>
                <div class="overlay-dropdown-container">
                    <button class="map-control-button" id="overlaysBtn" title="Data Overlays">
                        <i class="material-symbols-rounded">layers</i>
                    </button>
                    <div class="overlay-dropdown" id="overlayDropdown">
                        <div class="overlay-controls">
                            <div class="opacity-control">
                                <label for="overlayOpacity">Overlay Opacity: <span id="opacityValue">70%</span></label>
                                <input type="range" id="overlayOpacity" min="0" max="100" value="70" class="opacity-slider">
                            </div>
                        </div>
                        <div class="overlay-section">
                            <div class="overlay-section-title">Climate & Weather</div>
                            <div class="overlay-option" data-overlay="precipitation" data-category="climate">
                                <input type="checkbox" id="precipitation-check">
                                <i class="material-symbols-rounded">rainy</i>
                                <span>Global Precipitation</span>
                            </div>
                            <div class="overlay-option" data-overlay="temperature" data-category="climate">
                                <input type="checkbox" id="temperature-check">
                                <i class="fas fa-thermometer-half"></i>
                                <span>Land Surface Temperature</span>
                            </div>
                            <div class="overlay-option" data-overlay="wind" data-category="climate">
                                <input type="checkbox" id="wind-check">
                                <i class="fas fa-wind"></i>
                                <span>Wind Patterns</span>
                            </div>
                        </div>
                        <div class="overlay-section">
                            <div class="overlay-section-title">Vegetation & Agriculture</div>
                            <div class="overlay-option" data-overlay="ndvi" data-category="vegetation">
                                <input type="checkbox" id="ndvi-check">
                                <i class="fas fa-leaf"></i>
                                <span>NDVI Vegetation</span>
                            </div>
                            <div class="overlay-option" data-overlay="cropland" data-category="vegetation">
                                <input type="checkbox" id="cropland-check">
                                <i class="fas fa-seedling"></i>
                                <span>Global Cropland</span>
                            </div>
                            <div class="overlay-option" data-overlay="forest" data-category="vegetation">
                                <input type="checkbox" id="forest-check">
                                <i class="fas fa-tree"></i>
                                <span>Forest Cover</span>
                            </div>
                        </div>
                        <div class="overlay-section">
                            <div class="overlay-section-title">Water Resources</div>
                            <div class="overlay-option" data-overlay="surface-water" data-category="water">
                                <input type="checkbox" id="surface-water-check">
                                <i class="fas fa-water"></i>
                                <span>Surface Water</span>
                            </div>
                            <div class="overlay-option" data-overlay="flood-risk" data-category="water">
                                <input type="checkbox" id="flood-risk-check">
                                <i class="fas fa-house-flood-water"></i>
                                <span>Flood Risk</span>
                            </div>
                        </div>
                        <div class="overlay-section">
                            <div class="overlay-section-title">Environmental</div>
                            <div class="overlay-option" data-overlay="air-quality" data-category="environment">
                                <input type="checkbox" id="air-quality-check">
                                <i class="fas fa-smog"></i>
                                <span>Air Quality (NO2)</span>
                            </div>
                            <div class="overlay-option" data-overlay="fires" data-category="environment">
                                <input type="checkbox" id="fires-check">
                                <i class="fas fa-fire"></i>
                                <span>Active Fires</span>
                            </div>
                            <div class="overlay-option" data-overlay="lights" data-category="environment">
                                <input type="checkbox" id="lights-check">
                                <i class="fas fa-lightbulb"></i>
                                <span>Nighttime Lights</span>
                            </div>
                        </div>
                        <div class="overlay-section">
                            <div class="overlay-section-title">Terrain & Land Use</div>
                            <div class="overlay-option" data-overlay="elevation" data-category="terrain">
                                <input type="checkbox" id="elevation-check">
                                <i class="fas fa-mountain"></i>
                                <span>Elevation (DEM)</span>
                            </div>
                            <div class="overlay-option" data-overlay="slope" data-category="terrain">
                                <input type="checkbox" id="slope-check">
                                <i class="fas fa-angle-up"></i>
                                <span>Slope Analysis</span>
                            </div>
                            <div class="overlay-option" data-overlay="landcover" data-category="terrain">
                                <input type="checkbox" id="landcover-check">
                                <i class="fas fa-globe"></i>
                                <span>Global Land Cover</span>
                            </div>
                        </div>
                        <div class="overlay-section">
                            <div class="overlay-section-title">Population & Infrastructure</div>
                            <div class="overlay-option" data-overlay="population" data-category="human">
                                <input type="checkbox" id="population-check">
                                <i class="fas fa-users"></i>
                                <span>Population Density</span>
                            </div>
                            <div class="overlay-option" data-overlay="roads" data-category="human">
                                <input type="checkbox" id="roads-check">
                                <i class="fas fa-road"></i>
                                <span>Road Networks</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div id="map_div" style="outline: none;" class="leaflet-container leaflet-touch leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom" tabindex="0">
                <div class="leaflet-pane leaflet-map-pane" style="transform: translate3d(-274px, -18px, 0px);">
                    <div class="leaflet-pane leaflet-tile-pane">
                        <div class="leaflet-layer" style="z-index: 1; opacity: 1;">
                            <div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 18; transform: translate3d(0px, 0px, 0px) scale(1);">
                                <!-- Tile images would be loaded here dynamically -->
                            </div>
                        </div>
                    </div>
                    <div class="leaflet-pane leaflet-overlay-pane">
                        <svg pointer-events="none" class="leaflet-zoom-animated" width="2106" height="720" viewBox="99 -42 2106 720" style="transform: translate3d(99px, -42px, 0px);">
                            <g>
                                <!-- Dynamic overlay content will be added here -->
                            </g>
                        </svg>
                    </div>
                    <div class="leaflet-pane leaflet-shadow-pane"></div>
                    <div class="leaflet-pane leaflet-marker-pane"></div>
                    <div class="leaflet-pane leaflet-tooltip-pane"></div>
                    <div class="leaflet-pane leaflet-popup-pane"></div>
                    <div class="leaflet-proxy leaflet-zoom-animated" style="transform: translate3d(4.1809e+06px, 2.80141e+06px, 0px) scale(16384);"></div>
                </div>
                <div class="leaflet-control-container">
                    <div class="leaflet-top leaflet-left"></div>
                    <div class="leaflet-top leaflet-right"></div>
                    <div class="leaflet-bottom leaflet-left"></div>
                    <div class="leaflet-bottom leaflet-right">
                        <div class="leaflet-control-attribution leaflet-control">
                            <a href="https://leafletjs.com" title="A JavaScript library for interactive maps">
                                <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="12" height="8" viewBox="0 0 12 8" class="leaflet-attribution-flag">
                                    <path fill="#4C7BE1" d="M0 0h12v4H0z"></path>
                                    <path fill="#FFD500" d="M0 4h12v3H0z"></path>
                                    <path fill="#E0BC00" d="M0 7h12v1H0z"></path>
                                </svg> Leaflet
                            </a> 
                            <span aria-hidden="true">|</span> © 
                            <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors
                        </div>
                    </div>
                </div>
            </div>


            <!-- Info Panel -->
            <div class="info-panel" id="infoPanel">
                <div class="info-panel-header">
                    <h3 class="info-panel-title">Selected Parcel Information</h3>
                    <button class="info-panel-close" id="infoPanelClose">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="info-panel-content">
                    <div class="info-item">
                        <span class="info-label">Total Area</span>
                        <span class="info-value">68.00 <span class="info-unit">ha</span></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Woodland</span>
                        <span class="info-value">19.94 <span class="info-unit">ha</span></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Grassland</span>
                        <span class="info-value">30.62 <span class="info-unit">ha</span></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Buffer Strips</span>
                        <span class="info-value">0.48 <span class="info-unit">ha</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile and Settings Section -->
    <div class="profile-section" id="profileSection">
        <div class="profile-header">
            <div class="profile-avatar">
                <i class="material-symbols-rounded">person</i>
            </div>
            <div class="profile-info">
                <h1 class="profile-name">Dr. Sarah Johnson</h1>
                <p class="profile-role">Senior Land Management Specialist • GreenEarth Analytics</p>
                <div class="profile-stats">
                    <div class="profile-stat">
                        <span class="profile-stat-value">127</span>
                        <span class="profile-stat-label">Projects</span>
                    </div>
                    <div class="profile-stat">
                        <span class="profile-stat-value">15,847</span>
                        <span class="profile-stat-label">Hectares Analyzed</span>
                    </div>
                    <div class="profile-stat">
                        <span class="profile-stat-value">8.4</span>
                        <span class="profile-stat-label">Avg. Rating</span>
                    </div>
                    <div class="profile-stat">
                        <span class="profile-stat-value">3.2k</span>
                        <span class="profile-stat-label">Reports Generated</span>
                    </div>
                </div>
            </div>
            <div class="profile-actions">
                <button class="profile-button">
                    <i class="material-symbols-rounded">edit</i>
                    Edit Profile
                </button>
                <button class="profile-button primary">
                    <i class="material-symbols-rounded">upload</i>
                    Upload Avatar
                </button>
            </div>
        </div>

        <div class="settings-grid">
            <div class="settings-card">
                <div class="settings-card-header">
                    <i class="material-symbols-rounded">person</i>
                    <h3 class="settings-card-title">Account Settings</h3>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Two-Factor Authentication</h4>
                        <p class="settings-item-description">Add an extra layer of security to your account</p>
                    </div>
                    <div class="settings-toggle active">
                        <div class="settings-toggle-handle"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Email Notifications</h4>
                        <p class="settings-item-description">Receive updates about your projects and reports</p>
                    </div>
                    <div class="settings-toggle active">
                        <div class="settings-toggle-handle"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Data Export Format</h4>
                        <p class="settings-item-description">Default format for data exports</p>
                    </div>
                    <select class="settings-select">
                        <option>GeoJSON</option>
                        <option>Shapefile</option>
                        <option>KML</option>
                        <option>CSV</option>
                    </select>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Language</h4>
                        <p class="settings-item-description">Choose your preferred language</p>
                    </div>
                    <select class="settings-select">
                        <option>English</option>
                        <option>Spanish</option>
                        <option>French</option>
                        <option>German</option>
                    </select>
                </div>
            </div>

            <div class="settings-card">
                <div class="settings-card-header">
                    <i class="material-symbols-rounded">map</i>
                    <h3 class="settings-card-title">Map Preferences</h3>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Default Map Layer</h4>
                        <p class="settings-item-description">Choose your preferred base map</p>
                    </div>
                    <select class="settings-select">
                        <option>Satellite</option>
                        <option>Street Map</option>
                        <option>Terrain</option>
                        <option>Hybrid</option>
                    </select>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">High-DPI Display</h4>
                        <p class="settings-item-description">Optimize for retina and 4K displays</p>
                    </div>
                    <div class="settings-toggle active">
                        <div class="settings-toggle-handle"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Auto-Save Frequency</h4>
                        <p class="settings-item-description">How often to automatically save your work</p>
                    </div>
                    <select class="settings-select">
                        <option>Every 30 seconds</option>
                        <option>Every minute</option>
                        <option>Every 5 minutes</option>
                        <option>Manual only</option>
                    </select>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Measurement Units</h4>
                        <p class="settings-item-description">Default units for area and distance</p>
                    </div>
                    <select class="settings-select">
                        <option>Metric (ha, km)</option>
                        <option>Imperial (ac, mi)</option>
                        <option>Mixed</option>
                    </select>
                </div>
            </div>

            <div class="settings-card">
                <div class="settings-card-header">
                    <i class="material-symbols-rounded">analytics</i>
                    <h3 class="settings-card-title">Analysis Settings</h3>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Real-time Processing</h4>
                        <p class="settings-item-description">Process satellite data as it becomes available</p>
                    </div>
                    <div class="settings-toggle active">
                        <div class="settings-toggle-handle"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Cloud Detection Threshold</h4>
                        <p class="settings-item-description">Sensitivity for cloud masking in imagery</p>
                    </div>
                    <select class="settings-select">
                        <option>Conservative</option>
                        <option>Moderate</option>
                        <option>Aggressive</option>
                    </select>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">AI Suggestions</h4>
                        <p class="settings-item-description">Show AI-powered analysis suggestions</p>
                    </div>
                    <div class="settings-toggle active">
                        <div class="settings-toggle-handle"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Analysis Resolution</h4>
                        <p class="settings-item-description">Default resolution for analysis operations</p>
                    </div>
                    <select class="settings-select">
                        <option>10m (Sentinel-2)</option>
                        <option>30m (Landsat)</option>
                        <option>250m (MODIS)</option>
                        <option>Auto-select</option>
                    </select>
                </div>
            </div>

            <div class="settings-card">
                <div class="settings-card-header">
                    <i class="material-symbols-rounded">security</i>
                    <h3 class="settings-card-title">Privacy & Security</h3>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Data Sharing</h4>
                        <p class="settings-item-description">Allow anonymous usage analytics to improve service</p>
                    </div>
                    <div class="settings-toggle">
                        <div class="settings-toggle-handle"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Session Timeout</h4>
                        <p class="settings-item-description">Automatically log out after inactivity</p>
                    </div>
                    <select class="settings-select">
                        <option>15 minutes</option>
                        <option>30 minutes</option>
                        <option>1 hour</option>
                        <option>8 hours</option>
                    </select>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Location Services</h4>
                        <p class="settings-item-description">Allow access to your location for enhanced features</p>
                    </div>
                    <div class="settings-toggle active">
                        <div class="settings-toggle-handle"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-item-info">
                        <h4 class="settings-item-title">Data Retention</h4>
                        <p class="settings-item-description">How long to keep your analysis data</p>
                    </div>
                    <select class="settings-select">
                        <option>30 days</option>
                        <option>90 days</option>
                        <option>1 year</option>
                        <option>Indefinitely</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Collaboration Panel -->
    <div class="collaboration-panel" id="collaborationPanel">
        <div class="collaboration-header">
            <h3 class="collaboration-title">
                <i class="material-symbols-rounded">group</i>
                Collaboration
            </h3>
            <button class="collaborator-action" id="collaborationPanelClose">
                <i class="material-symbols-rounded">close</i>
            </button>
        </div>
        <div class="collaboration-content">
            <div class="collaboration-section">
                <button class="share-button" id="shareProjectBtn">
                    <i class="material-symbols-rounded">share</i>
                    Share Project
                </button>
                <div class="share-link-container">
                    <input type="text" class="share-link-input" readonly value="https://landapp.io/projects/SU9444-habitat-analysis" placeholder="Share link will appear here">
                    <button class="copy-button" title="Copy link">
                        <i class="material-symbols-rounded">content_copy</i>
                    </button>
                </div>
            </div>

            <div class="collaboration-section">
                <h4 class="collaboration-section-title">
                    <i class="material-symbols-rounded">people</i>
                    Team Members (4)
                </h4>
                <div class="collaborator-list">
                    <div class="collaborator-item">
                        <div class="collaborator-avatar">
                            SJ
                            <div class="collaborator-status online"></div>
                        </div>
                        <div class="collaborator-info">
                            <p class="collaborator-name">Dr. Sarah Johnson</p>
                            <p class="collaborator-role">Project Lead</p>
                        </div>
                        <div class="permission-badge owner">Owner</div>
                        <div class="collaborator-actions">
                            <button class="collaborator-action" title="More options">
                                <i class="material-symbols-rounded">more_vert</i>
                            </button>
                        </div>
                    </div>

                    <div class="collaborator-item">
                        <div class="collaborator-avatar" style="background: var(--md-sys-color-secondary);">
                            MT
                            <div class="collaborator-status online"></div>
                        </div>
                        <div class="collaborator-info">
                            <p class="collaborator-name">Michael Thompson</p>
                            <p class="collaborator-role">GIS Analyst</p>
                        </div>
                        <div class="permission-badge editor">Editor</div>
                        <div class="collaborator-actions">
                            <button class="collaborator-action" title="Send message">
                                <i class="material-symbols-rounded">chat</i>
                            </button>
                            <button class="collaborator-action" title="More options">
                                <i class="material-symbols-rounded">more_vert</i>
                            </button>
                        </div>
                    </div>

                    <div class="collaborator-item">
                        <div class="collaborator-avatar" style="background: var(--md-sys-color-tertiary);">
                            AR
                            <div class="collaborator-status away"></div>
                        </div>
                        <div class="collaborator-info">
                            <p class="collaborator-name">Dr. Anna Rodriguez</p>
                            <p class="collaborator-role">Environmental Scientist</p>
                        </div>
                        <div class="permission-badge editor">Editor</div>
                        <div class="collaborator-actions">
                            <button class="collaborator-action" title="Send message">
                                <i class="material-symbols-rounded">chat</i>
                            </button>
                            <button class="collaborator-action" title="More options">
                                <i class="material-symbols-rounded">more_vert</i>
                            </button>
                        </div>
                    </div>

                    <div class="collaborator-item">
                        <div class="collaborator-avatar" style="background: var(--land-color-soil);">
                            JC
                            <div class="collaborator-status offline"></div>
                        </div>
                        <div class="collaborator-info">
                            <p class="collaborator-name">James Chen</p>
                            <p class="collaborator-role">Data Specialist</p>
                        </div>
                        <div class="permission-badge viewer">Viewer</div>
                        <div class="collaborator-actions">
                            <button class="collaborator-action" title="Send message">
                                <i class="material-symbols-rounded">chat</i>
                            </button>
                            <button class="collaborator-action" title="More options">
                                <i class="material-symbols-rounded">more_vert</i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collaboration-section">
                <h4 class="collaboration-section-title">
                    <i class="material-symbols-rounded">history</i>
                    Recent Activity
                </h4>
                <div class="recent-activity">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="material-symbols-rounded">edit</i>
                        </div>
                        <div class="activity-content">
                            <p class="activity-text"><strong>Michael Thompson</strong> updated habitat boundaries in Field C</p>
                            <p class="activity-time">2 minutes ago</p>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="material-symbols-rounded">analytics</i>
                        </div>
                        <div class="activity-content">
                            <p class="activity-text"><strong>Dr. Anna Rodriguez</strong> generated NDVI analysis report</p>
                            <p class="activity-time">15 minutes ago</p>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="material-symbols-rounded">comment</i>
                        </div>
                        <div class="activity-content">
                            <p class="activity-text"><strong>James Chen</strong> added a comment on soil quality data</p>
                            <p class="activity-time">1 hour ago</p>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="material-symbols-rounded">upload</i>
                        </div>
                        <div class="activity-content">
                            <p class="activity-text"><strong>Dr. Sarah Johnson</strong> uploaded new satellite imagery</p>
                            <p class="activity-time">3 hours ago</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collaboration-section">
                <h4 class="collaboration-section-title">
                    <i class="material-symbols-rounded">chat</i>
                    Project Comments
                </h4>
                <div class="comments-section">
                    <div class="comment-input-container">
                        <textarea class="comment-input" placeholder="Add a comment or question..."></textarea>
                        <button class="comment-send">
                            <i class="material-symbols-rounded">send</i>
                        </button>
                    </div>
                    <div class="comments-list">
                        <div class="comment-item">
                            <div class="comment-avatar">MT</div>
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-author">Michael Thompson</span>
                                    <span class="comment-time">45 min ago</span>
                                </div>
                                <p class="comment-text">The new NDVI data shows significant improvement in the northeastern section. Should we adjust our restoration priorities?</p>
                            </div>
                        </div>
                        <div class="comment-item">
                            <div class="comment-avatar" style="background: var(--md-sys-color-tertiary);">AR</div>
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-author">Dr. Anna Rodriguez</span>
                                    <span class="comment-time">1 hour ago</span>
                                </div>
                                <p class="comment-text">Agreed! The vegetation response is better than expected. I'll update the biodiversity assessment accordingly.</p>
                            </div>
                        </div>
                        <div class="comment-item">
                            <div class="comment-avatar">SJ</div>
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-author">Dr. Sarah Johnson</span>
                                    <span class="comment-time">2 hours ago</span>
                                </div>
                                <p class="comment-text">Team, please review the latest field data. We have some interesting findings that could impact our final recommendations.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- OSM Query Panel -->
    <div class="osm-panel" id="osmPanel">
        <div class="osm-header">
            <h3>OpenStreetMap Data</h3>
            <button class="panel-close" id="osmPanelClose">
                <i class="material-symbols-rounded">close</i>
            </button>
        </div>
        
        <div class="osm-content">
            <!-- Feature Categories -->
            <div class="osm-features-section">
                <h4>Available Features</h4>
                <p class="section-description">Toggle features on/off to display them on the map</p>
                
                <!-- Amenities Category -->
                <div class="feature-category">
                    <h5 class="category-title">
                        <i class="material-symbols-rounded">restaurant</i>
                        Food & Dining
                    </h5>
                    <div class="feature-toggles">
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-restaurants" data-feature="restaurants">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🍽️ Restaurants</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-cafes" data-feature="cafes">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">☕ Cafes</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-bars" data-feature="bars">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🍺 Bars & Pubs</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-fastfood" data-feature="fastfood">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🍔 Fast Food</span>
                        </label>
                    </div>
                </div>

                <!-- Education & Health Category -->
                <div class="feature-category">
                    <h5 class="category-title">
                        <i class="material-symbols-rounded">school</i>
                        Education & Health
                    </h5>
                    <div class="feature-toggles">
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-schools" data-feature="schools">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🏫 Schools</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-universities" data-feature="universities">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🎓 Universities</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-hospitals" data-feature="hospitals">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🏥 Hospitals</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-pharmacies" data-feature="pharmacies">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">💊 Pharmacies</span>
                        </label>
                    </div>
                </div>

                <!-- Transport Category -->
                <div class="feature-category">
                    <h5 class="category-title">
                        <i class="material-symbols-rounded">directions_bus</i>
                        Transportation
                    </h5>
                    <div class="feature-toggles">
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-transport" data-feature="transport">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🚌 Public Transport</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-parking" data-feature="parking">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🅿️ Parking</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-fuel" data-feature="fuel">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">⛽ Fuel Stations</span>
                        </label>
                    </div>
                </div>

                <!-- Shopping & Services Category -->
                <div class="feature-category">
                    <h5 class="category-title">
                        <i class="material-symbols-rounded">shopping_bag</i>
                        Shopping & Services
                    </h5>
                    <div class="feature-toggles">
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-shops" data-feature="shops">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🛍️ Shops</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-banks" data-feature="banks">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🏦 Banks</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-supermarkets" data-feature="supermarkets">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🛒 Supermarkets</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-postoffice" data-feature="postoffice">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">📮 Post Offices</span>
                        </label>
                    </div>
                </div>

                <!-- Recreation & Tourism Category -->
                <div class="feature-category">
                    <h5 class="category-title">
                        <i class="material-symbols-rounded">park</i>
                        Recreation & Tourism
                    </h5>
                    <div class="feature-toggles">
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-parks" data-feature="parks">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🌳 Parks</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-hotels" data-feature="hotels">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🏨 Hotels</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-museums" data-feature="museums">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🏛️ Museums</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-cinemas" data-feature="cinemas">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🎬 Cinemas</span>
                        </label>
                    </div>
                </div>

                <!-- Buildings & Infrastructure Category -->
                <div class="feature-category">
                    <h5 class="category-title">
                        <i class="material-symbols-rounded">domain</i>
                        Buildings & Infrastructure
                    </h5>
                    <div class="feature-toggles">
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-buildings" data-feature="buildings">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🏢 Buildings</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-residential" data-feature="residential">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🏘️ Residential Areas</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-industrial" data-feature="industrial">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🏭 Industrial Areas</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-commercial" data-feature="commercial">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🏬 Commercial Areas</span>
                        </label>
                    </div>
                </div>

                <!-- Land Use & Agriculture Category -->
                <div class="feature-category">
                    <h5 class="category-title">
                        <i class="material-symbols-rounded">landscape</i>
                        Land Use & Agriculture
                    </h5>
                    <div class="feature-toggles">
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-farmland" data-feature="farmland">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🌾 Farmland</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-forest" data-feature="forest">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🌲 Forests</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-grassland" data-feature="grassland">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">🌱 Grassland</span>
                        </label>
                        <label class="feature-toggle">
                            <input type="checkbox" id="toggle-water" data-feature="water">
                            <span class="toggle-slider"></span>
                            <span class="feature-label">💧 Water Bodies</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Recent Queries -->
            <div class="osm-history-section">
                <h4>Recent Queries</h4>
                <div class="history-list" id="queryHistory">
                    <div class="history-item">
                        <span class="history-query">Transport features</span>
                        <button class="history-rerun" data-query="transport">
                            <i class="material-symbols-rounded">refresh</i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div class="osm-results-section">
                <h4>Active Features <span id="resultCount" class="result-count"></span></h4>
                <div class="results-controls">
                    <button class="results-btn" id="exportResults">
                        <i class="material-symbols-rounded">download</i>
                        Export Data
                    </button>
                    <button class="results-btn" id="clearAllFeatures">
                        <i class="material-symbols-rounded">clear_all</i>
                        Clear All
                    </button>
                </div>
                <div class="active-features-list" id="activeFeaturesInfo">
                    <p class="no-features">No features currently displayed. Toggle features above to see them on the map.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- OSM Feature Inspection Panel -->
    <div class="osm-inspection-panel" id="osmInspectionPanel">
        <div class="inspection-header">
            <h3 id="inspectionTitle">Feature Details</h3>
            <button class="panel-close" id="inspectionPanelClose">
                <i class="material-symbols-rounded">close</i>
            </button>
        </div>
        
        <div class="inspection-content" id="inspectionContent">
            <div class="inspection-loading">
                <i class="material-symbols-rounded spinning">refresh</i>
                <p>Loading feature details...</p>
            </div>
        </div>
    </div>

    <!-- Polygon Information Panel -->
    <div class="polygon-info-panel" id="polygonInfoPanel">
        <div class="polygon-header">
            <h3 id="polygonTitle">Area Information</h3>
            <button class="panel-close" id="polygonPanelClose">
                <i class="material-symbols-rounded">close</i>
            </button>
        </div>
        
        <div class="polygon-content" id="polygonContent">
            <div class="polygon-loading">
                <i class="material-symbols-rounded spinning">refresh</i>
                <p>Loading area information...</p>
            </div>
        </div>
    </div>

    <!-- Learning Center -->
    <div class="learning-center" id="learningCenter">
        <div class="learning-header">
            <button class="learning-close-btn" id="learningCloseBtn" title="Close Learning Center">
                <i class="material-symbols-rounded">close</i>
            </button>
            <div class="learning-header-content">
                <div class="learning-welcome">
                    <h1 class="learning-title">
                        <i class="material-symbols-rounded">school</i>
                        Land Management Learning Center
                    </h1>
                    <p class="learning-subtitle">Master land management with AI-powered learning</p>
                </div>
                <div class="learning-stats">
                    <div class="stat-card">
                        <div class="stat-value">73%</div>
                        <div class="stat-label">Course Progress</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">12</div>
                        <div class="stat-label">Certificates</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">156</div>
                        <div class="stat-label">Hours Learned</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="learning-nav">
            <button class="learning-nav-btn active" data-section="dashboard">
                <i class="material-symbols-rounded">dashboard</i>
                <span>Dashboard</span>
            </button>
            <button class="learning-nav-btn" data-section="courses">
                <i class="material-symbols-rounded">library_books</i>
                <span>Courses</span>
            </button>
            <button class="learning-nav-btn" data-section="ai-tutor">
                <i class="material-symbols-rounded">smart_toy</i>
                <span>AI Tutor</span>
            </button>
            <button class="learning-nav-btn" data-section="achievements">
                <i class="material-symbols-rounded">workspace_premium</i>
                <span>Achievements</span>
            </button>
            <button class="learning-nav-btn" data-section="help">
                <i class="material-symbols-rounded">help</i>
                <span>Help Center</span>
            </button>
        </div>

        <div class="learning-content">
            <!-- Dashboard Section -->
            <div class="learning-section active" id="learning-dashboard">
                <div class="learning-content-inner">
                <div class="learning-grid">
                    <!-- Continue Learning -->
                    <div class="learning-card featured">
                        <div class="card-header">
                            <h3><i class="material-symbols-rounded">play_circle</i> Continue Learning</h3>
                        </div>
                        <div class="current-course">
                            <div class="course-thumbnail">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTIwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iODAiIGZpbGw9IiM0Q0FGNTB8IiByeD0iOCIvPjx0ZXh0IHg9IjYwIiB5PSI0NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+QmlvZGl2ZXJzaXR5PC90ZXh0Pjwvc3ZnPg==" alt="Biodiversity Assessment">
                            </div>
                            <div class="course-info">
                                <h4>Advanced Biodiversity Assessment</h4>
                                <p>Module 4: Habitat Quality Metrics & Field Validation</p>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 78%"></div>
                                </div>
                                <span class="progress-text">78% Complete - 1.2 hours remaining</span>
                            </div>
                            <button class="continue-btn">
                                <i class="material-symbols-rounded">play_arrow</i>
                                Continue
                            </button>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="learning-card">
                        <div class="card-header">
                            <h3><i class="material-symbols-rounded">bolt</i> Quick Actions</h3>
                        </div>
                        <div class="quick-actions">
                            <button class="quick-action">
                                <i class="material-symbols-rounded">map</i>
                                <span>Start New Map</span>
                            </button>
                            <button class="quick-action">
                                <i class="material-symbols-rounded">assessment</i>
                                <span>Practice Analysis</span>
                            </button>
                            <button class="quick-action">
                                <i class="material-symbols-rounded">smart_toy</i>
                                <span>Ask AI Helper</span>
                            </button>
                            <button class="quick-action">
                                <i class="material-symbols-rounded">quiz</i>
                                <span>Test Knowledge</span>
                            </button>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="learning-card">
                        <div class="card-header">
                            <h3><i class="material-symbols-rounded">history</i> Recent Activity</h3>
                        </div>
                        <div class="activity-list">
                            <div class="activity-item">
                                <div class="activity-icon completed">
                                    <i class="material-symbols-rounded">check_circle</i>
                                </div>
                                <div class="activity-content">
                                    <span class="activity-title">Completed: Creating Interactive Maps Tutorial</span>
                                    <span class="activity-time">2 hours ago</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon quiz">
                                    <i class="material-symbols-rounded">quiz</i>
                                </div>
                                <div class="activity-content">
                                    <span class="activity-title">Quiz: Drawing Tools & Measurements (92%)</span>
                                    <span class="activity-time">Yesterday</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon certificate">
                                    <i class="material-symbols-rounded">workspace_premium</i>
                                </div>
                                <div class="activity-content">
                                    <span class="activity-title">Earned: Land Management Basics Certificate</span>
                                    <span class="activity-time">3 days ago</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommended Learning -->
                    <div class="learning-card">
                        <div class="card-header">
                            <h3><i class="material-symbols-rounded">recommend</i> Recommended for You</h3>
                        </div>
                        <div class="recommendation-list">
                            <div class="recommendation-item">
                                <div class="rec-thumbnail">
                                    <i class="material-symbols-rounded">layers</i>
                                </div>
                                <div class="rec-content">
                                    <h4>Working with Map Layers</h4>
                                    <p>Based on your progress • 1.5 hours</p>
                                    <div class="rec-meta">
                                        <span class="difficulty intermediate">Intermediate</span>
                                        <span class="rating">⭐ 4.9</span>
                                    </div>
                                </div>
                            </div>
                            <div class="recommendation-item">
                                <div class="rec-thumbnail">
                                    <i class="material-symbols-rounded">analytics</i>
                                </div>
                                <div class="rec-content">
                                    <h4>Data Analysis & Reporting</h4>
                                    <p>Perfect next step • 2.8 hours</p>
                                    <div class="rec-meta">
                                        <span class="difficulty intermediate">Intermediate</span>
                                        <span class="rating">⭐ 4.7</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Courses Section -->
            <div class="learning-section" id="learning-courses">
                <div class="learning-content-inner">
                <div class="section-header">
                    <h2>Course Library</h2>
                    <div class="course-filters">
                        <button class="filter-btn active" data-filter="all">All Courses</button>
                        <button class="filter-btn" data-filter="beginner">Beginner</button>
                        <button class="filter-btn" data-filter="intermediate">Intermediate</button>
                        <button class="filter-btn" data-filter="advanced">Advanced</button>
                    </div>
                </div>

                <div class="course-tracks">
                    <!-- Beginner Track -->
                    <div class="track-section">
                        <h3 class="track-title">
                            <i class="material-symbols-rounded">rocket_launch</i>
                            Getting Started Track
                        </h3>
                        <div class="course-grid">
                            <div class="course-card beginner">
                                <div class="course-image">
                                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDI0MCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjI0MCIgaGVpZ2h0PSIxNjAiIGZpbGw9IiM0Q0FGNTB8IiByeD0iMTIiLz48dGV4dCB4PSIxMjAiIHk9Ijc1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5HZXR0aW5nIFN0YXJ0ZWQ8L3RleHQ+PHRleHQgeD0iMTIwIiB5PSI5NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+d2l0aCBMYW5kIE1hbmFnZW1lbnQ8L3RleHQ+PC9zdmc+" alt="Getting Started with Land Management">
                                    <div class="course-duration">2h 30m</div>
                                </div>
                                <div class="course-content">
                                    <h4>Getting Started with Land Management</h4>
                                    <p>Master the basics: creating maps, using drawing tools, and understanding the interface.</p>
                                    <div class="course-meta">
                                        <span class="difficulty beginner">Beginner</span>
                                        <span class="rating">⭐ 4.9 (234)</span>
                                    </div>
                                    <div class="course-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 100%"></div>
                                        </div>
                                        <span>Completed</span>
                                    </div>
                                </div>
                            </div>

                            <div class="course-card beginner">
                                <div class="course-image">
                                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDI0MCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjI0MCIgaGVpZ2h0PSIxNjAiIGZpbGw9IiMyMTk2RjMiIHJ4PSIxMiIvPjx0ZXh0IHg9IjEyMCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkludGVyYWN0aXZlIE1hcHM8L3RleHQ+PHRleHQgeD0iMTIwIiB5PSI5NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+JiBOYXZpZ2F0aW9uPC90ZXh0Pjwvc3ZnPg==" alt="Interactive Maps">
                                    <div class="course-duration">3h 15m</div>
                                </div>
                                <div class="course-content">
                                    <h4>Interactive Maps & Navigation</h4>
                                    <p>Learn to navigate, zoom, and use interactive features for effective map exploration.</p>
                                    <div class="course-meta">
                                        <span class="difficulty beginner">Beginner</span>
                                        <span class="rating">⭐ 4.7 (189)</span>
                                    </div>
                                    <div class="course-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 100%"></div>
                                        </div>
                                        <span>Completed</span>
                                    </div>
                                </div>
                            </div>

                            <div class="course-card beginner">
                                <div class="course-image">
                                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDI0MCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjI0MCIgaGVpZ2h0PSIxNjAiIGZpbGw9IiNGRjk4MDAiIHJ4PSIxMiIvPjx0ZXh0IHg9IjEyMCIgeT0iODUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkRhdGEgQ29sbGVjdGlvbjwvdGV4dD48L3N2Zz4=" alt="Data Collection">
                                    <div class="course-duration">4h 15m</div>
                                </div>
                                <div class="course-content">
                                    <h4>Field Data Collection</h4>
                                    <p>Master modern techniques for collecting accurate environmental data in the field.</p>
                                    <div class="course-meta">
                                        <span class="difficulty beginner">Beginner</span>
                                        <span class="rating">⭐ 4.8 (167)</span>
                                    </div>
                                    <div class="course-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 30%"></div>
                                        </div>
                                        <span>30% Complete</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Intermediate Track -->
                    <div class="track-section">
                        <h3 class="track-title">
                            <i class="material-symbols-rounded">trending_up</i>
                            Advanced Analysis Track
                        </h3>
                        <div class="course-grid">
                            <div class="course-card intermediate">
                                <div class="course-image">
                                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDI0MCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjI0MCIgaGVpZ2h0PSIxNjAiIGZpbGw9IiM5QzI3QjAiIHJ4PSIxMiIvPjx0ZXh0IHg9IjEyMCIgeT0iODUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkJpb2RpdmVyc2l0eTwvdGV4dD48L3N2Zz4=" alt="Biodiversity Assessment">
                                    <div class="course-duration">6h 20m</div>
                                </div>
                                <div class="course-content">
                                    <h4>Biodiversity Net Gain Assessment</h4>
                                    <p>Complete guide to calculating and implementing biodiversity net gain requirements.</p>
                                    <div class="course-meta">
                                        <span class="difficulty intermediate">Intermediate</span>
                                        <span class="rating">⭐ 4.9 (312)</span>
                                    </div>
                                    <div class="course-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 65%"></div>
                                        </div>
                                        <span>65% Complete</span>
                                    </div>
                                </div>
                            </div>

                            <div class="course-card intermediate">
                                <div class="course-image">
                                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDI0MCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjI0MCIgaGVpZ2h0PSIxNjAiIGZpbGw9IiNGRjU3MjIiIHJ4PSIxMiIvPjx0ZXh0IHg9IjEyMCIgeT0iODUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPlNhdGVsbGl0ZSBEYXRhPC90ZXh0Pjwvc3ZnPg==" alt="Satellite Analysis">
                                    <div class="course-duration">5h 45m</div>
                                </div>
                                <div class="course-content">
                                    <h4>Satellite Data Analysis</h4>
                                    <p>Learn to interpret and analyze satellite imagery for land cover and change detection.</p>
                                    <div class="course-meta">
                                        <span class="difficulty intermediate">Intermediate</span>
                                        <span class="rating">⭐ 4.6 (278)</span>
                                    </div>
                                    <div class="course-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 0%"></div>
                                        </div>
                                        <span>Not Started</span>
                                    </div>
                                </div>
                            </div>

                            <div class="course-card intermediate">
                                <div class="course-image">
                                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDI0MCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjI0MCIgaGVpZ2h0PSIxNjAiIGZpbGw9IiMwMDk2ODgiIHJ4PSIxMiIvPjx0ZXh0IHg9IjEyMCIgeT0iODUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkNhcmJvbiBBbmFseXNpczwvdGV4dD48L3N2Zz4=" alt="Carbon Analysis">
                                    <div class="course-duration">4h 30m</div>
                                </div>
                                <div class="course-content">
                                    <h4>Carbon Sequestration Modeling</h4>
                                    <p>Advanced techniques for measuring and modeling carbon storage in landscapes.</p>
                                    <div class="course-meta">
                                        <span class="difficulty advanced">Advanced</span>
                                        <span class="rating">⭐ 4.8 (156)</span>
                                    </div>
                                    <div class="course-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 0%"></div>
                                        </div>
                                        <span>Locked</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- AI Tutor Section -->
            <div class="learning-section" id="learning-ai-tutor">
                <div class="learning-content-inner">
                <div class="ai-tutor-container">
                    <div class="ai-tutor-header">
                        <div class="ai-avatar">
                            <i class="material-symbols-rounded">smart_toy</i>
                        </div>
                        <div class="ai-intro">
                            <h2>Your AI Learning Assistant</h2>
                            <p>Get instant help with the Land App! I can guide you through features, explain tools, and help solve problems.</p>
                        </div>
                        <div class="ai-status">
                            <div class="status-indicator online"></div>
                            <span>Ready to Help</span>
                        </div>
                    </div>

                    <div class="ai-suggestions">
                        <h3>Popular Questions</h3>
                        <div class="suggestion-grid">
                            <button class="suggestion-card">
                                <i class="material-symbols-rounded">draw</i>
                                <h4>How do I draw boundaries on the map?</h4>
                                <p>Learn to use drawing tools and create areas</p>
                            </button>
                            <button class="suggestion-card">
                                <i class="material-symbols-rounded">layers</i>
                                <h4>How do I add and manage map layers?</h4>
                                <p>Understanding layer controls and visibility</p>
                            </button>
                            <button class="suggestion-card">
                                <i class="material-symbols-rounded">analytics</i>
                                <h4>How to analyze my drawn areas?</h4>
                                <p>Calculate areas, generate reports, and export data</p>
                            </button>
                            <button class="suggestion-card">
                                <i class="material-symbols-rounded">share</i>
                                <h4>How do I share my maps with others?</h4>
                                <p>Export, share links, and collaborate on projects</p>
                            </button>
                        </div>
                    </div>

                    <div class="ai-chat">
                        <div class="chat-messages">
                            <div class="message ai-message">
                                <div class="message-avatar">
                                    <i class="material-symbols-rounded">smart_toy</i>
                                </div>
                                <div class="message-content">
                                    <p>Hi! I'm here to help you master the Land App. I can assist with:</p>
                                    <ul>
                                        <li>🗺️ <strong>Map Navigation</strong> - Zoom, pan, and explore your maps</li>
                                        <li>✏️ <strong>Drawing Tools</strong> - Create boundaries, measure areas, add points</li>
                                        <li>📊 <strong>Data Analysis</strong> - Analyze your mapped areas and generate reports</li>
                                        <li>📤 <strong>Export & Sharing</strong> - Save your work and share with team members</li>
                                        <li>⚙️ <strong>Settings & Features</strong> - Customize the app to your needs</li>
                                    </ul>
                                    <p>What feature would you like help with?</p>
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <div class="chat-input-container">
                                <input type="text" placeholder="Ask me about using the Land App features..." class="chat-input">
                                <button class="chat-attach-btn" title="Attach screenshot">
                                    <i class="material-symbols-rounded">attach_file</i>
                                </button>
                                <button class="chat-voice-btn" title="Voice input">
                                    <i class="material-symbols-rounded">mic</i>
                                </button>
                                <button class="chat-send-btn" title="Send message">
                                    <i class="material-symbols-rounded">send</i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Achievements Section -->
            <div class="learning-section" id="learning-achievements">
                <div class="learning-content-inner">
                <div class="achievements-header">
                    <h2>Your Achievements</h2>
                    <div class="achievement-stats">
                        <div class="achievement-stat">
                            <span class="stat-number">12</span>
                            <span class="stat-label">Certificates</span>
                        </div>
                        <div class="achievement-stat">
                            <span class="stat-number">2,340</span>
                            <span class="stat-label">Points Earned</span>
                        </div>
                        <div class="achievement-stat">
                            <span class="stat-number">94%</span>
                            <span class="stat-label">Average Score</span>
                        </div>
                    </div>
                </div>

                <div class="achievements-grid">
                    <!-- Certificates -->
                    <div class="achievement-category">
                        <h3><i class="material-symbols-rounded">workspace_premium</i> Certificates</h3>
                        <div class="certificates-grid">
                            <div class="certificate-card earned">
                                <div class="certificate-icon">
                                    <i class="material-symbols-rounded">eco</i>
                                </div>
                                <h4>Land Management Fundamentals</h4>
                                <p>Completed: March 15, 2024</p>
                                <div class="certificate-score">Score: 96%</div>
                            </div>
                            <div class="certificate-card earned">
                                <div class="certificate-icon">
                                    <i class="material-symbols-rounded">map</i>
                                </div>
                                <h4>GIS Professional</h4>
                                <p>Completed: March 22, 2024</p>
                                <div class="certificate-score">Score: 91%</div>
                            </div>
                            <div class="certificate-card in-progress">
                                <div class="certificate-icon">
                                    <i class="material-symbols-rounded">nature</i>
                                </div>
                                <h4>Biodiversity Assessment Expert</h4>
                                <p>In Progress: 65% Complete</p>
                                <div class="certificate-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 65%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="certificate-card locked">
                                <div class="certificate-icon">
                                    <i class="material-symbols-rounded">science</i>
                                </div>
                                <h4>Advanced Carbon Modeling</h4>
                                <p>Requires: Biodiversity Expert Certificate</p>
                                <div class="certificate-requirements">🔒 Locked</div>
                            </div>
                        </div>
                    </div>

                    <!-- Badges -->
                    <div class="achievement-category">
                        <h3><i class="material-symbols-rounded">military_tech</i> Achievement Badges</h3>
                        <div class="badges-grid">
                            <div class="badge earned">
                                <i class="material-symbols-rounded">streak</i>
                                <span>7-Day Streak</span>
                            </div>
                            <div class="badge earned">
                                <i class="material-symbols-rounded">quiz</i>
                                <span>Quiz Master</span>
                            </div>
                            <div class="badge earned">
                                <i class="material-symbols-rounded">forum</i>
                                <span>Helpful Helper</span>
                            </div>
                            <div class="badge earned">
                                <i class="material-symbols-rounded">speed</i>
                                <span>Fast Learner</span>
                            </div>
                            <div class="badge in-progress">
                                <i class="material-symbols-rounded">workspace_premium</i>
                                <span>Expert Level</span>
                            </div>
                            <div class="badge locked">
                                <i class="material-symbols-rounded">star</i>
                                <span>All-Star</span>
                            </div>
                        </div>
                    </div>

                    <!-- Leaderboard -->
                    <div class="achievement-category">
                        <h3><i class="material-symbols-rounded">leaderboard</i> This Month's Leaderboard</h3>
                        <div class="leaderboard">
                            <div class="leaderboard-item current-user">
                                <div class="rank">3</div>
                                <div class="user-info">
                                    <div class="avatar">
                                        <i class="material-symbols-rounded">person</i>
                                    </div>
                                    <span>You</span>
                                </div>
                                <div class="points">2,340 pts</div>
                            </div>
                            <div class="leaderboard-item">
                                <div class="rank">1</div>
                                <div class="user-info">
                                    <div class="avatar" style="background: #4CAF50;">EM</div>
                                    <span>Emma Martinez</span>
                                </div>
                                <div class="points">3,156 pts</div>
                            </div>
                            <div class="leaderboard-item">
                                <div class="rank">2</div>
                                <div class="user-info">
                                    <div class="avatar" style="background: #2196F3;">JC</div>
                                    <span>James Chen</span>
                                </div>
                                <div class="points">2,847 pts</div>
                            </div>
                            <div class="leaderboard-item">
                                <div class="rank">4</div>
                                <div class="user-info">
                                    <div class="avatar" style="background: #FF9800;">AR</div>
                                    <span>Alex Rodriguez</span>
                                </div>
                                <div class="points">2,190 pts</div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Help Center Section -->
            <div class="learning-section" id="learning-help">
                <div class="learning-content-inner">
                <div class="help-header">
                    <h2>Help Center</h2>
                    <div class="help-search">
                        <div class="search-container">
                            <i class="material-symbols-rounded">search</i>
                            <input type="text" placeholder="Search for help articles, tutorials, or solutions...">
                        </div>
                    </div>
                </div>

                <div class="help-categories">
                    <div class="help-category">
                        <div class="category-header">
                            <i class="material-symbols-rounded">get_started</i>
                            <h3>Getting Started</h3>
                        </div>
                        <div class="help-articles">
                            <a href="#" class="help-article">
                                <span>Creating your first map</span>
                                <i class="material-symbols-rounded">arrow_forward</i>
                            </a>
                            <a href="#" class="help-article">
                                <span>Navigating the Land App interface</span>
                                <i class="material-symbols-rounded">arrow_forward</i>
                            </a>
                            <a href="#" class="help-article">
                                <span>Basic drawing tools tutorial</span>
                                <i class="material-symbols-rounded">arrow_forward</i>
                            </a>
                        </div>
                    </div>

                    <div class="help-category">
                        <div class="category-header">
                            <i class="material-symbols-rounded">draw</i>
                            <h3>Drawing & Mapping</h3>
                        </div>
                        <div class="help-articles">
                            <a href="#" class="help-article">
                                <span>Using polygon drawing tools</span>
                                <i class="material-symbols-rounded">arrow_forward</i>
                            </a>
                            <a href="#" class="help-article">
                                <span>Measuring areas and distances</span>
                                <i class="material-symbols-rounded">arrow_forward</i>
                            </a>
                            <a href="#" class="help-article">
                                <span>Adding points and markers</span>
                                <i class="material-symbols-rounded">arrow_forward</i>
                            </a>
                        </div>
                    </div>

                    <div class="help-category">
                        <div class="category-header">
                            <i class="material-symbols-rounded">report_problem</i>
                            <h3>Troubleshooting</h3>
                        </div>
                        <div class="help-articles">
                            <a href="#" class="help-article">
                                <span>Map not loading or displaying correctly</span>
                                <i class="material-symbols-rounded">arrow_forward</i>
                            </a>
                            <a href="#" class="help-article">
                                <span>Drawing tools not responding</span>
                                <i class="material-symbols-rounded">arrow_forward</i>
                            </a>
                            <a href="#" class="help-article">
                                <span>Browser compatibility and performance</span>
                                <i class="material-symbols-rounded">arrow_forward</i>
                            </a>
                        </div>
                    </div>

                    <div class="help-category">
                        <div class="category-header">
                            <i class="material-symbols-rounded">video_library</i>
                            <h3>Video Tutorials</h3>
                        </div>
                        <div class="video-tutorials">
                            <div class="video-card">
                                <div class="video-thumbnail">
                                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTYwIDkwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNjAiIGhlaWdodD0iOTAiIGZpbGw9IiNGRjU3MjIiIHJ4PSI4Ii8+PGNpcmNsZSBjeD0iODAiIGN5PSI0NSIgcj0iMjAiIGZpbGw9IndoaXRlIiBmaWxsLW9wYWNpdHk9IjAuOSIvPjxwYXRoIGQ9Ik03NSA0MEw4NSA0NUw3NSA1MFoiIGZpbGw9IiNGRjU3MjIiLz48L3N2Zz4=" alt="Tutorial">
                                    <div class="play-icon">
                                        <i class="material-symbols-rounded">play_arrow</i>
                                    </div>
                                    <div class="video-duration">12:34</div>
                                </div>
                                <h4>Land App Complete Tutorial</h4>
                                <p>Complete walkthrough of all Land App features and tools</p>
                            </div>
                            <div class="video-card">
                                <div class="video-thumbnail">
                                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTYwIDkwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNjAiIGhlaWdodD0iOTAiIGZpbGw9IiM0Q0FGNTB8IiByeD0iOCIvPjxjaXJjbGUgY3g9IjgwIiBjeT0iNDUiIHI9IjIwIiBmaWxsPSJ3aGl0ZSIgZmlsbC1vcGFjaXR5PSIwLjkiLz48cGF0aCBkPSJNNzUgNDBMODUgNDVMNzUgNTBaIiBmaWxsPSIjNENBRjUwfCIvPjwvc3ZnPg==" alt="Tutorial">
                                    <div class="play-icon">
                                        <i class="material-symbols-rounded">play_arrow</i>
                                    </div>
                                    <div class="video-duration">8:45</div>
                                </div>
                                <h4>Drawing Tools & Area Measurement</h4>
                                <p>Master the drawing tools and learn to measure areas accurately</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="help-contact">
                    <div class="contact-card">
                        <i class="material-symbols-rounded">support_agent</i>
                        <h3>Still Need Help?</h3>
                        <p>Our AI Assistant is available 24/7 to provide personalized support and guidance.</p>
                        <button class="contact-btn">
                            <i class="material-symbols-rounded">smart_toy</i>
                            Chat with AI Assistant
                        </button>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="contextReport">
            <i class="fas fa-chart-bar"></i>
            <span>Generate Report</span>
        </div>
        <div class="context-menu-item" id="contextEdit">
            <i class="fas fa-edit"></i>
            <span>Edit Properties</span>
        </div>
        <div class="context-menu-item" id="contextDelete">
            <i class="fas fa-trash"></i>
            <span>Delete</span>
        </div>
    </div>

    <!-- Analysis Report Panel -->
    <div class="analysis-panel" id="analysisPanel">
        <div class="analysis-header">
            <h3 class="analysis-title">Polygon Analysis Report</h3>
            <div class="analysis-header-buttons">
                <button class="dashboard-toggle" id="dashboardToggle" title="Interactive Dashboard">
                    <i class="fas fa-chart-bar"></i>
                    <span>Dashboard</span>
                </button>
                <button class="analysis-close" id="analysisPanelClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="analysis-content" id="analysisContent">
            <div class="analysis-loading">
                <i class="fas fa-spinner"></i>
                <span>Loading analysis...</span>
            </div>
        </div>
    </div>

    <!-- Dashboard Panel -->
    <div class="dashboard-panel" id="dashboardPanel">
        <div class="dashboard-header">
            <h2 class="dashboard-title">
                <i class="fas fa-chart-bar"></i>
                Interactive Analysis Dashboard
            </h2>
            <div class="dashboard-header-buttons">
                <button class="dashboard-minimize" id="dashboardMinimize" title="Back to Report">
                    <i class="fas fa-compress"></i>
                    <span>Report View</span>
                </button>
                <button class="dashboard-close" id="dashboardClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="dashboard-content" id="dashboardContent">
            <div class="dashboard-grid">
                <!-- Real-time Monitoring Section -->
                <div class="dashboard-section realtime-section">
                    <div class="realtime-header">
                        <h4><i class="material-symbols-rounded">sensors</i> Real-time Monitoring</h4>
                        <div class="live-indicator">
                            <div class="pulse-dot"></div>
                            <span>LIVE • Last update: 2 min ago</span>
                        </div>
                    </div>
                    <div class="monitoring-grid">
                        <div class="monitor-card satellite-card">
                            <div class="monitor-card-header">
                                <div class="monitor-card-title">
                                    <i class="material-symbols-rounded">satellite_alt</i>
                                    Satellite Monitoring
                                </div>
                                <div class="monitor-card-status active">
                                    <i class="material-symbols-rounded">check_circle</i>
                                    Active
                                </div>
                            </div>
                            <div class="monitor-card-content">
                                <div class="monitor-metric">
                                    <span class="monitor-metric-label">Next Sentinel-2 Pass</span>
                                    <span class="monitor-metric-value good">3h 24m</span>
                                </div>
                                <div class="monitor-metric">
                                    <span class="monitor-metric-label">Cloud Coverage</span>
                                    <span class="monitor-metric-value good">12%</span>
                                </div>
                                <div class="monitor-metric">
                                    <span class="monitor-metric-label">Image Quality</span>
                                    <span class="monitor-metric-value good">Excellent</span>
                                </div>
                                <div class="monitor-metric">
                                    <span class="monitor-metric-label">Data Freshness</span>
                                    <span class="monitor-metric-value">2 days ago</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 85%;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="monitor-card alerts-card">
                            <div class="monitor-card-header">
                                <div class="monitor-card-title">
                                    <i class="material-symbols-rounded">notification_important</i>
                                    Environmental Alerts
                                </div>
                                <div class="monitor-card-status warning">
                                    <i class="material-symbols-rounded">warning</i>
                                    2 Active
                                </div>
                            </div>
                            <div class="monitor-card-content">
                                <div class="monitor-metric">
                                    <span class="monitor-metric-label">Drought Risk</span>
                                    <span class="monitor-metric-value warning">Medium</span>
                                </div>
                                <div class="monitor-metric">
                                    <span class="monitor-metric-label">Fire Risk</span>
                                    <span class="monitor-metric-value good">Low</span>
                                </div>
                                <div class="monitor-metric">
                                    <span class="monitor-metric-label">Flood Risk</span>
                                    <span class="monitor-metric-value warning">Medium</span>
                                </div>
                                <div class="monitor-metric">
                                    <span class="monitor-metric-label">Air Quality Index</span>
                                    <span class="monitor-metric-value good">32 (Good)</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 65%; background: var(--land-color-warning);"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="monitor-card system-card">
                            <div class="monitor-card-header">
                                <div class="monitor-card-title">
                                    <i class="material-symbols-rounded">computer</i>
                                    System Health
                                </div>
                                <div class="monitor-card-status active">
                                    <i class="material-symbols-rounded">check_circle</i>
                                    Optimal
                                </div>
                            </div>
                            <div class="monitor-card-content">
                                <div class="monitor-metric">
                                    <span class="monitor-metric-label">Data Processing</span>
                                    <span class="monitor-metric-value good">98.7% Uptime</span>
                                </div>
                                <div class="monitor-metric">
                                    <span class="monitor-metric-label">API Response Time</span>
                                    <span class="monitor-metric-value good">142ms</span>
                                </div>
                                <div class="monitor-metric">
                                    <span class="monitor-metric-label">Storage Usage</span>
                                    <span class="monitor-metric-value">67% (2.1GB)</span>
                                </div>
                                <div class="monitor-metric">
                                    <span class="monitor-metric-label">Active Connections</span>
                                    <span class="monitor-metric-value">1,247</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 98%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Assistant Section -->
                <div class="dashboard-section ai-section">
                    <div class="ai-header">
                        <h4><i class="material-symbols-rounded">smart_toy</i> AI Land Assistant</h4>
                        <div class="ai-status">
                            <i class="material-symbols-rounded">check_circle</i>
                            Ready
                        </div>
                    </div>
                    <div class="ai-container">
                        <div class="ai-chat-area">
                            <div class="ai-message assistant">
                                <div class="ai-avatar">
                                    <i class="material-symbols-rounded">smart_toy</i>
                                </div>
                                <div class="ai-message-content">
                                    <p>Hi! I'm your AI Land Assistant. I can analyze your data and provide insights. What would you like to know about your land management project?</p>
                                    <div class="ai-suggestions">
                                        <div class="suggestion-chip">📊 Analyze crop health in Field C</div>
                                        <div class="suggestion-chip">🌱 Compare NDVI trends over time</div>
                                        <div class="suggestion-chip">💧 Assess water stress indicators</div>
                                        <div class="suggestion-chip">🎯 Recommend optimal planting zones</div>
                                        <div class="suggestion-chip">📈 Generate biodiversity report</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ai-message user">
                                <div class="ai-avatar">
                                    <i class="material-symbols-rounded">person</i>
                                </div>
                                <div class="ai-message-content">
                                    <p>Can you analyze the current vegetation health across all our managed areas and identify any concerning trends?</p>
                                </div>
                            </div>
                            
                            <div class="ai-message assistant">
                                <div class="ai-avatar">
                                    <i class="material-symbols-rounded">smart_toy</i>
                                </div>
                                <div class="ai-message-content">
                                    <p>I've analyzed the latest satellite data and here's what I found:</p>
                                    <p><strong>🟢 Positive Trends:</strong></p>
                                    <p>• Field A & B showing 12% NDVI improvement over last month</p>
                                    <p>• Restoration areas exceeding growth projections by 18%</p>
                                    <p><strong>⚠️ Areas Needing Attention:</strong></p>
                                    <p>• Field C southeast corner showing 8% vegetation decline</p>
                                    <p>• Possible water stress in zones 7-9 based on spectral analysis</p>
                                    <div class="ai-insights-grid">
                                        <div class="ai-insight-card">
                                            <div class="ai-insight-header">
                                                <i class="material-symbols-rounded ai-insight-icon">trending_up</i>
                                                <h5 class="ai-insight-title">Overall Health Score</h5>
                                            </div>
                                            <p class="ai-insight-content">82/100 - Good with room for improvement in water management</p>
                                        </div>
                                        <div class="ai-insight-card">
                                            <div class="ai-insight-header">
                                                <i class="material-symbols-rounded ai-insight-icon">recommend</i>
                                                <h5 class="ai-insight-title">Next Actions</h5>
                                            </div>
                                            <p class="ai-insight-content">Implement drip irrigation in zones 7-9, monitor Field C for pest activity</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ai-thinking">
                                <div class="thinking-dots">
                                    <div class="thinking-dot"></div>
                                    <div class="thinking-dot"></div>
                                    <div class="thinking-dot"></div>
                                </div>
                                <span>Analyzing latest field data...</span>
                            </div>
                        </div>
                        
                        <div class="ai-input-area">
                            <textarea class="ai-input" placeholder="Ask me anything about your land data..." rows="2"></textarea>
                            <div class="ai-input-actions">
                                <button class="ai-action-button" title="Send message">
                                    <i class="material-symbols-rounded">send</i>
                                </button>
                                <button class="ai-action-button secondary" title="Voice input">
                                    <i class="material-symbols-rounded">mic</i>
                                </button>
                                <button class="ai-action-button secondary" title="Attach file">
                                    <i class="material-symbols-rounded">attach_file</i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Funding Opportunities Section -->
                <div class="dashboard-section funding-section">
                    <div class="funding-header">
                        <h3 class="funding-title">
                            <i class="material-symbols-rounded">monetization_on</i>
                            Funding Opportunities
                        </h3>
                        <div class="funding-stats">
                            <div class="funding-stat">
                                <p class="funding-stat-value">127</p>
                                <p class="funding-stat-label">Available</p>
                            </div>
                            <div class="funding-stat">
                                <p class="funding-stat-value">£2.8M</p>
                                <p class="funding-stat-label">Total Value</p>
                            </div>
                            <div class="funding-stat">
                                <p class="funding-stat-value">23</p>
                                <p class="funding-stat-label">High Match</p>
                            </div>
                        </div>
                    </div>

                    <div class="funding-filters">
                        <div class="funding-search">
                            <i class="material-symbols-rounded funding-search-icon">search</i>
                            <input type="text" class="funding-search-input" placeholder="Search funding opportunities by keyword, provider, or location...">
                        </div>
                        <div class="funding-filter-chips">
                            <div class="funding-filter-chip active">
                                <i class="material-symbols-rounded">all_inclusive</i>
                                All
                            </div>
                            <div class="funding-filter-chip">
                                <i class="material-symbols-rounded">nature</i>
                                Environmental
                            </div>
                            <div class="funding-filter-chip">
                                <i class="material-symbols-rounded">agriculture</i>
                                Agriculture
                            </div>
                            <div class="funding-filter-chip">
                                <i class="material-symbols-rounded">forest</i>
                                Biodiversity
                            </div>
                            <div class="funding-filter-chip">
                                <i class="material-symbols-rounded">schedule</i>
                                Deadline Soon
                            </div>
                        </div>
                    </div>

                    <div class="funding-grid">
                        <!-- UK Environmental Land Management -->
                        <div class="funding-card">
                            <div class="funding-match-score">94%</div>
                            <div class="funding-card-header">
                                <div>
                                    <h4 class="funding-card-title">Sustainable Farming Incentive (SFI)</h4>
                                    <p class="funding-card-provider">UK Department for Environment, Food & Rural Affairs</p>
                                </div>
                                <div class="funding-amount">
                                    <p class="funding-amount-value">£1,000</p>
                                    <p class="funding-amount-currency">per year maximum</p>
                                </div>
                            </div>
                            <p class="funding-card-description">Ongoing payments to farmers for managing land in an environmentally-sustainable way. Available for up to 102 SFI actions including soil health, biodiversity, and carbon sequestration.</p>
                            <div class="funding-card-tags">
                                <span class="funding-tag priority">High Priority</span>
                                <span class="funding-tag">Environmental</span>
                                <span class="funding-tag">UK</span>
                                <span class="funding-tag">Ongoing</span>
                            </div>
                            <div class="funding-card-details">
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Application Deadline</span>
                                    <span class="funding-detail-value">Rolling Applications</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Project Duration</span>
                                    <span class="funding-detail-value">3 years</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Eligibility</span>
                                    <span class="funding-detail-value">All Farmers</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Success Rate</span>
                                    <span class="funding-detail-value">78%</span>
                                </div>
                            </div>
                            <div class="funding-card-actions">
                                <button class="funding-action-button primary">
                                    <i class="material-symbols-rounded">description</i>
                                    Apply Now
                                </button>
                                <button class="funding-action-button secondary">
                                    <i class="material-symbols-rounded">bookmark</i>
                                    Save
                                </button>
                            </div>
                        </div>

                        <!-- USDA Conservation Innovation Grants -->
                        <div class="funding-card">
                            <div class="funding-match-score">87%</div>
                            <div class="funding-card-header">
                                <div>
                                    <h4 class="funding-card-title">Conservation Innovation Grants</h4>
                                    <p class="funding-card-provider">USDA Natural Resources Conservation Service</p>
                                </div>
                                <div class="funding-amount">
                                    <p class="funding-amount-value">$2M</p>
                                    <p class="funding-amount-currency">maximum</p>
                                </div>
                            </div>
                            <p class="funding-card-description">Support for early-stage development and piloting of innovative conservation approaches, tools, and technologies for natural resource conservation on private lands.</p>
                            <div class="funding-card-tags">
                                <span class="funding-tag">Innovation</span>
                                <span class="funding-tag">USA</span>
                                <span class="funding-tag deadline-soon">Deadline Dec 13</span>
                                <span class="funding-tag">Conservation</span>
                            </div>
                            <div class="funding-card-details">
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Application Deadline</span>
                                    <span class="funding-detail-value">December 13, 2024</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Project Duration</span>
                                    <span class="funding-detail-value">1-3 years</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Eligibility</span>
                                    <span class="funding-detail-value">Non-Federal Entities</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Success Rate</span>
                                    <span class="funding-detail-value">23%</span>
                                </div>
                            </div>
                            <div class="funding-card-actions">
                                <button class="funding-action-button primary">
                                    <i class="material-symbols-rounded">description</i>
                                    Apply Now
                                </button>
                                <button class="funding-action-button secondary">
                                    <i class="material-symbols-rounded">bookmark</i>
                                    Save
                                </button>
                            </div>
                        </div>

                        <!-- Global Environment Facility -->
                        <div class="funding-card">
                            <div class="funding-match-score">76%</div>
                            <div class="funding-card-header">
                                <div>
                                    <h4 class="funding-card-title">Global Biodiversity Framework Fund</h4>
                                    <p class="funding-card-provider">Global Environment Facility</p>
                                </div>
                                <div class="funding-amount">
                                    <p class="funding-amount-value">$37.8M</p>
                                    <p class="funding-amount-currency">available</p>
                                </div>
                            </div>
                            <p class="funding-card-description">Support for implementation of the Global Biodiversity Framework, focusing on protected area management and ecosystem restoration projects worldwide.</p>
                            <div class="funding-card-tags">
                                <span class="funding-tag">Global</span>
                                <span class="funding-tag">Biodiversity</span>
                                <span class="funding-tag priority">High Priority</span>
                                <span class="funding-tag">Large Scale</span>
                            </div>
                            <div class="funding-card-details">
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Application Deadline</span>
                                    <span class="funding-detail-value">Rolling Basis</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Project Duration</span>
                                    <span class="funding-detail-value">3-7 years</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Eligibility</span>
                                    <span class="funding-detail-value">Developing Countries</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Success Rate</span>
                                    <span class="funding-detail-value">45%</span>
                                </div>
                            </div>
                            <div class="funding-card-actions">
                                <button class="funding-action-button primary">
                                    <i class="material-symbols-rounded">description</i>
                                    Learn More
                                </button>
                                <button class="funding-action-button secondary">
                                    <i class="material-symbols-rounded">bookmark</i>
                                    Save
                                </button>
                            </div>
                        </div>

                        <!-- Countryside Stewardship -->
                        <div class="funding-card">
                            <div class="funding-match-score">91%</div>
                            <div class="funding-card-header">
                                <div>
                                    <h4 class="funding-card-title">Countryside Stewardship Mid Tier</h4>
                                    <p class="funding-card-provider">Natural England</p>
                                </div>
                                <div class="funding-amount">
                                    <p class="funding-amount-value">£573</p>
                                    <p class="funding-amount-currency">per hectare avg</p>
                                </div>
                            </div>
                            <p class="funding-card-description">Competitive scheme supporting environmental management on farms and other rural land. Focus on protecting wildlife habitats, restoring landscapes, and managing flood risks.</p>
                            <div class="funding-card-tags">
                                <span class="funding-tag">UK</span>
                                <span class="funding-tag">Wildlife</span>
                                <span class="funding-tag deadline-soon">Opens Spring 2025</span>
                                <span class="funding-tag">Competitive</span>
                            </div>
                            <div class="funding-card-details">
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Application Deadline</span>
                                    <span class="funding-detail-value">Spring 2025</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Project Duration</span>
                                    <span class="funding-detail-value">5 years</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Eligibility</span>
                                    <span class="funding-detail-value">Land Managers</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Success Rate</span>
                                    <span class="funding-detail-value">62%</span>
                                </div>
                            </div>
                            <div class="funding-card-actions">
                                <button class="funding-action-button primary">
                                    <i class="material-symbols-rounded">notification_add</i>
                                    Get Notified
                                </button>
                                <button class="funding-action-button secondary">
                                    <i class="material-symbols-rounded">bookmark</i>
                                    Save
                                </button>
                            </div>
                        </div>

                        <!-- Green Climate Fund -->
                        <div class="funding-card">
                            <div class="funding-match-score">68%</div>
                            <div class="funding-card-header">
                                <div>
                                    <h4 class="funding-card-title">Green Climate Fund - Water Security</h4>
                                    <p class="funding-card-provider">Green Climate Fund</p>
                                </div>
                                <div class="funding-amount">
                                    <p class="funding-amount-value">$500M</p>
                                    <p class="funding-amount-currency">total program</p>
                                </div>
                            </div>
                            <p class="funding-card-description">Paradigm shift towards climate-resilient development through water security initiatives, ecosystem restoration, and climate adaptation projects.</p>
                            <div class="funding-card-tags">
                                <span class="funding-tag">Global</span>
                                <span class="funding-tag">Climate</span>
                                <span class="funding-tag">Water</span>
                                <span class="funding-tag">Large Scale</span>
                            </div>
                            <div class="funding-card-details">
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Application Deadline</span>
                                    <span class="funding-detail-value">Ongoing</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Project Duration</span>
                                    <span class="funding-detail-value">5-8 years</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Eligibility</span>
                                    <span class="funding-detail-value">Accredited Entities</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Success Rate</span>
                                    <span class="funding-detail-value">38%</span>
                                </div>
                            </div>
                            <div class="funding-card-actions">
                                <button class="funding-action-button primary">
                                    <i class="material-symbols-rounded">description</i>
                                    Learn More
                                </button>
                                <button class="funding-action-button secondary">
                                    <i class="material-symbols-rounded">bookmark</i>
                                    Save
                                </button>
                            </div>
                        </div>

                        <!-- Value-Added Producer Grants -->
                        <div class="funding-card">
                            <div class="funding-match-score">82%</div>
                            <div class="funding-card-header">
                                <div>
                                    <h4 class="funding-card-title">Value-Added Producer Grants</h4>
                                    <p class="funding-card-provider">USDA Rural Development</p>
                                </div>
                                <div class="funding-amount">
                                    <p class="funding-amount-value">$30M</p>
                                    <p class="funding-amount-currency">total available</p>
                                </div>
                            </div>
                            <p class="funding-card-description">Support for beginning, socially-disadvantaged, and small/medium family farms, cooperatives, and mid-tier value chain projects creating better markets.</p>
                            <div class="funding-card-tags">
                                <span class="funding-tag">USA</span>
                                <span class="funding-tag">Value-Add</span>
                                <span class="funding-tag">Small Farm</span>
                                <span class="funding-tag priority">High Priority</span>
                            </div>
                            <div class="funding-card-details">
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Application Deadline</span>
                                    <span class="funding-detail-value">TBD 2025</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Project Duration</span>
                                    <span class="funding-detail-value">1-3 years</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Eligibility</span>
                                    <span class="funding-detail-value">Agricultural Producers</span>
                                </div>
                                <div class="funding-detail">
                                    <span class="funding-detail-label">Success Rate</span>
                                    <span class="funding-detail-value">56%</span>
                                </div>
                            </div>
                            <div class="funding-card-actions">
                                <button class="funding-action-button primary">
                                    <i class="material-symbols-rounded">notification_add</i>
                                    Get Notified
                                </button>
                                <button class="funding-action-button secondary">
                                    <i class="material-symbols-rounded">bookmark</i>
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- AI Funding Assistant -->
                    <div class="funding-ai-assistant">
                        <div class="funding-ai-header">
                            <i class="material-symbols-rounded">smart_toy</i>
                            <h4 class="funding-ai-title">AI Funding Assistant</h4>
                        </div>
                        <div class="funding-ai-suggestions">
                            <div class="funding-ai-suggestion">
                                <h5 class="funding-ai-suggestion-title">📋 Application Readiness Check</h5>
                                <p class="funding-ai-suggestion-text">I can analyze your project against funding criteria and create a readiness score for each opportunity.</p>
                            </div>
                            <div class="funding-ai-suggestion">
                                <h5 class="funding-ai-suggestion-title">📝 Application Assistance</h5>
                                <p class="funding-ai-suggestion-text">Let me help you draft compelling project descriptions and identify key success factors for your applications.</p>
                            </div>
                            <div class="funding-ai-suggestion">
                                <h5 class="funding-ai-suggestion-title">📊 ROI Calculator</h5>
                                <p class="funding-ai-suggestion-text">Calculate potential returns on investment and project outcomes to strengthen your funding applications.</p>
                            </div>
                            <div class="funding-ai-suggestion">
                                <h5 class="funding-ai-suggestion-title">⏰ Deadline Tracker</h5>
                                <p class="funding-ai-suggestion-text">I'll monitor deadlines and send personalized reminders based on your application preparation timeline.</p>
                            </div>
                            <div class="funding-ai-suggestion">
                                <h5 class="funding-ai-suggestion-title">🎯 Smart Matching</h5>
                                <p class="funding-ai-suggestion-text">Based on your land data and project goals, I can identify the most suitable funding opportunities.</p>
                            </div>
                            <div class="funding-ai-suggestion">
                                <h5 class="funding-ai-suggestion-title">📈 Success Predictor</h5>
                                <p class="funding-ai-suggestion-text">Analyze historical data to predict your success probability and suggest improvements to your application.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI Cards Row -->
                <div class="dashboard-section kpi-section">
                    <div class="kpi-card">
                        <div class="kpi-icon"><i class="fas fa-map"></i></div>
                        <div class="kpi-content">
                            <div class="kpi-value">23.83</div>
                            <div class="kpi-label">Hectares</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon"><i class="fas fa-leaf"></i></div>
                        <div class="kpi-content">
                            <div class="kpi-value">0.72</div>
                            <div class="kpi-label">NDVI Health</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon"><i class="fas fa-coins"></i></div>
                        <div class="kpi-content">
                            <div class="kpi-value">£202,518</div>
                            <div class="kpi-label">Land Value</div>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="kpi-content">
                            <div class="kpi-value">8.2</div>
                            <div class="kpi-label">Tonnes/Ha</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="dashboard-section charts-section">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h4><i class="fas fa-chart-line"></i> NDVI Trend Analysis</h4>
                        </div>
                        <div class="chart-content">
                            <div class="chart-mock">
                                <svg viewBox="0 0 400 200" style="width: 100%; height: 200px;">
                                    <defs>
                                        <linearGradient id="ndviGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:0.3" />
                                            <stop offset="100%" style="stop-color:#4CAF50;stop-opacity:0.1" />
                                        </linearGradient>
                                    </defs>
                                    <polyline fill="none" stroke="#4CAF50" stroke-width="3" 
                                              points="20,150 60,120 100,130 140,110 180,90 220,100 260,80 300,85 340,75 380,70"/>
                                    <polygon fill="url(#ndviGradient)" 
                                             points="20,150 60,120 100,130 140,110 180,90 220,100 260,80 300,85 340,75 380,70 380,180 20,180"/>
                                    <text x="200" y="195" text-anchor="middle" style="font-size:12px;fill:#666;">2023 Growing Season</text>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h4><i class="fas fa-chart-pie"></i> Land Use Distribution</h4>
                        </div>
                        <div class="chart-content">
                            <div class="chart-mock">
                                <svg viewBox="0 0 200 200" style="width: 100%; height: 200px;">
                                    <circle cx="100" cy="100" r="80" fill="#4CAF50" stroke="white" stroke-width="2"/>
                                    <path d="M 100 100 L 100 20 A 80 80 0 0 1 164.6 64.6 Z" fill="#2196F3" stroke="white" stroke-width="2"/>
                                    <text x="70" y="120" style="font-size:12px;fill:white;font-weight:bold;">87%</text>
                                    <text x="120" y="60" style="font-size:12px;fill:white;font-weight:bold;">13%</text>
                                    <text x="100" y="195" text-anchor="middle" style="font-size:12px;fill:#666;">Grassland vs Scrub</text>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Tables Row -->
                <div class="dashboard-section tables-section">
                    <div class="table-container">
                        <div class="table-header">
                            <h4><i class="fas fa-table"></i> Soil Analysis Data</h4>
                        </div>
                        <div class="table-content">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Parameter</th>
                                        <th>Value</th>
                                        <th>Status</th>
                                        <th>Optimal Range</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>pH Level</td>
                                        <td>6.8</td>
                                        <td><span class="status-good">Good</span></td>
                                        <td>6.0 - 7.5</td>
                                    </tr>
                                    <tr>
                                        <td>Organic Matter</td>
                                        <td>3.2%</td>
                                        <td><span class="status-excellent">Excellent</span></td>
                                        <td>2.5 - 4.0%</td>
                                    </tr>
                                    <tr>
                                        <td>Nitrogen</td>
                                        <td>45 mg/kg</td>
                                        <td><span class="status-good">Good</span></td>
                                        <td>40 - 60 mg/kg</td>
                                    </tr>
                                    <tr>
                                        <td>Phosphorus</td>
                                        <td>28 mg/kg</td>
                                        <td><span class="status-moderate">Moderate</span></td>
                                        <td>30 - 50 mg/kg</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-header">
                            <h4><i class="fas fa-seedling"></i> Crop Suitability Matrix</h4>
                        </div>
                        <div class="table-content">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Crop Type</th>
                                        <th>Suitability</th>
                                        <th>Yield Potential</th>
                                        <th>Risk Level</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Winter Wheat</td>
                                        <td><span class="rating-high">8.2/10</span></td>
                                        <td>8.2 t/ha</td>
                                        <td><span class="status-good">Low</span></td>
                                    </tr>
                                    <tr>
                                        <td>Spring Barley</td>
                                        <td><span class="rating-high">8.7/10</span></td>
                                        <td>6.8 t/ha</td>
                                        <td><span class="status-good">Low</span></td>
                                    </tr>
                                    <tr>
                                        <td>Oilseed Rape</td>
                                        <td><span class="rating-medium">6.9/10</span></td>
                                        <td>3.4 t/ha</td>
                                        <td><span class="status-moderate">Medium</span></td>
                                    </tr>
                                    <tr>
                                        <td>Sugar Beet</td>
                                        <td><span class="rating-medium">7.1/10</span></td>
                                        <td>65 t/ha</td>
                                        <td><span class="status-moderate">Medium</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Risk Assessment Row -->
                <div class="dashboard-section risk-section">
                    <div class="risk-container">
                        <div class="risk-header">
                            <h4><i class="fas fa-shield-alt"></i> Risk Assessment Matrix</h4>
                        </div>
                        <div class="risk-grid">
                            <div class="risk-item risk-low">
                                <div class="risk-icon"><i class="fas fa-water"></i></div>
                                <div class="risk-content">
                                    <div class="risk-title">Flood Risk</div>
                                    <div class="risk-value">Very Low</div>
                                    <div class="risk-desc">Zone 1 - No special measures</div>
                                </div>
                            </div>
                            <div class="risk-item risk-low">
                                <div class="risk-icon"><i class="fas fa-mountain"></i></div>
                                <div class="risk-content">
                                    <div class="risk-title">Erosion Risk</div>
                                    <div class="risk-value">Low</div>
                                    <div class="risk-desc">Gentle slopes, stable soil</div>
                                </div>
                            </div>
                            <div class="risk-item risk-medium">
                                <div class="risk-icon"><i class="fas fa-bug"></i></div>
                                <div class="risk-content">
                                    <div class="risk-title">Disease Risk</div>
                                    <div class="risk-value">Medium</div>
                                    <div class="risk-desc">Monitor yellow rust</div>
                                </div>
                            </div>
                            <div class="risk-item risk-low">
                                <div class="risk-icon"><i class="fas fa-thermometer-half"></i></div>
                                <div class="risk-content">
                                    <div class="risk-title">Climate Risk</div>
                                    <div class="risk-value">Low</div>
                                    <div class="risk-desc">Resilient to 2°C warming</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Items -->
                <!-- Real-time Monitoring Section -->
                <div class="dashboard-section realtime-section">
                    <div class="realtime-container">
                        <div class="realtime-header">
                            <h4><i class="material-symbols-rounded">sensors</i> Real-time Monitoring</h4>
                            <div class="live-indicator">
                                <div class="pulse-dot"></div>
                                <span>LIVE • Last update: 2 min ago</span>
                            </div>
                        </div>
                        <div class="monitoring-grid">
                            <div class="monitor-card satellite-card">
                                <div class="monitor-header">
                                    <i class="material-symbols-rounded">satellite</i>
                                    <span>Satellite Passes Today</span>
                                    <div class="status-badge">4 scheduled</div>
                                </div>
                                <div class="satellite-list">
                                    <div class="satellite-item">
                                        <span class="sat-name">Sentinel-2</span>
                                        <span class="sat-time">14:23</span>
                                        <span class="sat-status available-soon">Available in 6h</span>
                                    </div>
                                    <div class="satellite-item">
                                        <span class="sat-name">Landsat 9</span>
                                        <span class="sat-time">16:45</span>
                                        <span class="sat-status available-soon">Available in 8h</span>
                                    </div>
                                    <div class="satellite-item">
                                        <span class="sat-name">MODIS</span>
                                        <span class="sat-time">Real-time</span>
                                        <span class="sat-status available">✅ Live</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="monitor-card alerts-card">
                                <div class="monitor-header">
                                    <i class="material-symbols-rounded">warning</i>
                                    <span>Environmental Alerts</span>
                                    <div class="alert-count">3 active</div>
                                </div>
                                <div class="alerts-list">
                                    <div class="alert-item high-priority">
                                        <i class="material-symbols-rounded">thermostat</i>
                                        <div class="alert-content">
                                            <div class="alert-title">Heat stress detected in Field B</div>
                                            <div class="alert-time">15 min ago</div>
                                        </div>
                                    </div>
                                    <div class="alert-item medium-priority">
                                        <i class="material-symbols-rounded">rainy</i>
                                        <div class="alert-content">
                                            <div class="alert-title">Heavy rain expected (90% - 18:00)</div>
                                            <div class="alert-time">1 hour ago</div>
                                        </div>
                                    </div>
                                    <div class="alert-item low-priority">
                                        <i class="material-symbols-rounded">water_drop</i>
                                        <div class="alert-content">
                                            <div class="alert-title">Soil moisture below optimal</div>
                                            <div class="alert-time">3 hours ago</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="monitor-card system-card">
                                <div class="monitor-header">
                                    <i class="material-symbols-rounded">manufacturing</i>
                                    <span>System Health</span>
                                    <div class="health-indicator good">All Systems Operational</div>
                                </div>
                                <div class="system-metrics">
                                    <div class="metric-item">
                                        <span class="metric-label">Data feeds</span>
                                        <div class="metric-status good">✅ All operational</div>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">AI processing</span>
                                        <div class="metric-status good">✅ 97% capacity</div>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">Irrigation system</span>
                                        <div class="metric-status warning">⚠️ 1 pump offline</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Assistant Section -->

                <div class="dashboard-section actions-section">
                    <div class="actions-container">
                        <div class="actions-header">
                            <h4><i class="material-symbols-rounded">checklist</i> Recommended Actions</h4>
                        </div>
                        <div class="actions-list">
                            <div class="action-item priority-high">
                                <div class="action-priority">High</div>
                                <div class="action-content">
                                    <div class="action-title">Soil Phosphorus Enhancement</div>
                                    <div class="action-desc">Apply P2O5 fertilizer to reach optimal levels</div>
                                    <div class="action-timeline">Timeline: Before spring planting</div>
                                </div>
                                <div class="action-status">Pending</div>
                            </div>
                            <div class="action-item priority-medium">
                                <div class="action-priority">Medium</div>
                                <div class="action-content">
                                    <div class="action-title">Disease Monitoring</div>
                                    <div class="action-desc">Weekly yellow rust scouting during May-June</div>
                                    <div class="action-timeline">Timeline: Growing season</div>
                                </div>
                                <div class="action-status">Planned</div>
                            </div>
                            <div class="action-item priority-low">
                                <div class="action-priority">Low</div>
                                <div class="action-content">
                                    <div class="action-title">Biodiversity Enhancement</div>
                                    <div class="action-desc">Consider wildflower margins for ELM eligibility</div>
                                    <div class="action-timeline">Timeline: Long-term</div>
                                </div>
                                <div class="action-status">Suggested</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile & Settings Panel -->
    <div class="profile-panel" id="profilePanel">
        <div class="profile-header">
            <h2 class="profile-title">
                <i class="material-symbols-rounded">account_circle</i>
                Profile & Settings
            </h2>
            <button class="profile-close" id="profileClose">
                <i class="material-symbols-rounded">close</i>
            </button>
        </div>
        <div class="profile-content">
            <div class="profile-info-section">
                <div class="profile-avatar-section">
                    <div class="profile-avatar">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiM2NzUwQTQiLz48dGV4dCB4PSI1MCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIzNiIgZmlsbD0iI0ZGRiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SlM8L3RleHQ+PC9zdmc+" alt="Profile" />
                        <button class="avatar-edit-btn">
                            <i class="material-symbols-rounded">edit</i>
                        </button>
                    </div>
                    <div class="profile-details">
                        <h3>John Smith</h3>
                        <p>john.smith@landmanagement.com</p>
                        <div class="profile-badge">Premium Plan • 847 hectares managed</div>
                    </div>
                </div>
                
                <div class="profile-organization">
                    <div class="org-item">
                        <i class="material-symbols-rounded">business</i>
                        <span>Smith Family Farms</span>
                    </div>
                    <div class="org-item">
                        <i class="material-symbols-rounded">group</i>
                        <span>5 team members active</span>
                    </div>
                    <div class="org-item">
                        <i class="material-symbols-rounded">location_on</i>
                        <span>Surrey, UK</span>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h4>Settings</h4>
                <div class="settings-grid">
                    <div class="setting-item">
                        <i class="material-symbols-rounded">palette</i>
                        <div class="setting-content">
                            <span class="setting-label">Appearance</span>
                            <select class="setting-select">
                                <option>Light</option>
                                <option>Dark</option>
                                <option selected>Auto</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <i class="material-symbols-rounded">map</i>
                        <div class="setting-content">
                            <span class="setting-label">Default Map View</span>
                            <select class="setting-select">
                                <option>OpenStreetMap</option>
                                <option selected>Satellite</option>
                                <option>Sentinel-2</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <i class="material-symbols-rounded">dashboard</i>
                        <div class="setting-content">
                            <span class="setting-label">Dashboard Layout</span>
                            <select class="setting-select">
                                <option>Basic</option>
                                <option selected>Advanced</option>
                                <option>Custom</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <i class="material-symbols-rounded">notifications</i>
                        <div class="setting-content">
                            <span class="setting-label">Notifications</span>
                            <div class="notification-toggles">
                                <label class="toggle-switch">
                                    <input type="checkbox" checked>
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-label">Email</span>
                                </label>
                                <label class="toggle-switch">
                                    <input type="checkbox" checked>
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-label">Push</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <i class="material-symbols-rounded">smartphone</i>
                        <div class="setting-content">
                            <span class="setting-label">Mobile Sync</span>
                            <label class="toggle-switch">
                                <input type="checkbox" checked>
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Enabled</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <i class="material-symbols-rounded">smart_toy</i>
                        <div class="setting-content">
                            <span class="setting-label">AI Assistance</span>
                            <select class="setting-select">
                                <option>Basic</option>
                                <option selected>Full Access</option>
                                <option>Disabled</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collaboration Panel -->
    <div class="collaboration-panel" id="collaborationPanel">
        <div class="collaboration-header">
            <h2 class="collaboration-title">
                <i class="material-symbols-rounded">group</i>
                Collaboration Center
            </h2>
            <button class="collaboration-close" id="collaborationClose">
                <i class="material-symbols-rounded">close</i>
            </button>
        </div>
        <div class="collaboration-content">
            <div class="team-section">
                <div class="team-header">
                    <h4>Team Members (5/10)</h4>
                    <button class="invite-btn">
                        <i class="material-symbols-rounded">person_add</i>
                        Invite
                    </button>
                </div>
                <div class="team-list">
                    <div class="team-member">
                        <div class="member-avatar">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyMCIgY3k9IjIwIiByPSIyMCIgZmlsbD0iIzRDQUY1MCIvPjx0ZXh0IHg9IjIwIiB5PSIyNCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjRkZGIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5TQzwvdGV4dD48L3N2Zz4=" alt="Sarah Chen" />
                            <div class="status-indicator online"></div>
                        </div>
                        <div class="member-info">
                            <div class="member-name">Sarah Chen</div>
                            <div class="member-role">Owner</div>
                        </div>
                        <div class="member-status">Online now</div>
                    </div>
                    
                    <div class="team-member">
                        <div class="member-avatar">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyMCIgY3k9IjIwIiByPSIyMCIgZmlsbD0iIzIxOTZGMyIvPjx0ZXh0IHg9IjIwIiB5PSIyNCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjRkZGIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5NSjwvdGV4dD48L3N2Zz4=" alt="Mike Johnson" />
                            <div class="status-indicator away"></div>
                        </div>
                        <div class="member-info">
                            <div class="member-name">Mike Johnson</div>
                            <div class="member-role">Editor</div>
                        </div>
                        <div class="member-status">Last seen 2h ago</div>
                    </div>
                    
                    <div class="team-member">
                        <div class="member-avatar">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyMCIgY3k9IjIwIiByPSIyMCIgZmlsbD0iI0ZGOTgwMCIvPjx0ZXh0IHg9IjIwIiB5PSIyNCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjRkZGIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5FRDwvdGV4dD48L3N2Zz4=" alt="Emma Davies" />
                            <div class="status-indicator offline"></div>
                        </div>
                        <div class="member-info">
                            <div class="member-name">Emma Davies</div>
                            <div class="member-role">Viewer</div>
                        </div>
                        <div class="member-status">Last seen yesterday</div>
                    </div>
                    
                    <div class="team-member">
                        <div class="member-avatar">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyMCIgY3k9IjIwIiByPSIyMCIgZmlsbD0iIzlDMjdCMCIvPjx0ZXh0IHg9IjIwIiB5PSIyNCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjRkZGIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5UVzwvdGV4dD48L3N2Zz4=" alt="Tom Wilson" />
                            <div class="status-indicator mobile"></div>
                        </div>
                        <div class="member-info">
                            <div class="member-name">Tom Wilson</div>
                            <div class="member-role">Field Tech</div>
                        </div>
                        <div class="member-status">Mobile • Active</div>
                    </div>
                </div>
            </div>

            <div class="invite-section">
                <h4>Invite Members</h4>
                <div class="invite-form">
                    <input type="email" placeholder="email@domain.com" class="invite-email">
                    <select class="invite-role">
                        <option>Viewer</option>
                        <option>Editor</option>
                        <option>Admin</option>
                    </select>
                    <button class="send-invite-btn">Send Invite</button>
                </div>
            </div>

            <div class="sharing-section">
                <h4>Sharing Links</h4>
                <div class="link-item">
                    <i class="material-symbols-rounded">public</i>
                    <div class="link-content">
                        <span class="link-label">Public view link</span>
                        <div class="link-url">https://app.land/abc123</div>
                    </div>
                    <button class="copy-btn">
                        <i class="material-symbols-rounded">content_copy</i>
                    </button>
                </div>
                
                <div class="link-item">
                    <i class="material-symbols-rounded">group</i>
                    <div class="link-content">
                        <span class="link-label">Team edit link</span>
                        <div class="link-url">https://app.land/edit/xyz789</div>
                    </div>
                    <button class="copy-btn">
                        <i class="material-symbols-rounded">content_copy</i>
                    </button>
                </div>
                
                <div class="link-item">
                    <i class="material-symbols-rounded">dashboard</i>
                    <div class="link-content">
                        <span class="link-label">Dashboard share</span>
                        <div class="link-url">https://app.land/dash/def456</div>
                    </div>
                    <button class="copy-btn">
                        <i class="material-symbols-rounded">content_copy</i>
                    </button>
                </div>
            </div>

            <div class="activity-section">
                <h4>Recent Activity</h4>
                <div class="activity-list">
                    <div class="activity-item">
                        <div class="activity-avatar">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxNiIgZmlsbD0iIzRDQUY1MCIvPjx0ZXh0IHg9IjE2IiB5PSIyMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjRkZGIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5TQzwvdGV4dD48L3N2Zz4=" alt="Sarah" />
                        </div>
                        <div class="activity-content">
                            <span class="activity-text">Sarah added new field boundary</span>
                            <span class="activity-time">2 min ago</span>
                        </div>
                    </div>
                    
                    <div class="activity-item">
                        <div class="activity-avatar">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxNiIgZmlsbD0iIzIxOTZGMyIvPjx0ZXh0IHg9IjE2IiB5PSIyMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjRkZGIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5NSjwvdGV4dD48L3N2Zz4=" alt="Mike" />
                        </div>
                        <div class="activity-content">
                            <span class="activity-text">Mike exported soil analysis report</span>
                            <span class="activity-time">1 hour ago</span>
                        </div>
                    </div>
                    
                    <div class="activity-item">
                        <div class="activity-avatar">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxNiIgZmlsbD0iIzlDMjdCMCIvPjx0ZXh0IHg9IjE2IiB5PSIyMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjRkZGIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5UVzwvdGV4dD48L3N2Zz4=" alt="Tom" />
                        </div>
                        <div class="activity-content">
                            <span class="activity-text">Tom uploaded field photos from mobile</span>
                            <span class="activity-time">3 hours ago</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sharing Modal -->
    <div class="modal" id="shareModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Sharing Settings</h3>
                <button class="modal-close" id="shareModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 10px;">Link to share (only accessible by collaborators)</p>
                <div class="share-link">
                    https://go.thelandapp.com/map/4f67e71750ab13976b5ba0b38
                </div>
                
                <h4 style="margin-bottom: 15px; font-size: 16px;">Current collaborators</h4>
                <div class="collaborator-list">
                    <div class="collaborator-item">
                        <div class="collaborator-avatar">TH</div>
                        <div class="collaborator-info">
                            <div class="collaborator-name">Tim Hopkin</div>
                            <div class="collaborator-email">tim.hopkin@thelandapp.com · Accredited Professional</div>
                        </div>
                        <select class="collaborator-role">
                            <option>Creator</option>
                        </select>
                    </div>
                    
                    <div class="collaborator-item">
                        <div class="collaborator-avatar">RB</div>
                        <div class="collaborator-info">
                            <div class="collaborator-name">Richard Buer</div>
                            <div class="collaborator-email">richard@farmcarbontoolkit.com</div>
                        </div>
                        <select class="collaborator-role">
                            <option>Read Only</option>
                            <option>Editor</option>
                        </select>
                        <button class="collaborator-remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Add more collaborators as needed -->
                </div>
            </div>
        </div>
    </div>

    <!-- Report Panel -->
    <div class="report-panel" id="reportPanel">
        <div class="report-header">
            <h3 style="font-size: 20px; margin-bottom: 10px;">Nature Reporting: Norney Farm</h3>
            <p style="color: #666; font-size: 14px;">Surrey - 1.25 ha</p>
            <p style="color: #4CAF50; font-weight: 600; margin-top: 10px;">Produce Type: Beef</p>
        </div>
        <div class="report-content">
            <div class="metric-card">
                <div class="metric-title">Habitat Cover</div>
                <div class="metric-value">100.00%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%;"></div>
                </div>
                <div class="metric-subtitle">83.75% (-16.35%) - Land management plan</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Connectedness</div>
                <div class="metric-value">30.91%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 30.91%;"></div>
                </div>
                <div class="metric-subtitle">27.08% (-3.91%) - Land management plan</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-title">Habitat Density & Distinctiveness Score</div>
                <div class="metric-value">0.00</div>
                <div class="metric-subtitle">Total BNG Units per hectare</div>
            </div>
            
            <div style="margin-top: 30px;">
                <h4 style="font-size: 16px; margin-bottom: 15px;">Habitat Overview</h4>
                <p style="font-size: 14px; line-height: 1.6; color: #666;">
                    This overview summarises the habitats on your farm according to your map. To help you understand how these habitats influence the metrics, we've indicated the distinctiveness of the habitat, if the habitat is considered biodiversity-positive, and if the habitat is considered productive land. This can help you identify which habitats are having the greatest impact on biodiversity and which habitats you might consider expanding or establishing in future.
                </p>
            </div>
            
            <div style="margin-top: 20px;">
                <button style="width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
                    See more <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil@0.9.3/src/leaflet.geometryutil.js"></script>
    <script>
        // ========== Global Variables ==========
        let map;
        let currentLayer = 'osm';
        let availableLayers = {};
        let activeFeatureLayers = new Map();
        let selectedPolygon = null;
        let originalPolygonStyle = null;
        let currentPlanId = 'plan-1';
        let plans = {};
        let currentFeatureData = null;
        let currentPolygonObj = null;
        let selectedPlan = null;
        let contextMenu = null;
        let planSelectionModal = null;
        
        // OSM-related global variables
        let osmResultsLayer = null;
        let queryHistory = JSON.parse(localStorage.getItem('osmQueryHistory') || '[]');
        let favoriteQueries = JSON.parse(localStorage.getItem('osmFavoriteQueries') || '[]');
        
        // ========== Notification System (Must be first) ==========
        function showLayerNotification(message, type = 'info', duration = 3000) {
            try {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                Object.assign(notification.style, {
                    position: 'fixed',
                    bottom: '24px',
                    left: '50%',
                    transform: 'translateX(-50%)',
                    background: type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#333',
                    color: 'white',
                    padding: '12px 24px',
                    borderRadius: '8px',
                    zIndex: '10000',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                    opacity: '0',
                    transition: 'all 0.3s ease'
                });
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateX(-50%) translateY(-10px)';
                }, 10);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(-50%) translateY(10px)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, duration);
                
                console.log(`Notification: ${message}`);
            } catch (error) {
                console.error('Notification error:', error);
            }
        }
        
        // ========== Critical Fix: Single Entry Point ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Land App Starting...');
            
            // Step 1: Initialize map first (most critical)
            try {
                const mapDiv = document.getElementById('map_div');
                if (!mapDiv) {
                    throw new Error('Map container not found');
                }
                
                map = L.map('map_div', { zoomControl: false }).setView([51.1867, -0.5749], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                L.control.zoom({ position: 'bottomright' }).addTo(map);
                
                console.log('✅ Map initialized');
                showLayerNotification('Map loaded successfully', 'success');
                
                // Step 2: Initialize navigation
                initializeNavigation();
                
                // Step 3: Initialize OSM functionality
                initializeOSMFunctionality();
                
                // Step 4: Initialize other features
                setTimeout(() => {
                    try {
                        // Initialize context menu and plan selection modal
                        initializeContextMenuAndPlans();
                        
                        // Initialize missing functionality
                        initializePlans();
                        initializeDrawingTools();
                        initializeLayerSelection();
                        initializeOverlaySelection();
                        initializeLearningCenterFunctionality();
                        
                        // Initialize routing last to ensure all elements are ready
                        initializeRouting();
                        
                        console.log('✅ All features initialized');
                    } catch (error) {
                        console.error('Secondary initialization error:', error);
                    }
                }, 100);
                
            } catch (error) {
                console.error('❌ Critical initialization error:', error);
                showLayerNotification('Failed to initialize app', 'error');
            }
        });
        
        // ========== URL-Based Routing System ==========
        
        function initializeRouting() {
            try {
                // Handle initial route
                handleRoute();
                
                // Listen for hash changes
                window.addEventListener('hashchange', handleRoute);
                
                console.log('✅ Routing system initialized');
            } catch (error) {
                console.error('❌ Routing initialization failed:', error);
            }
        }
        
        function handleRoute() {
            try {
                const hash = window.location.hash || '#map';
                const route = hash.substring(1); // Remove the # symbol
                
                console.log(`🔄 Navigating to route: ${route}`);
                
                switch (route) {
                    case 'map':
                        showMapView();
                        break;
                    case 'learning-centre':
                    case 'learning':
                        showLearningCentreView();
                        break;
                    default:
                        // Default to map view
                        window.location.hash = '#map';
                        showMapView();
                        break;
                }
            } catch (error) {
                console.error('❌ Route handling failed:', error);
                // Fallback to map view
                showMapView();
            }
        }
        
        function showMapView() {
            try {
                const mainContainer = document.querySelector('.main-container');
                const learningCenter = document.getElementById('learningCenter');
                
                if (mainContainer && learningCenter) {
                    // Show main interface
                    mainContainer.style.display = 'flex';
                    
                    // Hide learning center
                    learningCenter.classList.remove('active');
                    learningCenter.style.display = 'none';
                    
                    // Reset UI state
                    hideAllPanels();
                    
                    // Reset navigation
                    const navItems = document.querySelectorAll('.nav-item');
                    navItems.forEach(item => item.classList.remove('active'));
                    const mapNavItem = document.querySelector('[data-section="map"]');
                    if (mapNavItem) {
                        mapNavItem.classList.add('active');
                    }
                    
                    // Refresh map after a delay
                    if (map) {
                        setTimeout(() => {
                            map.invalidateSize();
                            console.log('✅ Map view activated and resized');
                        }, 100);
                    }
                    
                    document.title = 'Land App - Advanced Land Management Platform';
                }
            } catch (error) {
                console.error('❌ Error showing map view:', error);
            }
        }
        
        function showLearningCentreView() {
            try {
                const mainContainer = document.querySelector('.main-container');
                const learningCenter = document.getElementById('learningCenter');
                
                if (mainContainer && learningCenter) {
                    // Hide main interface
                    mainContainer.style.display = 'none';
                    
                    // Show learning center
                    learningCenter.style.display = 'block';
                    learningCenter.classList.add('active');
                    
                    console.log('✅ Learning Centre view activated');
                    document.title = 'Land App - Learning Center';
                }
            } catch (error) {
                console.error('❌ Error showing learning centre view:', error);
            }
        }
        
        // Routing initialization is now handled in the main initialization sequence above
        
        // Map initialization moved to main function above
        
        function initializeLayers() {
            try {
                // Initialize basic layers
                availableLayers = {
                    'osm': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }),
                    'satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '© Esri'
                    })
                };
                console.log('Layers initialized successfully');
            } catch (error) {
                console.error('Layer initialization failed:', error);
            }
        }
        
        function initializeNavigation() {
            try {
                // Navigation items
                const navItems = document.querySelectorAll('.nav-item');
                const learningBtn = document.getElementById('learningBtn');
                
                // Handle navigation item clicks
                navItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const section = this.dataset.section;
                        console.log('Navigation clicked:', section);
                        
                        // Remove active class from all items
                        navItems.forEach(nav => nav.classList.remove('active'));
                        
                        // Add active class to clicked item
                        this.classList.add('active');
                        
                        // Handle different sections
                        handleNavigation(section);
                    });
                });
                
                // Handle learning center button
                if (learningBtn) {
                    learningBtn.addEventListener('click', function() {
                        window.location.hash = '#learning-centre';
                    });
                }
                
                // Handle learning center close button
                const learningCloseBtn = document.getElementById('learningCloseBtn');
                if (learningCloseBtn) {
                    learningCloseBtn.addEventListener('click', function() {
                        window.location.hash = '#map';
                    });
                }
                
                console.log('Navigation initialized successfully');
            } catch (error) {
                console.error('Navigation initialization failed:', error);
            }
        }
        
        function handleNavigation(section) {
            try {
                // Hide all panels first
                hideAllPanels();
                
                switch(section) {
                    case 'map':
                        showLayerNotification('Map view activated', 'success');
                        break;
                    case 'analytics':
                        const analysisPanel = document.getElementById('analysisPanel');
                        if (analysisPanel) analysisPanel.classList.add('visible');
                        showLayerNotification('Analytics panel opened', 'success');
                        break;
                    case 'satellite':
                        // Switch to satellite layer
                        if (window.currentLayerKey !== 'satellite') {
                            // Trigger satellite layer selection
                            const satelliteOption = document.querySelector('[data-layer="satellite"]');
                            if (satelliteOption) {
                                satelliteOption.click();
                            }
                        }
                        showLayerNotification('Satellite view activated', 'success');
                        break;
                    case 'agriculture':
                        showLayerNotification('Agriculture analysis coming soon', 'info');
                        break;
                    case 'water':
                        showLayerNotification('Water management tools coming soon', 'info');
                        break;
                    case 'osm':
                        showOSMPanel();
                        break;
                    case 'climate':
                        showLayerNotification('Climate data tools coming soon', 'info');
                        break;
                    case 'field':
                        showLayerNotification('Field management tools coming soon', 'info');
                        break;
                    case 'funding':
                        showLayerNotification('Funding information coming soon', 'info');
                        break;
                    case 'profile':
                        const profileSection = document.getElementById('profileSection');
                        if (profileSection) {
                            profileSection.classList.add('active');
                            showLayerNotification('Profile section opened', 'success');
                        }
                        break;
                    case 'collaboration':
                        const collaborationPanel = document.getElementById('collaborationPanel');
                        if (collaborationPanel) collaborationPanel.classList.add('visible');
                        showLayerNotification('Collaboration panel opened', 'success');
                        break;
                    case 'settings':
                        const settingsPanel = document.getElementById('settingsPanel');
                        if (settingsPanel) settingsPanel.classList.add('visible');
                        showLayerNotification('Settings panel opened', 'success');
                        break;
                    default:
                        console.log('Unknown section:', section);
                        showLayerNotification(`${section} feature coming soon`, 'info');
                }
            } catch (error) {
                console.error('Navigation error:', error);
                showLayerNotification('Navigation failed', 'error');
            }
        }
        
        function hideAllPanels() {
            try {
                const panels = [
                    'osmPanel', 'collaborationPanel', 'analysisPanel', 
                    'settingsPanel', 'polygonInfoPanel', 'profileSection'
                ];
                
                panels.forEach(panelId => {
                    const panel = document.getElementById(panelId);
                    if (panel) {
                        panel.classList.remove('visible');
                        panel.classList.remove('active'); // Also remove active class
                    }
                });
            } catch (error) {
                console.error('Error hiding panels:', error);
            }
        }
        
        function showOSMPanel() {
            try {
                const osmPanel = document.getElementById('osmPanel');
                if (osmPanel) {
                    osmPanel.classList.add('visible');
                    showLayerNotification('OSM Data panel opened');
                } else {
                    console.error('OSM panel not found');
                }
            } catch (error) {
                console.error('Error showing OSM panel:', error);
            }
        }
        
        // Old Learning Centre functions removed - now using URL-based routing system
        
        function initializeDrawingTools() {
            try {
                // Initialize the FeatureGroup to store editable layers if not already created
                if (typeof window.editableLayers === 'undefined') {
                    window.editableLayers = new L.FeatureGroup();
                    map.addLayer(window.editableLayers);
                }
                
                // Drawing tool event listeners
                const drawPointBtn = document.getElementById('drawPoint');
                const drawPolygonBtn = document.getElementById('drawPolygon');
                const drawRectangleBtn = document.getElementById('drawRectangle');
                const drawCircleBtn = document.getElementById('drawCircle');
                const measureToolBtn = document.getElementById('measureTool');
                const editToolBtn = document.getElementById('editTool');
                const deleteToolBtn = document.getElementById('deleteTool');
                
                if (drawPointBtn) {
                    drawPointBtn.addEventListener('click', function() {
                        setActiveDrawingTool('drawPoint');
                        isDrawing = true;
                        map.getContainer().style.cursor = 'crosshair';
                        map.on('click', onMapClick);
                    });
                }
                
                if (drawPolygonBtn) {
                    drawPolygonBtn.addEventListener('click', function() {
                        setActiveDrawingTool('drawPolygon');
                        const polygon = new L.Draw.Polygon(map, {
                            shapeOptions: {
                                color: '#4CAF50',
                                fillOpacity: 0.5
                            }
                        });
                        polygon.enable();
                    });
                }
                
                if (drawRectangleBtn) {
                    drawRectangleBtn.addEventListener('click', function() {
                        setActiveDrawingTool('drawRectangle');
                        const rectangle = new L.Draw.Rectangle(map, {
                            shapeOptions: {
                                color: '#2196F3',
                                fillOpacity: 0.5
                            }
                        });
                        rectangle.enable();
                    });
                }
                
                if (drawCircleBtn) {
                    drawCircleBtn.addEventListener('click', function() {
                        setActiveDrawingTool('drawCircle');
                        const circle = new L.Draw.Circle(map, {
                            shapeOptions: {
                                color: '#FF9800',
                                fillOpacity: 0.5
                            }
                        });
                        circle.enable();
                    });
                }
                
                if (measureToolBtn) {
                    measureToolBtn.addEventListener('click', function() {
                        setActiveDrawingTool('measureTool');
                        const polyline = new L.Draw.Polyline(map, {
                            shapeOptions: {
                                color: '#9C27B0',
                                weight: 3
                            }
                        });
                        polyline.enable();
                    });
                }
                
                if (editToolBtn) {
                    editToolBtn.addEventListener('click', function() {
                        setActiveDrawingTool('editTool');
                        // Enable editing mode for existing shapes
                        if (window.editableLayers) {
                            window.editableLayers.eachLayer(function(layer) {
                                if (layer.editing) {
                                    layer.editing.enable();
                                }
                            });
                        }
                    });
                }
                
                if (deleteToolBtn) {
                    deleteToolBtn.addEventListener('click', function() {
                        setActiveDrawingTool('deleteTool');
                        map.getContainer().style.cursor = 'crosshair';
                        showLayerNotification('Click on a shape to delete it', 'info');
                    });
                }
                
                // Set up map event handlers for drawing
                map.on(L.Draw.Event.CREATED, function(event) {
                    const layer = event.layer;
                    const type = event.layerType;
                    
                    // Add to editable layers
                    if (window.editableLayers) {
                        window.editableLayers.addLayer(layer);
                    }
                    
                    // Calculate area/length based on shape type
                    let area = 0;
                    let perimeter = 0;
                    let radius = 0;
                    
                    if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
                        // Calculate area for polygons and rectangles
                        const latLngs = layer.getLatLngs()[0];
                        area = L.GeometryUtil && L.GeometryUtil.geodesicArea ? 
                               L.GeometryUtil.geodesicArea(latLngs) : 
                               Math.abs(latLngs.reduce((sum, point, i) => {
                                   const next = latLngs[(i + 1) % latLngs.length];
                                   return sum + (point.lng * next.lat - next.lng * point.lat);
                               }, 0)) * 111320 * 111320 / 2;
                    } else if (layer instanceof L.Circle) {
                        radius = layer.getRadius();
                        area = Math.PI * radius * radius;
                    }
                    
                    // Create feature data object
                    const featureData = {
                        id: 'feature_' + Date.now(),
                        name: `${type.charAt(0).toUpperCase() + type.slice(1)} ${Date.now()}`,
                        type: type,
                        layer: layer,
                        properties: {
                            area: area,
                            perimeter: perimeter,
                            radius: radius,
                            planId: currentPlanId,
                            created: new Date().toISOString()
                        }
                    };
                    
                    // Add context menu to the layer
                    layer.on('contextmenu', function(e) {
                        e.originalEvent.preventDefault();
                        showContextMenu(e.originalEvent.clientX, e.originalEvent.clientY, featureData);
                    });
                    
                    // Add click event for basic info
                    layer.on('click', function(e) {
                        showLayerNotification(`${featureData.name} - Area: ${(area/10000).toFixed(2)} hectares`);
                    });
                    
                    // Add to current plan
                    if (plans[currentPlanId]) {
                        plans[currentPlanId].layers.addLayer(layer);
                        plans[currentPlanId].features.push(featureData);
                    }
                    
                    showLayerNotification(`${type} added to plan`, 'success');
                    setActiveDrawingTool(null);
                });
                
                console.log('✅ Drawing tools initialized');
            } catch (error) {
                console.error('Drawing tools initialization failed:', error);
            }
        }
        
        function initializePlans() {
            try {
                // Initialize first plan
                plans[currentPlanId] = {
                    id: currentPlanId,
                    name: 'Boundary',
                    layers: new L.FeatureGroup(),
                    features: []
                };
                
                if (map) {
                    map.addLayer(plans[currentPlanId].layers);
                    
                    // Create sample parcels with error handling
                    try {
                        const woodlandParcel = L.polygon([
                            [51.1875, -0.5765],
                            [51.1880, -0.5745],
                            [51.1870, -0.5740],
                            [51.1865, -0.5755]
                        ], {
                            color: '#4CAF50',
                            fillColor: '#4CAF50',
                            fillOpacity: 0.6,
                            weight: 2
                        }).addTo(map);
                        
                        const grasslandParcel = L.polygon([
                            [51.1860, -0.5760],
                            [51.1865, -0.5735],
                            [51.1855, -0.5730],
                            [51.1850, -0.5750]
                        ], {
                            color: '#2196F3',
                            fillColor: '#2196F3',
                            fillOpacity: 0.6,
                            weight: 2
                        }).addTo(map);
                    } catch (parcelError) {
                        console.warn('Could not create sample parcels:', parcelError);
                    }
                }
                
                console.log('Plans initialized successfully');
            } catch (error) {
                console.error('Plans initialization failed:', error);
            }
        }
        
        function initializeOSMFunctionality() {
            try {
                // OSM panel close button
                const osmPanelClose = document.getElementById('osmPanelClose');
                if (osmPanelClose) {
                    osmPanelClose.addEventListener('click', function() {
                        const osmPanel = document.getElementById('osmPanel');
                        if (osmPanel) {
                            osmPanel.classList.remove('visible');
                            showLayerNotification('OSM panel closed');
                        }
                    });
                }
                
                // Feature toggles
                const toggles = document.querySelectorAll('[data-feature]');
                toggles.forEach(toggle => {
                    toggle.addEventListener('change', function() {
                        const featureType = this.dataset.feature;
                        const isChecked = this.checked;
                        const label = this.parentElement.querySelector('.feature-label').textContent;
                        
                        if (isChecked) {
                            loadFeatureData(featureType, label);
                        } else {
                            removeFeatureData(featureType, label);
                        }
                    });
                });
                
                console.log('OSM functionality initialized successfully');
            } catch (error) {
                console.error('OSM functionality initialization failed:', error);
            }
        }
        
        // Notification system - MOVED TO TOP
        
        // Define tile layers
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        });

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        // Sentinel-2 True Color (RGB) - Using Sentinel Hub
        const sentinel2Layer = L.tileLayer('https://services.sentinel-hub.com/ogc/wms/{instanceId}?SERVICE=WMS&REQUEST=GetMap&LAYERS=TRUE_COLOR&STYLES=&FORMAT=image%2Fpng&TRANSPARENT=true&VERSION=1.1.1&WIDTH=256&HEIGHT=256&SRS=EPSG%3A3857&BBOX={bbox-epsg-3857}', {
            attribution: '© Sentinel Hub, ESA',
            tileSize: 256,
            // Note: This would need a real instanceId from Sentinel Hub
            instanceId: 'your-instance-id-here'
        });

        // NDVI Layer - Using Sentinel Hub NDVI visualization
        const ndviLayer = L.tileLayer('https://services.sentinel-hub.com/ogc/wms/{instanceId}?SERVICE=WMS&REQUEST=GetMap&LAYERS=NDVI&STYLES=&FORMAT=image%2Fpng&TRANSPARENT=true&VERSION=1.1.1&WIDTH=256&HEIGHT=256&SRS=EPSG%3A3857&BBOX={bbox-epsg-3857}', {
            attribution: '© Sentinel Hub, ESA - NDVI Analysis',
            tileSize: 256,
            instanceId: 'your-instance-id-here'
        });

        // Alternative: Using Planet Labs or other providers for demo
        const sentinel2DemoLayer = L.tileLayer('https://tiles.planet.com/basemaps/v1/planet-tiles/global_monthly_2023_12_mosaic/gmap/{z}/{x}/{y}.png?api_key=demo', {
            attribution: '© Planet Labs (Demo) - Sentinel-2 Imagery',
            maxZoom: 18
        });

        const ndviDemoLayer = L.tileLayer('https://tiles.sentinel-hub.com/v1/wms/{instanceId}?SERVICE=WMS&REQUEST=GetMap&LAYERS=NDVI&STYLES=&FORMAT=image%2Fpng&TRANSPARENT=true&VERSION=1.1.1&WIDTH=256&HEIGHT=256&SRS=EPSG%3A3857&BBOX={bbox-epsg-3857}', {
            attribution: '© ESA Sentinel-2 NDVI',
            opacity: 0.8
        });

        // Define overlay layers - verified working global datasets
        const overlayLayers = {
            // Climate & Weather - WORKING URLs
            'precipitation': L.tileLayer('https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=439d4b804bc8187953eb36d2a8c26a02', {
                attribution: '© OpenWeatherMap',
                opacity: 0.6
            }),
            'temperature': L.tileLayer('https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=439d4b804bc8187953eb36d2a8c26a02', {
                attribution: '© OpenWeatherMap Temperature',
                opacity: 0.6
            }),
            'wind': L.tileLayer('https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=439d4b804bc8187953eb36d2a8c26a02', {
                attribution: '© OpenWeatherMap Wind',
                opacity: 0.5
            }),

            // Vegetation & Agriculture - WORKING URLs
            'ndvi': L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_NDVI_8Day/default/{time}/{tilematrixset}{max_zoom}/{z}/{y}/{x}.png', {
                attribution: '© NASA GIBS, MODIS Terra NDVI',
                opacity: 0.7,
                time: '2024-01-01',
                tilematrixset: 'GoogleMapsCompatible_Level9',
                max_zoom: ''
            }),
            'cropland': L.tileLayer('https://storage.googleapis.com/global-surface-water/tiles2020/occurrence/{z}/{x}/{y}.png', {
                attribution: '© European Commission, JRC Global Surface Water',
                opacity: 0.6
            }),
            'forest': L.tileLayer('https://storage.googleapis.com/earthenginepartners-hansen/tiles/hansen_world/v1/2020_treecover/{z}/{x}/{y}.png', {
                attribution: '© Hansen/UMD/Google/USGS/NASA Tree Cover',
                opacity: 0.6
            }),

            // Water Resources - WORKING URLs
            'surface-water': L.tileLayer('https://storage.googleapis.com/global-surface-water/tiles2020/occurrence/{z}/{x}/{y}.png', {
                attribution: '© European Commission, JRC Global Surface Water',
                opacity: 0.7
            }),
            'flood-risk': L.tileLayer('https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=439d4b804bc8187953eb36d2a8c26a02', {
                attribution: '© OpenWeatherMap Clouds (Flood Risk Proxy)',
                opacity: 0.4
            }),

            // Environmental - WORKING URLs
            'air-quality': L.tileLayer('https://tiles.aqicn.org/tiles/usepa-aqi/{z}/{x}/{y}.png?token=demo', {
                attribution: '© World Air Quality Index Project',
                opacity: 0.6
            }),
            'fires': L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Aqua_Thermal_Anomalies_All/default/{time}/{tilematrixset}{max_zoom}/{z}/{y}/{x}.png', {
                attribution: '© NASA GIBS, MODIS Active Fires',
                opacity: 0.8,
                time: '2024-01-01',
                tilematrixset: 'GoogleMapsCompatible_Level9',
                max_zoom: ''
            }),
            'lights': L.tileLayer('https://map1.vis.earthdata.nasa.gov/wmts-geo/wmts.cgi?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=VIIRS_SNPP_DayNightBand_ENCC&STYLE=default&TILEMATRIXSET=EPSG4326_250m&FORMAT=image%2Fjpeg&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}', {
                attribution: '© NASA VIIRS Nighttime Lights',
                opacity: 0.7
            }),

            // Terrain & Land Use - WORKING URLs
            'elevation': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri World Shaded Relief',
                opacity: 0.5
            }),
            'slope': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri World Terrain',
                opacity: 0.6
            }),
            'landcover': L.tileLayer('https://services.arcgisonline.com/arcgis/rest/services/Specialty/World_Navigation_Charts/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri Land Cover',
                opacity: 0.5
            }),

            // Population & Infrastructure - WORKING URLs  
            'population': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Demographics/USA_Population_Density/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri Population Density',
                opacity: 0.6
            }),
            'roads': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap Roads',
                opacity: 0.3,
                className: 'roads-overlay'
            })
        };

        // Track active overlays
        const activeOverlays = {};
        
        // Global overlay opacity setting
        let globalOverlayOpacity = 0.7;

        // Layer management
        const layers = {
            'osm': { layer: osmLayer, name: 'OpenStreetMap', icon: 'fa-map' },
            'satellite': { layer: satelliteLayer, name: 'Satellite', icon: 'fa-satellite' },
            'sentinel2': { layer: sentinel2DemoLayer, name: 'Sentinel-2', icon: 'fa-satellite-dish' },
            'ndvi': { layer: ndviDemoLayer, name: 'NDVI', icon: 'fa-leaf' }
        };

        let currentLayerKey = 'osm';
        // REMOVED: layers[currentLayerKey].layer.addTo(map); // This causes error - moved to initializeLayerSelection()
        
        // REMOVED: Set initial active state - now handled in initializeLayerSelection()
        /*
        setTimeout(() => {
            const defaultOption = document.querySelector(`[data-layer="${currentLayerKey}"]`);
            if (defaultOption) {
                defaultOption.classList.add('active');
            }
        }, 100);
        */

        // REMOVED: editableLayers initialization - now handled in initializeDrawingTools()
        /*
        const editableLayers = new L.FeatureGroup();
        map.addLayer(editableLayers);
        */

        // Drawing state variables
        let currentDrawingMode = null;
        let isDrawing = false;
        let measureControl = null;

        // Plan management - variables moved to global section
        // let plans = {}; // REMOVED DUPLICATE
        // let currentPlanId = 'plan-1'; // REMOVED DUPLICATE  
        let planCounter = 1;

        // REMOVED: Plan initialization - now handled in initializePlans()
        /*
        plans[currentPlanId] = {
            id: currentPlanId,
            name: 'Boundary',
            layers: new L.FeatureGroup(),
            features: []
        };
        map.addLayer(plans[currentPlanId].layers);
        */

        // REMOVED: Create sample parcels - now handled in initializePlans()
        /*
        const woodlandParcel = L.polygon([
            [51.1875, -0.5765],
            [51.1880, -0.5745],
            [51.1870, -0.5740],
            [51.1865, -0.5755]
        ], {
            color: '#4CAF50',
            fillColor: '#4CAF50',
            fillOpacity: 0.6,
            weight: 2
        }).addTo(map);

        const grasslandParcel = L.polygon([
            [51.1860, -0.5760],
            [51.1865, -0.5735],
            [51.1855, -0.5730],
            [51.1850, -0.5750]
        ], {
            color: '#2196F3',
            fillColor: '#2196F3',
            fillOpacity: 0.5,
            weight: 2
        }).addTo(map);

        // Add cross-hatch pattern for buffer zone
        const bufferZone = L.polygon([
            [51.1870, -0.5755],
            [51.1872, -0.5748],
            [51.1868, -0.5745],
            [51.1866, -0.5752]
        ], {
            color: '#4CAF50',
            fillColor: '#4CAF50',
            fillOpacity: 0.3,
            weight: 2,
            dashArray: '5, 5'
        }).addTo(map);
        */
        // END REMOVED SAMPLE PARCELS SECTION

        // Drawing tool functions
        function setActiveDrawingTool(toolId) {
            // Remove active class from all tools
            document.querySelectorAll('.drawing-tool').forEach(t => t.classList.remove('active'));
            
            // Stop any current drawing
            stopDrawing();
            
            // Set new active tool
            if (toolId) {
                document.getElementById(toolId).classList.add('active');
                currentDrawingMode = toolId;
            } else {
                currentDrawingMode = null;
            }
        }

        function stopDrawing() {
            isDrawing = false;
            map.off('click', onMapClick);
            map.getContainer().style.cursor = '';
        }

        function addFeatureToPlan(layer, type, data) {
            const currentPlan = plans[currentPlanId];
            currentPlan.layers.addLayer(layer);
            
            const feature = {
                layer: layer,
                type: type,
                data: data,
                id: Date.now(),
                name: generateFeatureName(type, currentPlan.features.length + 1)
            };
            
            currentPlan.features.push(feature);
            
            // Add right-click context menu for polygons, rectangles, and circles
            if (type === 'polygon' || type === 'rectangle' || type === 'circle') {
                addContextMenuToLayer(layer, feature);
            }
            
            updatePlanDisplay();
        }

        // Context menu variables
        let currentContextFeature = null;

        function addContextMenuToLayer(layer, feature) {
            layer.on('contextmenu', function(e) {
                e.originalEvent.preventDefault();
                showContextMenu(e.originalEvent.clientX, e.originalEvent.clientY, feature);
            });
        }

        function showContextMenu(x, y, feature) {
            const contextMenu = document.getElementById('contextMenu');
            currentContextFeature = feature;
            
            contextMenu.style.display = 'block';
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            
            // Position menu within viewport
            const rect = contextMenu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                contextMenu.style.left = (x - rect.width) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                contextMenu.style.top = (y - rect.height) + 'px';
            }
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            currentContextFeature = null;
        }

        function generateFeatureName(type, index) {
            const typeNames = {
                'point': 'Point',
                'polygon': 'Polygon',
                'rectangle': 'Rectangle',
                'circle': 'Circle',
                'measurement': 'Measurement'
            };
            return `${typeNames[type] || 'Feature'} ${index}`;
        }

        function updatePlanDisplay() {
            const currentPlan = plans[currentPlanId];
            const planContainer = document.querySelector(`[data-plan-id="${currentPlanId}"]`);
            
            // Update count
            const countElement = planContainer.querySelector('.sidebar-item-count');
            if (countElement) {
                countElement.textContent = currentPlan.features.length;
            }
            
            // Update features list
            updateFeaturesList(currentPlanId);
        }

        function updateFeaturesList(planId) {
            const plan = plans[planId];
            const planContainer = document.querySelector(`[data-plan-id="${planId}"]`);
            const featuresContainer = planContainer.querySelector('.plan-features');
            
            // Clear existing features
            featuresContainer.innerHTML = '';
            
            // Add each feature
            plan.features.forEach(feature => {
                const featureElement = createFeatureElement(feature);
                featuresContainer.appendChild(featureElement);
            });
        }

        function createFeatureElement(feature) {
            const featureElement = document.createElement('div');
            featureElement.className = 'feature-item';
            featureElement.setAttribute('data-feature-id', feature.id);
            
            const iconClass = getFeatureIcon(feature.type);
            const info = getFeatureInfo(feature);
            
            featureElement.innerHTML = `
                <i class="fas ${iconClass} feature-icon"></i>
                <span class="feature-name">${feature.name}</span>
                <span class="feature-info">${info}</span>
            `;
            
            // Add click handler to select feature
            featureElement.addEventListener('click', () => selectFeature(feature));
            
            return featureElement;
        }

        function getFeatureIcon(type) {
            const icons = {
                'point': 'fa-map-pin',
                'polygon': 'fa-draw-polygon',
                'rectangle': 'fa-vector-square',
                'circle': 'fa-circle',
                'measurement': 'fa-ruler'
            };
            return icons[type] || 'fa-map-marker';
        }

        function getFeatureInfo(feature) {
            switch (feature.type) {
                case 'polygon':
                case 'rectangle':
                    return `${(feature.data.area / 10000).toFixed(2)} ha`;
                case 'circle':
                    return `${feature.data.radius.toFixed(0)}m`;
                case 'measurement':
                    return `${(feature.data.distance / 1000).toFixed(2)} km`;
                case 'point':
                    return `${feature.data.coordinates[0].toFixed(4)}, ${feature.data.coordinates[1].toFixed(4)}`;
                default:
                    return '';
            }
        }

        function selectFeature(feature) {
            // Clear previous selections
            document.querySelectorAll('.feature-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select current feature
            const featureElement = document.querySelector(`[data-feature-id="${feature.id}"]`);
            if (featureElement) {
                featureElement.classList.add('selected');
            }
            
            // Focus map on feature
            const layer = feature.layer;
            if (layer.getBounds) {
                map.fitBounds(layer.getBounds(), { padding: [20, 20] });
            } else if (layer.getLatLng) {
                map.setView(layer.getLatLng(), 16);
            }
            
            // Open popup if available
            if (layer.getPopup) {
                layer.openPopup();
            }
        }

        function onMapClick(e) {
            if (!currentDrawingMode || !isDrawing) return;

            const latlng = e.latlng;

            switch (currentDrawingMode) {
                case 'drawPoint':
                    const marker = L.marker(latlng, {
                        icon: L.divIcon({
                            className: 'custom-pin',
                            html: '<i class="fas fa-map-pin" style="color: #4CAF50; font-size: 24px;"></i>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 24]
                        })
                    });
                    
                    addFeatureToPlan(marker, 'point', { coordinates: [latlng.lat, latlng.lng] });
                    marker.bindPopup(`<b>Point</b><br>Plan: ${plans[currentPlanId].name}<br>Lat: ${latlng.lat.toFixed(6)}<br>Lng: ${latlng.lng.toFixed(6)}`);
                    setActiveDrawingTool(null);
                    break;
            }
        }

        // REMOVED: Drawing tool event listeners now handled in initializeDrawingTools()
        
        // START DUPLICATE SECTION TO REMOVE
        /*
        document.getElementById('drawPolygon').addEventListener('click', function() {
            setActiveDrawingTool('drawPolygon');
            const polygon = new L.Draw.Polygon(map, {
                shapeOptions: {
                    color: '#4CAF50',
                    fillOpacity: 0.5
                }
            });
            polygon.enable();
        });

        document.getElementById('drawRectangle').addEventListener('click', function() {
            setActiveDrawingTool('drawRectangle');
            const rectangle = new L.Draw.Rectangle(map, {
                shapeOptions: {
                    color: '#2196F3',
                    fillOpacity: 0.5
                }
            });
            rectangle.enable();
        });

        document.getElementById('drawCircle').addEventListener('click', function() {
            setActiveDrawingTool('drawCircle');
            const circle = new L.Draw.Circle(map, {
                shapeOptions: {
                    color: '#FF9800',
                    fillOpacity: 0.5
                }
            });
            circle.enable();
        });

        document.getElementById('measureTool').addEventListener('click', function() {
            setActiveDrawingTool('measureTool');
            const polyline = new L.Draw.Polyline(map, {
                shapeOptions: {
                    color: '#FF5722',
                    weight: 3,
                    dashArray: '10,10'
                }
            });
            polyline.enable();
        });

        document.getElementById('deleteTool').addEventListener('click', function() {
            setActiveDrawingTool('deleteTool');
            map.getContainer().style.cursor = 'pointer';
            
            // Add click handler to delete features from current plan
            const currentPlan = plans[currentPlanId];
            currentPlan.layers.eachLayer(function(layer) {
                layer.on('click', function() {
                    if (currentDrawingMode === 'deleteTool') {
                        // Remove from plan layers
                        currentPlan.layers.removeLayer(layer);
                        
                        // Remove from features array
                        currentPlan.features = currentPlan.features.filter(feature => feature.layer !== layer);
                        
                        // Update display
                        updatePlanDisplay();
                        
                        setActiveDrawingTool(null);
                    }
                });
            });
        });

        // Handle draw events
        map.on(L.Draw.Event.CREATED, function (e) {
            const layer = e.layer;
            const planName = plans[currentPlanId].name;
            
            // Add popup with area/length info and plan name
            if (layer instanceof L.Polygon) {
                const area = L.GeometryUtil.geodesicArea ? L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) : 0;
                addFeatureToPlan(layer, 'polygon', { area: area });
                layer.bindPopup(`<b>Polygon</b><br>Plan: ${planName}<br>Area: ${(area / 10000).toFixed(2)} hectares`);
            } else if (layer instanceof L.Rectangle) {
                const bounds = layer.getBounds();
                const area = L.GeometryUtil.geodesicArea ? L.GeometryUtil.geodesicArea([
                    bounds.getNorthWest(),
                    bounds.getNorthEast(), 
                    bounds.getSouthEast(),
                    bounds.getSouthWest()
                ]) : 0;
                addFeatureToPlan(layer, 'rectangle', { area: area });
                layer.bindPopup(`<b>Rectangle</b><br>Plan: ${planName}<br>Area: ${(area / 10000).toFixed(2)} hectares`);
            } else if (layer instanceof L.Circle) {
                const radius = layer.getRadius();
                const area = Math.PI * radius * radius;
                addFeatureToPlan(layer, 'circle', { radius: radius, area: area });
                layer.bindPopup(`<b>Circle</b><br>Plan: ${planName}<br>Radius: ${radius.toFixed(2)}m<br>Area: ${(area / 10000).toFixed(2)} hectares`);
            } else if (layer instanceof L.Polyline) {
                let totalDistance = 0;
                const latlngs = layer.getLatLngs();
                for (let i = 0; i < latlngs.length - 1; i++) {
                    totalDistance += latlngs[i].distanceTo(latlngs[i + 1]);
                }
                addFeatureToPlan(layer, 'measurement', { distance: totalDistance });
                layer.bindPopup(`<b>Measurement</b><br>Plan: ${planName}<br>Distance: ${(totalDistance / 1000).toFixed(2)} km`);
            }
            
            setActiveDrawingTool(null);
        });
        */
        // END DUPLICATE SECTION - NOW REMOVED

        // Handle new plan button
        document.getElementById('newPlanBtn').addEventListener('click', function() {
            createNewPlan();
        });

        function createNewPlan() {
            planCounter++;
            const newPlanId = `plan-${planCounter}`;
            
            // Create new plan object
            plans[newPlanId] = {
                id: newPlanId,
                name: `New Plan ${planCounter}`,
                layers: new L.FeatureGroup(),
                features: []
            };
            
            // Add new plan layer to map
            map.addLayer(plans[newPlanId].layers);
            
            // Create new sidebar item
            const newPlanContainer = document.createElement('div');
            newPlanContainer.className = 'plan-container';
            newPlanContainer.setAttribute('data-plan-id', newPlanId);
            newPlanContainer.innerHTML = `
                <div class="sidebar-item">
                    <i class="fas fa-chevron-right plan-chevron"></i>
                    <i class="fas fa-map-marked-alt"></i>
                    <span class="sidebar-item-text" contenteditable="true">New Plan ${planCounter}</span>
                    <span class="sidebar-item-count">0</span>
                </div>
                <div class="plan-features">
                    <!-- Features will be dynamically added here -->
                </div>
            `;
            
            // Insert after the last plan container
            const lastPlanContainer = document.querySelector('.plan-container:last-of-type');
            if (lastPlanContainer) {
                lastPlanContainer.parentNode.insertBefore(newPlanContainer, lastPlanContainer.nextSibling);
            } else {
                const sidebarHeader = document.querySelector('.sidebar-header');
                sidebarHeader.parentNode.insertBefore(newPlanContainer, sidebarHeader.nextSibling);
            }
            
            // Switch to new plan
            switchToPlan(newPlanId);
        }

        function switchToPlan(planId) {
            // Hide all plan layers
            Object.values(plans).forEach(plan => {
                map.removeLayer(plan.layers);
            });
            
            // Show selected plan layers
            map.addLayer(plans[planId].layers);
            
            // Update UI
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-plan-id="${planId}"] .sidebar-item`).classList.add('active');
            
            // Update current plan
            currentPlanId = planId;
            
            // Clear feature selections
            document.querySelectorAll('.feature-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        // Handle plan name editing
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('sidebar-item-text')) {
                const planElement = e.target.closest('.sidebar-item');
                const planId = planElement.getAttribute('data-plan-id');
                if (plans[planId]) {
                    plans[planId].name = e.target.textContent;
                }
            }
        });

        // Handle chevron clicks for expanding/collapsing and hide context menu on clicks
        document.addEventListener('click', function(e) {
            // Hide context menu when clicking elsewhere
            if (!e.target.closest('#contextMenu')) {
                hideContextMenu();
            }
            
            if (e.target.classList.contains('plan-chevron')) {
                e.stopPropagation();
                const planContainer = e.target.closest('.plan-container');
                const featuresContainer = planContainer.querySelector('.plan-features');
                const chevron = e.target;
                
                if (featuresContainer.classList.contains('expanded')) {
                    // Collapse
                    featuresContainer.classList.remove('expanded');
                    chevron.classList.remove('expanded');
                } else {
                    // Expand
                    featuresContainer.classList.add('expanded');
                    chevron.classList.add('expanded');
                }
            }
        });

        // Context menu event handlers
        document.getElementById('contextReport').addEventListener('click', function() {
            if (currentContextFeature) {
                generatePolygonReport(currentContextFeature);
                hideContextMenu();
            }
        });

        document.getElementById('contextEdit').addEventListener('click', function() {
            if (currentContextFeature) {
                // Placeholder for edit functionality
                alert('Edit functionality coming soon!');
                hideContextMenu();
            }
        });

        document.getElementById('contextDelete').addEventListener('click', function() {
            if (currentContextFeature) {
                deleteFeature(currentContextFeature);
                hideContextMenu();
            }
        });

        // Analysis panel handlers
        document.getElementById('analysisPanelClose').addEventListener('click', function() {
            const analysisPanel = document.getElementById('analysisPanel');
            const dashboardPanel = document.getElementById('dashboardPanel');
            const mapControls = document.querySelector('.map-controls');
            
            analysisPanel.classList.remove('visible');
            dashboardPanel.classList.remove('visible');
            
            // Map controls stay in bottom-left position
        });

        // Handle dashboard toggle
        document.getElementById('dashboardToggle').addEventListener('click', function() {
            const dashboardPanel = document.getElementById('dashboardPanel');
            const analysisPanel = document.getElementById('analysisPanel');
            const mapControls = document.querySelector('.map-controls');
            
            // Hide analysis panel and show dashboard (keeping map visible)
            analysisPanel.classList.remove('visible');
            dashboardPanel.classList.add('visible');
            
            // Map controls stay in bottom-left position
            
            // Show notification
            showLayerNotification('Dashboard view activated');
            
            console.log('Dashboard opened successfully');
        });

        // Handle dashboard minimize (back to report)
        document.getElementById('dashboardMinimize').addEventListener('click', function() {
            const dashboardPanel = document.getElementById('dashboardPanel');
            const analysisPanel = document.getElementById('analysisPanel');
            const mapControls = document.querySelector('.map-controls');
            
            // Hide dashboard and show analysis panel
            dashboardPanel.classList.remove('visible');
            analysisPanel.classList.add('visible');
            
            // Map controls stay in bottom-left position
            
            // Show notification
            showLayerNotification('Report view activated');
        });

        // Handle dashboard close
        document.getElementById('dashboardClose').addEventListener('click', function() {
            const dashboardPanel = document.getElementById('dashboardPanel');
            const analysisPanel = document.getElementById('analysisPanel');
            const mapControls = document.querySelector('.map-controls');
            
            dashboardPanel.classList.remove('visible');
            analysisPanel.classList.remove('visible');
            
            // Map controls stay in bottom-left position
            
            // Show notification
            showLayerNotification('Dashboard closed');
        });

        function deleteFeature(feature) {
            const currentPlan = plans[currentPlanId];
            
            // Remove from map
            currentPlan.layers.removeLayer(feature.layer);
            
            // Remove from features array
            currentPlan.features = currentPlan.features.filter(f => f.id !== feature.id);
            
            // Update display
            updatePlanDisplay();
        }

        function generatePolygonReport(feature) {
            const analysisPanel = document.getElementById('analysisPanel');
            const analysisContent = document.getElementById('analysisContent');
            const analysisTitle = document.querySelector('.analysis-title');
            const mapControls = document.querySelector('.map-controls');
            
            // Update title
            analysisTitle.textContent = `${feature.name} Analysis Report`;
            
            // Show loading state
            analysisContent.innerHTML = `
                <div class="analysis-loading">
                    <i class="fas fa-spinner"></i>
                    <span>Generating analysis...</span>
                </div>
            `;
            
            // Show panel - map controls stay in bottom-left position
            analysisPanel.classList.add('visible');
            
            // Simulate analysis generation (replace with actual Python analysis later)
            setTimeout(() => {
                displayAnalysisResults(feature);
            }, 2000);
        }

        function displayAnalysisResults(feature) {
            const analysisContent = document.getElementById('analysisContent');
            const area = feature.properties ? feature.properties.area : (feature.data ? feature.data.area : 0);
            const areaHa = area / 10000;
            
            // Get polygon coordinates for analysis
            const coordinates = feature.layer.getLatLngs();
            
            analysisContent.innerHTML = `
                <div class="analysis-section">
                    <h4 class="analysis-section-title">
                        <i class="fas fa-map"></i>
                        Geometric Analysis
                    </h4>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Area</span>
                        <span class="analysis-metric-value">${areaHa.toFixed(2)} hectares</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Perimeter</span>
                        <span class="analysis-metric-value">${calculatePerimeter(coordinates).toFixed(0)} meters</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Shape Index</span>
                        <span class="analysis-metric-value">1.23 (Regular)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Compactness</span>
                        <span class="analysis-metric-value">0.78 (Good)</span>
                    </div>
                </div>

                <div class="analysis-section">
                    <h4 class="analysis-section-title">
                        <i class="fas fa-satellite"></i>
                        Satellite Data Analysis
                    </h4>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">NDVI Average</span>
                        <span class="analysis-metric-value">0.72 (Healthy Vegetation)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">NDWI (Water Index)</span>
                        <span class="analysis-metric-value">0.15 (Low Moisture)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Land Cover</span>
                        <span class="analysis-metric-value">87% Grassland, 13% Scrub</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Change Detection</span>
                        <span class="analysis-metric-value">+2.3% vegetation (last year)</span>
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h4 class="analysis-section-title">
                        <i class="fas fa-mountain"></i>
                        Topographic Analysis
                    </h4>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Elevation Range</span>
                        <span class="analysis-metric-value">45-52m ASL (7m variation)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Average Slope</span>
                        <span class="analysis-metric-value">3.8° (Gentle)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Dominant Aspect</span>
                        <span class="analysis-metric-value">South-Southeast (165°)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Terrain Ruggedness</span>
                        <span class="analysis-metric-value">0.12 (Very Low)</span>
                    </div>
                </div>

                <div class="analysis-section">
                    <h4 class="analysis-section-title">
                        <i class="fas fa-seedling"></i>
                        Soil & Climate Analysis
                    </h4>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Soil Type</span>
                        <span class="analysis-metric-value">Clay Loam (78% confidence)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">pH Level</span>
                        <span class="analysis-metric-value">6.8 (Slightly Alkaline)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Drainage Class</span>
                        <span class="analysis-metric-value">Moderately Well Drained</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Growing Degree Days</span>
                        <span class="analysis-metric-value">1,247 (Good for crops)</span>
                    </div>
                </div>

                <div class="analysis-section">
                    <h4 class="analysis-section-title">
                        <i class="fas fa-tractor"></i>
                        Agricultural Suitability
                    </h4>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">ALC Grade</span>
                        <span class="analysis-metric-value">Grade 3a (Good Quality)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Crop Suitability</span>
                        <span class="analysis-metric-value">Wheat: 8.2/10, Barley: 8.7/10</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Machinery Access</span>
                        <span class="analysis-metric-value">Excellent (flat terrain)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Field Size Efficiency</span>
                        <span class="analysis-metric-value">Good (${areaHa.toFixed(1)}ha)</span>
                    </div>
                </div>

                <div class="analysis-section">
                    <h4 class="analysis-section-title">
                        <i class="fas fa-tree"></i>
                        Environmental Analysis
                    </h4>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Biodiversity Potential</span>
                        <span class="analysis-metric-value">7.2/10 (High)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Carbon Storage</span>
                        <span class="analysis-metric-value">${(areaHa * 12.5).toFixed(1)} tonnes CO₂ equivalent</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Water Catchment</span>
                        <span class="analysis-metric-value">${(areaHa * 8500).toFixed(0)} litres/year</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Wildlife Corridors</span>
                        <span class="analysis-metric-value">2 nearby (within 500m)</span>
                    </div>
                </div>

                <div class="analysis-section">
                    <h4 class="analysis-section-title">
                        <i class="fas fa-coins"></i>
                        Economic Analysis
                    </h4>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Land Value</span>
                        <span class="analysis-metric-value">£${(areaHa * 8500).toLocaleString()}</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Annual Rental Value</span>
                        <span class="analysis-metric-value">£${(areaHa * 280).toFixed(0)}/year</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">BPS Eligibility</span>
                        <span class="analysis-metric-value">Eligible (£${(areaHa * 240).toFixed(0)}/year)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">ELM Potential</span>
                        <span class="analysis-metric-value">Tier 2 Eligible</span>
                    </div>
                </div>

                <div class="analysis-section">
                    <h4 class="analysis-section-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Risk Assessment
                    </h4>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Flood Risk</span>
                        <span class="analysis-metric-value">Very Low (Zone 1)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Erosion Risk</span>
                        <span class="analysis-metric-value">Low (gentle slopes)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Contamination</span>
                        <span class="analysis-metric-value">None detected</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Historical Use</span>
                        <span class="analysis-metric-value">Agricultural (since 1840s)</span>
                    </div>
                </div>

                <div class="analysis-section">
                    <h4 class="analysis-section-title">
                        <i class="fas fa-chart-line"></i>
                        Machine Learning Predictions
                    </h4>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Yield Prediction (2024)</span>
                        <span class="analysis-metric-value">8.2 tonnes/ha (Wheat)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Optimal Planting Date</span>
                        <span class="analysis-metric-value">March 15-25 (85% confidence)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Disease Risk</span>
                        <span class="analysis-metric-value">Yellow Rust: 15% (Low)</span>
                    </div>
                    <div class="analysis-metric">
                        <span class="analysis-metric-label">Climate Resilience</span>
                        <span class="analysis-metric-value">Good (2°C warming scenario)</span>
                    </div>
                </div>

                <div class="analysis-section">
                    <h4 class="analysis-section-title">
                        <i class="fas fa-code"></i>
                        Python Analysis Stack
                    </h4>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 4px; font-family: monospace; font-size: 12px; color: #333; margin-top: 10px;">
                        <div style="color: #28a745; margin-bottom: 8px;">• GeoPandas: Spatial data processing</div>
                        <div style="color: #007bff; margin-bottom: 8px;">• Rasterio: Satellite imagery analysis</div>
                        <div style="color: #fd7e14; margin-bottom: 8px;">• Scikit-learn: ML crop predictions</div>
                        <div style="color: #6f42c1; margin-bottom: 8px;">• GDAL: Geospatial transformations</div>
                        <div style="color: #dc3545;">• NumPy/Pandas: Statistical analysis</div>
                    </div>
                </div>

                <div class="analysis-section">
                    <h4 class="analysis-section-title">
                        <i class="fas fa-download"></i>
                        Export Options
                    </h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;">
                        <button style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <i class="fas fa-file-pdf"></i> PDF Report
                        </button>
                        <button style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <i class="fas fa-file-csv"></i> CSV Data
                        </button>
                        <button style="padding: 6px 12px; background: #fd7e14; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <i class="fas fa-map"></i> GeoJSON
                        </button>
                        <button style="padding: 6px 12px; background: #6f42c1; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                            <i class="fas fa-code"></i> Python Script
                        </button>
                    </div>
                </div>
            `;
        }

        function calculatePerimeter(coordinates) {
            if (!coordinates || coordinates.length === 0) return 0;
            
            const coords = Array.isArray(coordinates[0]) ? coordinates[0] : coordinates;
            let perimeter = 0;
            
            for (let i = 0; i < coords.length; i++) {
                const current = coords[i];
                const next = coords[(i + 1) % coords.length];
                perimeter += current.distanceTo(next);
            }
            
            return perimeter;
        }

        // Handle sidebar toggle
        document.getElementById('sidebar').addEventListener('click', function(e) {
            // Handle plan selection (but not chevron clicks)
            if (e.target.closest('.sidebar-item') && !e.target.classList.contains('plan-chevron')) {
                const planContainer = e.target.closest('.plan-container');
                const planId = planContainer.getAttribute('data-plan-id');
                if (planId && plans[planId]) {
                    switchToPlan(planId);
                }
            }
        });

        // Handle search button
        document.getElementById('searchBtn').addEventListener('click', function() {
            const query = prompt('Enter a location to search for:');
            if (query && query.trim()) {
                searchLocation(query.trim());
            }
        });

        // Search function using Nominatim API
        function searchLocation(query) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=gb`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const result = data[0]; // Use the first result
                        const lat = parseFloat(result.lat);
                        const lon = parseFloat(result.lon);
                        
                        // Fly to the location
                        map.setView([lat, lon], 15);
                        
                        // Add a temporary marker
                        const marker = L.marker([lat, lon]).addTo(map);
                        marker.bindPopup(`<b>${result.display_name}</b>`).openPopup();
                        
                        // Remove marker after 5 seconds
                        setTimeout(() => {
                            map.removeLayer(marker);
                        }, 5000);
                    } else {
                        alert('Location not found. Please try a different search term.');
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    alert('Search failed. Please check your internet connection and try again.');
                });
        }

        // Handle share button
        document.getElementById('shareBtn').addEventListener('click', function() {
            document.getElementById('shareModal').classList.add('visible');
        });

        // Handle modal close
        document.getElementById('shareModalClose').addEventListener('click', function() {
            document.getElementById('shareModal').classList.remove('visible');
        });

        // Handle info panel close
        document.getElementById('infoPanelClose').addEventListener('click', function() {
            document.getElementById('infoPanel').classList.remove('visible');
        });

        // Handle layer dropdown toggle
        document.getElementById('layersMapBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('layerDropdown');
            dropdown.classList.toggle('show');
        });

        // Handle layer selection - moved to main initialization
        function initializeLayerSelection() {
            try {
                // Define base layers
                const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                });
                
                const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                });
                
                const sentinel2Layer = L.tileLayer('https://tiles.maps.eox.at/wmts/1.0.0/s2cloudless-2020_3857/default/g/{z}/{y}/{x}.jpg', {
                    attribution: 'Sentinel-2 cloudless - https://s2maps.eu by EOX IT Services GmbH'
                });
                
                const ndviLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                    attribution: 'Imagery © Google',
                    opacity: 0.7
                });
                
                // Layer configuration
                const layers = {
                    'osm': { layer: osmLayer, name: 'OpenStreetMap', icon: 'fa-map' },
                    'satellite': { layer: satelliteLayer, name: 'Satellite', icon: 'fa-satellite' },
                    'sentinel2': { layer: sentinel2Layer, name: 'Sentinel-2', icon: 'fa-satellite-dish' },
                    'ndvi': { layer: ndviLayer, name: 'NDVI', icon: 'fa-leaf' }
                };
                
                // Set initial layer if not already set
                if (!window.currentLayerKey) {
                    window.currentLayerKey = 'osm';
                    layers[window.currentLayerKey].layer.addTo(map);
                }
                
                // Set up layer option click handlers
                document.querySelectorAll('.layer-option').forEach(option => {
                    option.addEventListener('click', function() {
                        const selectedLayerKey = this.getAttribute('data-layer');
                        
                        // Update active state
                        document.querySelectorAll('.layer-option').forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Switch layer if different
                        if (selectedLayerKey !== window.currentLayerKey) {
                            // Remove current layer
                            if (map && layers[window.currentLayerKey]) {
                                map.removeLayer(layers[window.currentLayerKey].layer);
                            }
                            
                            // Switch to selected layer
                            window.currentLayerKey = selectedLayerKey;
                            const selectedLayer = layers[window.currentLayerKey];
                            
                            if (selectedLayer) {
                                // Add the new layer
                                selectedLayer.layer.addTo(map);
                                
                                // Update button icon
                                const button = document.getElementById('layersMapBtn');
                                if (button) {
                                    button.innerHTML = `<i class="fas ${selectedLayer.icon}"></i><i class="fas fa-chevron-down" style="font-size: 10px; margin-left: 4px;"></i>`;
                                    button.title = `Current: ${selectedLayer.name}`;
                                }
                                
                                // Show layer name briefly
                                showLayerNotification(`Switched to ${selectedLayer.name}`, 'success');
                            }
                        }
                        
                        // Hide dropdown
                        const dropdown = document.getElementById('layerDropdown');
                        if (dropdown) {
                            dropdown.classList.remove('show');
                        }
                    });
                });
                
                // Set initial active state
                setTimeout(() => {
                    const defaultOption = document.querySelector(`[data-layer="${window.currentLayerKey}"]`);
                    if (defaultOption) {
                        defaultOption.classList.add('active');
                    }
                }, 100);
                
                console.log('✅ Layer selection initialized');
            } catch (error) {
                console.error('Layer selection initialization failed:', error);
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('layerDropdown');
            if (!e.target.closest('.layer-dropdown-container')) {
                dropdown.classList.remove('show');
            }
        });

        // Handle overlay dropdown toggle
        document.getElementById('overlaysBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('overlayDropdown');
            dropdown.classList.toggle('show');
            
            // Close base layer dropdown if open
            document.getElementById('layerDropdown').classList.remove('show');
        });

        // Handle overlay selection - MOVED TO FUNCTION TO FIX SYNTAX
        function initializeOverlaySelection() {
            try {
                // Ensure overlay variables are available
                if (typeof window.activeOverlays === 'undefined') {
                    window.activeOverlays = {};
                }
                if (typeof window.globalOverlayOpacity === 'undefined') {
                    window.globalOverlayOpacity = 0.7;
                }
                
                // Define overlay layers
                const overlayLayers = {
                    // Climate & Weather
                    'precipitation': L.tileLayer('https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=439d4b804bc8187953eb36d2a8c26a02', {
                        attribution: '© OpenWeatherMap',
                        opacity: 0.6
                    }),
                    'temperature': L.tileLayer('https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=439d4b804bc8187953eb36d2a8c26a02', {
                        attribution: '© OpenWeatherMap Temperature',
                        opacity: 0.6
                    }),
                    'wind': L.tileLayer('https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=439d4b804bc8187953eb36d2a8c26a02', {
                        attribution: '© OpenWeatherMap Wind',
                        opacity: 0.6
                    }),
                    'clouds': L.tileLayer('https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=439d4b804bc8187953eb36d2a8c26a02', {
                        attribution: '© OpenWeatherMap Clouds',
                        opacity: 0.6
                    })
                };
                
                // Store globally for access
                window.overlayLayers = overlayLayers;
                
                // Set up overlay option click handlers
                document.querySelectorAll('.overlay-option').forEach(option => {
                    const checkbox = option.querySelector('input[type="checkbox"]');
                    const overlayKey = option.getAttribute('data-overlay');
                    
                    if (checkbox && overlayKey) {
                        // Handle checkbox change
                        checkbox.addEventListener('change', function(e) {
                            e.stopPropagation();
                            toggleOverlay(overlayKey, this.checked, option);
                        });
                        
                        // Handle clicking on the option (but not checkbox)
                        option.addEventListener('click', function(e) {
                            if (e.target.type !== 'checkbox') {
                                checkbox.checked = !checkbox.checked;
                                toggleOverlay(overlayKey, checkbox.checked, option);
                            }
                        });
                    }
                });
                
                console.log('✅ Overlay selection initialized');
            } catch (error) {
                console.error('Overlay selection initialization failed:', error);
            }
        }

        // Function to toggle overlay layers
        function toggleOverlay(overlayKey, isEnabled, optionElement) {
            if (isEnabled) {
                // Add overlay to map
                if (window.overlayLayers && window.overlayLayers[overlayKey]) {
                    try {
                        window.activeOverlays[overlayKey] = window.overlayLayers[overlayKey];
                        window.overlayLayers[overlayKey].setOpacity(window.globalOverlayOpacity);
                        window.overlayLayers[overlayKey].addTo(map);
                        optionElement.classList.add('active');
                        
                        // Add error handling for tile loading
                        window.overlayLayers[overlayKey].on('tileerror', function(error) {
                            console.warn(`Tile loading error for ${overlayKey}:`, error);
                            showLayerNotification(`${overlayKey} - some tiles may not load`);
                        });
                        
                        window.overlayLayers[overlayKey].on('tileload', function() {
                            console.log(`Tiles loading successfully for ${overlayKey}`);
                        });
                        
                        // Show notification
                        showLayerNotification(`${overlayKey.charAt(0).toUpperCase() + overlayKey.slice(1).replace('-', ' ')} overlay enabled`);
                        console.log(`Successfully enabled overlay: ${overlayKey}`);
                    } catch (error) {
                        console.error(`Error enabling overlay ${overlayKey}:`, error);
                        showLayerNotification(`Error loading ${overlayKey} overlay`);
                        optionElement.querySelector('input[type="checkbox"]').checked = false;
                    }
                }
            } else {
                // Remove overlay from map
                if (window.activeOverlays && window.activeOverlays[overlayKey]) {
                    try {
                        map.removeLayer(window.activeOverlays[overlayKey]);
                        delete window.activeOverlays[overlayKey];
                        optionElement.classList.remove('active');
                        
                        // Show notification
                        showLayerNotification(`${overlayKey.charAt(0).toUpperCase() + overlayKey.slice(1).replace('-', ' ')} overlay disabled`);
                        console.log(`Successfully disabled overlay: ${overlayKey}`);
                    } catch (error) {
                        console.error(`Error disabling overlay ${overlayKey}:`, error);
                    }
                }
            }
        }

        // Handle opacity slider - moved to main initialization
        function initializeOpacitySlider() {
            try {
                const opacitySlider = document.getElementById('overlayOpacity');
                const opacityValue = document.getElementById('opacityValue');
                
                if (opacitySlider && opacityValue) {
                    opacitySlider.addEventListener('input', function(e) {
                        const opacity = parseInt(e.target.value) / 100;
                        globalOverlayOpacity = opacity;
                        
                        // Update display value
                        opacityValue.textContent = e.target.value + '%';
                        
                        // Update all active overlays
                        Object.keys(activeOverlays).forEach(overlayKey => {
                            if (activeOverlays[overlayKey]) {
                                activeOverlays[overlayKey].setOpacity(opacity);
                            }
                        });
                        
                        // Show notification
                        showLayerNotification(`Overlay opacity: ${e.target.value}%`);
                        console.log(`Updated overlay opacity to: ${opacity}`);
                    });
                }
            } catch (error) {
                console.error('Opacity slider initialization failed:', error);
            }
        }

        // Close overlay dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const overlayDropdown = document.getElementById('overlayDropdown');
            if (!e.target.closest('.overlay-dropdown-container')) {
                overlayDropdown.classList.remove('show');
            }
        });

        // Show layer notification - REMOVED DUPLICATE, using main function

        // Navigation handling - REMOVED DUPLICATE, handled in main init
        function initializeNavigationHandling() {
            try {
                const navItems = document.querySelectorAll('.nav-item');
            const mapContainer = document.querySelector('.map-container');
            const profileSection = document.getElementById('profileSection');
            const dashboardPanel = document.getElementById('dashboardPanel');
            
            navItems.forEach(navItem => {
                navItem.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    const sidebar = document.getElementById('sidebar');
                    
                    // Handle Map button toggle behavior
                    if (section === 'map') {
                        // Check if this nav item is already active (clicked again)
                        if (this.classList.contains('active')) {
                            // Toggle sidebar visibility
                            sidebar.classList.toggle('collapsed');
                            
                            if (sidebar.classList.contains('collapsed')) {
                                showLayerNotification('Plans panel collapsed - More map space');
                            } else {
                                showLayerNotification('Plans panel expanded');
                            }
                            return; // Don't proceed with normal navigation logic
                        }
                    }
                    
                    // Remove active class from all nav items
                    navItems.forEach(item => item.classList.remove('active'));
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Ensure sidebar is visible when switching away from map
                    if (section !== 'map') {
                        sidebar.classList.remove('collapsed');
                    }
                    
                    // Handle different sections
                    if (section === 'profile') {
                        // Show profile section
                        mapContainer.style.display = 'none';
                        profileSection.classList.add('active');
                        dashboardPanel.classList.remove('visible');
                    } else if (section === 'funding') {
                        // Show funding section in dashboard
                        mapContainer.style.display = 'block';
                        profileSection.classList.remove('active');
                        dashboardPanel.classList.add('visible');
                        
                        // Switch to funding tab in dashboard
                        showFundingSection();
                        
                        showLayerNotification('Funding Opportunities');
                    } else {
                        // Show map for all other sections
                        mapContainer.style.display = 'block';
                        profileSection.classList.remove('active');
                        dashboardPanel.classList.remove('visible');
                        
                        // Show notification for the section
                        const sectionNames = {
                            'map': 'Map View',
                            'analytics': 'Analytics',
                            'satellite': 'Satellite Data',
                            'agriculture': 'Crop Analysis',
                            'water': 'Water Management',
                            'climate': 'Climate Data',
                            'field': 'Field Collection'
                        };
                        
                        if (sectionNames[section]) {
                            showLayerNotification(sectionNames[section]);
                        }
                    }
                });
            });
            
            function showFundingSection() {
                // Scroll to funding section in dashboard
                const fundingSection = document.querySelector('.funding-section');
                if (fundingSection) {
                    fundingSection.scrollIntoView({ behavior: 'smooth' });
                }
            }
            } catch (error) {
                console.error('Navigation handling initialization failed:', error);
            }
        }

        // Enhanced header title editing - MOVED TO FUNCTION
        function initializeHeaderTitleEditing() {
            try {
                const headerTitle = document.getElementById('headerTitle');
            let originalTitle = headerTitle.textContent.trim();
            
            headerTitle.addEventListener('focus', function() {
                originalTitle = this.textContent.trim();
                this.setAttribute('data-placeholder', 'Enter map name...');
            });
            
            headerTitle.addEventListener('blur', function() {
                const newTitle = this.textContent.trim();
                if (newTitle === '') {
                    this.textContent = originalTitle;
                } else if (newTitle !== originalTitle) {
                    showLayerNotification(`Map renamed to: ${newTitle}`);
                }
            });
            
            headerTitle.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                } else if (e.key === 'Escape') {
                    this.textContent = originalTitle;
                    this.blur();
                }
            });
            } catch (error) {
                console.error('Header title editing initialization failed:', error);
            }
        }

        // Learning Center functionality - MOVED TO FUNCTION
        function initializeLearningCenterFunctionality() {
            try {
                const learningBtn = document.getElementById('learningBtn');
            const learningCenter = document.getElementById('learningCenter');
            const mapContainer = document.querySelector('.map-container');
            const profileSection = document.getElementById('profileSection');
            const dashboardPanel = document.getElementById('dashboardPanel');
            
            // Debug: Check if elements exist
            console.log('Learning elements found:', {
                learningBtn: !!learningBtn,
                learningCenter: !!learningCenter,
                mapContainer: !!mapContainer
            });

            // Learning button click handler
            if (learningBtn) {
                learningBtn.addEventListener('click', function() {
                    console.log('Learning button clicked - routing to learning centre');
                    window.location.hash = '#learning-centre';
                });
            }

            // Learning close button handler
            const learningCloseBtn = document.getElementById('learningCloseBtn');
            if (learningCloseBtn) {
                learningCloseBtn.addEventListener('click', function() {
                    console.log('Learning close button clicked - routing to map');
                    window.location.hash = '#map';
                });
            }

            // URL routing for Learning Center
            function updateLearningURL(section) {
                const baseUrl = window.location.href.split('#')[0];
                window.history.pushState({section: section}, '', `${baseUrl}#learning/${section}`);
            }

            function handleLearningRoute() {
                const hash = window.location.hash;
                if (hash.startsWith('#learning/')) {
                    const section = hash.replace('#learning/', '');
                    const validSections = ['dashboard', 'courses', 'ai-tutor', 'achievements', 'help'];
                    
                    if (validSections.includes(section)) {
                        // Show learning center if not already visible
                        if (!learningCenter.classList.contains('active')) {
                            mapContainer.style.display = 'none';
                            profileSection.classList.remove('active');
                            dashboardPanel.classList.remove('visible');
                            learningCenter.classList.add('active');
                        }
                        
                        // Navigate to specific section
                        navigateToLearningSection(section);
                    }
                }
            }

            function navigateToLearningSection(targetSection) {
                const learningNavBtns = document.querySelectorAll('.learning-nav-btn');
                const learningSections = document.querySelectorAll('.learning-section');
                
                // Update navigation
                learningNavBtns.forEach(navBtn => navBtn.classList.remove('active'));
                const targetBtn = document.querySelector(`[data-section="${targetSection}"]`);
                if (targetBtn) targetBtn.classList.add('active');
                
                // Update sections
                learningSections.forEach(section => section.classList.remove('active'));
                const targetSectionEl = document.getElementById(`learning-${targetSection}`);
                if (targetSectionEl) targetSectionEl.classList.add('active');
                
                // Show notification
                const sectionNames = {
                    'dashboard': 'Learning Dashboard',
                    'courses': 'Course Library',
                    'ai-tutor': 'AI Learning Assistant',
                    'achievements': 'Your Achievements',
                    'help': 'Help Center'
                };
                
                if (sectionNames[targetSection]) {
                    showLayerNotification(sectionNames[targetSection]);
                }
            }

            // Learning navigation with URL routing
            const learningNavBtns = document.querySelectorAll('.learning-nav-btn');
            const learningSections = document.querySelectorAll('.learning-section');

            learningNavBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-section');
                    updateLearningURL(targetSection);
                    navigateToLearningSection(targetSection);
                });
            });

            // Handle browser back/forward buttons
            window.addEventListener('popstate', function(event) {
                if (event.state && event.state.section) {
                    navigateToLearningSection(event.state.section);
                } else {
                    handleLearningRoute();
                }
            });

            // Handle initial page load with hash
            handleLearningRoute();

            // Course filter functionality
            const filterBtns = document.querySelectorAll('.filter-btn');
            const courseCards = document.querySelectorAll('.course-card');

            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    
                    // Update filter buttons
                    filterBtns.forEach(filterBtn => filterBtn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Filter courses
                    courseCards.forEach(card => {
                        if (filter === 'all' || card.classList.contains(filter)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                    
                    showLayerNotification(`Showing ${filter === 'all' ? 'all' : filter} courses`);
                });
            });

            // AI suggestion cards
            const suggestionCards = document.querySelectorAll('.suggestion-card');
            suggestionCards.forEach(card => {
                card.addEventListener('click', function() {
                    const question = this.querySelector('h4').textContent;
                    showLayerNotification(`AI Assistant: "${question}"`);
                    
                    // Simulate AI response
                    setTimeout(() => {
                        const chatMessages = document.querySelector('.chat-messages');
                        const newMessage = document.createElement('div');
                        newMessage.className = 'message ai-message';
                        newMessage.innerHTML = `
                            <div class="message-avatar">
                                <i class="material-symbols-rounded">smart_toy</i>
                            </div>
                            <div class="message-content">
                                <p>Great question! Here's how to get started:</p>
                                <p><strong>Step 1:</strong> Look for the drawing tools in the left sidebar - they include polygon, circle, and rectangle tools.</p>
                                <p><strong>Step 2:</strong> Click your chosen tool, then click on the map to start drawing your boundary.</p>
                                <p><strong>Step 3:</strong> Complete your shape by connecting back to the starting point.</p>
                                <p>Need more help? Try the "Getting Started" course or ask me another question!</p>
                            </div>
                        `;
                        chatMessages.appendChild(newMessage);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 1000);
                });
            });

            // Quick actions
            const quickActions = document.querySelectorAll('.quick-action');
            quickActions.forEach(action => {
                action.addEventListener('click', function() {
                    const actionText = this.querySelector('span').textContent;
                    showLayerNotification(`${actionText} feature activated`);
                });
            });

            // Course cards interaction
            const courseContinueButtons = document.querySelectorAll('.continue-btn');
            courseContinueButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const courseName = this.closest('.course-card, .current-course').querySelector('h4').textContent;
                    showLayerNotification(`Resuming: ${courseName}`);
                });
            });

            // Chat functionality
            const chatInput = document.querySelector('.chat-input');
            const chatSendBtn = document.querySelector('.chat-send-btn');
            
            function sendChatMessage() {
                const message = chatInput.value.trim();
                if (message) {
                    const chatMessages = document.querySelector('.chat-messages');
                    
                    // Add user message
                    const userMessage = document.createElement('div');
                    userMessage.className = 'message user-message';
                    userMessage.innerHTML = `
                        <div class="message-avatar" style="background: var(--md-sys-color-secondary);">
                            <i class="material-symbols-rounded">person</i>
                        </div>
                        <div class="message-content">
                            <p>${message}</p>
                        </div>
                    `;
                    chatMessages.appendChild(userMessage);
                    
                    // Clear input
                    chatInput.value = '';
                    
                    // Simulate AI response
                    setTimeout(() => {
                        const aiMessage = document.createElement('div');
                        aiMessage.className = 'message ai-message';
                        aiMessage.innerHTML = `
                            <div class="message-avatar">
                                <i class="material-symbols-rounded">smart_toy</i>
                            </div>
                            <div class="message-content">
                                <p>Thanks for your question! I'm analyzing your query and will provide a detailed response with relevant learning materials and step-by-step guidance.</p>
                                <p>Based on your question about "${message}", I recommend checking out these resources...</p>
                            </div>
                        `;
                        chatMessages.appendChild(aiMessage);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 1500);
                    
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
            
            chatSendBtn.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });

            // Help articles
            const helpArticles = document.querySelectorAll('.help-article');
            helpArticles.forEach(article => {
                article.addEventListener('click', function(e) {
                    e.preventDefault();
                    const title = this.querySelector('span').textContent;
                    showLayerNotification(`Opening: ${title}`);
                });
            });

            // Video tutorials
            const videoCards = document.querySelectorAll('.video-card');
            videoCards.forEach(card => {
                card.addEventListener('click', function() {
                    const title = this.querySelector('h4').textContent;
                    showLayerNotification(`Playing: ${title}`);
                });
            });

            // Contact AI Assistant button
            const contactBtn = document.querySelector('.contact-btn');
            if (contactBtn) {
                contactBtn.addEventListener('click', function() {
                    // Switch to AI Tutor section
                    learningNavBtns.forEach(btn => btn.classList.remove('active'));
                    document.querySelector('[data-section="ai-tutor"]').classList.add('active');
                    
                    learningSections.forEach(section => section.classList.remove('active'));
                    document.getElementById('learning-ai-tutor').classList.add('active');
                    
                    showLayerNotification('AI Assistant activated');
                });
            }
            } catch (error) {
                console.error('Learning Center functionality initialization failed:', error);
            }
        }

        // Back to dashboard functionality
        function goBackToDashboard() {
            // Show notification
            showLayerNotification('Returning to All Maps Dashboard');
            
            // In a real implementation, this would navigate to the main dashboard
            // For now, we'll show an alert to demonstrate the functionality
            setTimeout(() => {
                alert('This would navigate back to your "All Maps" dashboard where you can see all your land management projects, similar to how Miro shows all your boards.');
            }, 1000);
            
            // You could implement actual navigation here:
            // window.location.href = '/dashboard';
            // or use a SPA router to navigate to the main dashboard view
        }

        // Handle map controls. So this is some low fidelity HTML of the Land App UI. When we start coding, we may update what we have already built to a UI that replicates this so we have a better and more useful UI for the GeoMasteryPy tool
        document.getElementById('zoomInBtn').addEventListener('click', function() {
            map.zoomIn();
        });

        document.getElementById('zoomOutBtn').addEventListener('click', function() {
            map.zoomOut();
        });

        document.getElementById('locateBtn').addEventListener('click', function() {
            map.locate({setView: true, maxZoom: 16});
        });

        document.getElementById('fullscreenBtn').addEventListener('click', function() {
            const mapContainer = document.getElementById('map_div');
            
            if (document.fullscreenElement) {
                // Exit fullscreen
                document.exitFullscreen();
                this.innerHTML = '<i class="fas fa-expand"></i>';
            } else {
                // Enter fullscreen
                if (mapContainer.requestFullscreen) {
                    mapContainer.requestFullscreen();
                } else if (mapContainer.webkitRequestFullscreen) {
                    mapContainer.webkitRequestFullscreen();
                } else if (mapContainer.msRequestFullscreen) {
                    mapContainer.msRequestFullscreen();
                }
                this.innerHTML = '<i class="fas fa-compress"></i>';
            }
        });

        // Listen for fullscreen changes to update button state
        document.addEventListener('fullscreenchange', function() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (document.fullscreenElement) {
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
        });

        // ========== OSM Integration Functionality ==========
        
        // OSM Panel Management
        const osmPanel = document.getElementById('osmPanel');
        const osmPanelClose = document.getElementById('osmPanelClose');
        // osmResultsLayer, queryHistory, favoriteQueries now declared globally

        // OSM Navigation Handler - Multiple approaches for compatibility
        function initializeOSMNavigation() {
            console.log('Initializing OSM navigation...');
            
            // Method 1: Direct element selection
            const osmNavItem = document.querySelector('[data-section="osm"]');
            console.log('OSM nav item found:', osmNavItem);
            
            if (osmNavItem) {
                // Remove any existing listeners
                osmNavItem.removeEventListener('click', handleOSMNavClick);
                osmNavItem.addEventListener('click', handleOSMNavClick);
                console.log('OSM click listener added');
            }
            
            // Method 2: Also add to navigation rail if it exists
            const navRail = document.querySelector('.navigation-rail');
            if (navRail) {
                navRail.addEventListener('click', function(e) {
                    const navItem = e.target.closest('.nav-item');
                    if (navItem && navItem.getAttribute('data-section') === 'osm') {
                        console.log('OSM clicked via nav rail delegation');
                        handleOSMNavClick(e);
                    }
                });
            }
        }
        
        function handleOSMNavClick(e) {
            console.log('OSM navigation clicked'); // Debug log
            e.preventDefault();
            e.stopPropagation();
            
            // Close other panels
            document.querySelectorAll('.collaboration-panel, .analysis-panel, .settings-panel, .learning-center').forEach(panel => {
                panel.style.display = 'none';
                panel.classList.remove('visible');
            });
            
            // Close inspection panel if open
            const inspectionPanel = document.getElementById('osmInspectionPanel');
            if (inspectionPanel) {
                inspectionPanel.classList.remove('visible');
            }
            
            // Show OSM panel using the visible class
            if (osmPanel) {
                console.log('Showing OSM panel');
                osmPanel.classList.add('visible');
                showLayerNotification('OSM Data Integration activated');
            } else {
                console.error('OSM panel not found');
            }
        }

        // OSM Navigation initialization - moved to main init
        
        // Global function for testing OSM panel
        window.testOSMPanel = function() {
            console.log('Testing OSM panel...');
            const panel = document.getElementById('osmPanel');
            if (panel) {
                panel.classList.add('visible');
                console.log('OSM panel shown via test function');
                showLayerNotification('OSM Panel Test - Opened Successfully!');
            } else {
                console.error('OSM panel not found in test');
            }
        };
        
        // Debug: Log all navigation items
        console.log('All navigation items:', document.querySelectorAll('[data-section]'));

        // Close OSM Panel
        if (osmPanelClose) {
            osmPanelClose.addEventListener('click', function() {
                osmPanel.classList.remove('visible');
                showLayerNotification('OSM panel closed');
            });
        }

        // Smart Query Processing
        const smartQueryInput = document.getElementById('smartQueryInput');
        const submitSmartQuery = document.getElementById('submitSmartQuery');

        function processSmartQuery(query) {
            const processedQuery = detectQueryType(query.toLowerCase());
            return processedQuery;
        }

        function detectQueryType(query) {
            // Auto-detection patterns for different query types
            const patterns = {
                restaurants: /\b(restaurant|food|eat|dining|cafe|pizza|burger|cuisine)\b/,
                schools: /\b(school|education|university|college|academy|kindergarten)\b/,
                hospitals: /\b(hospital|medical|clinic|doctor|health|pharmacy)\b/,
                parks: /\b(park|green|nature|recreation|playground|garden)\b/,
                transport: /\b(bus|train|station|stop|transport|metro|subway|railway)\b/,
                shops: /\b(shop|store|market|mall|retail|supermarket|grocery)\b/,
                services: /\b(bank|atm|post|office|police|fire|government)\b/,
                accommodation: /\b(hotel|motel|hostel|accommodation|lodge|inn)\b/,
                entertainment: /\b(cinema|theater|pub|bar|club|museum|gallery)\b/
            };

            for (const [category, pattern] of Object.entries(patterns)) {
                if (pattern.test(query)) {
                    return {
                        category: category,
                        overpassQuery: generateOverpassQuery(category, getCurrentMapBounds()),
                        originalQuery: query
                    };
                }
            }

            // Default fallback - try to parse as general amenity
            return {
                category: 'general',
                overpassQuery: generateOverpassQuery('general', getCurrentMapBounds(), query),
                originalQuery: query
            };
        }

        function getCurrentMapBounds() {
            const bounds = map.getBounds();
            return {
                south: bounds.getSouth(),
                west: bounds.getWest(),
                north: bounds.getNorth(),
                east: bounds.getEast()
            };
        }

        function generateOverpassQuery(category, bounds, customQuery = null) {
            const bbox = `${bounds.south},${bounds.west},${bounds.north},${bounds.east}`;
            
            const queryTemplates = {
                restaurants: `[out:json][timeout:25];(node["amenity"~"^(restaurant|cafe|fast_food|bar|pub)$"](${bbox});way["amenity"~"^(restaurant|cafe|fast_food|bar|pub)$"](${bbox}););out center;`,
                schools: `[out:json][timeout:25];(node["amenity"~"^(school|university|college|kindergarten)$"](${bbox});way["amenity"~"^(school|university|college|kindergarten)$"](${bbox}););out center;`,
                hospitals: `[out:json][timeout:25];(node["amenity"~"^(hospital|clinic|doctors|pharmacy)$"](${bbox});way["amenity"~"^(hospital|clinic|doctors|pharmacy)$"](${bbox}););out center;`,
                parks: `[out:json][timeout:25];(node["leisure"~"^(park|playground|recreation_ground)$"](${bbox});way["leisure"~"^(park|playground|recreation_ground)$"](${bbox});relation["leisure"~"^(park|playground|recreation_ground)$"](${bbox}););out center;`,
                transport: `[out:json][timeout:25];(node["public_transport"](${bbox});node["highway"="bus_stop"](${bbox});node["railway"="station"](${bbox});way["public_transport"](${bbox}););out center;`,
                shops: `[out:json][timeout:25];(node["shop"](${bbox});way["shop"](${bbox}););out center;`,
                services: `[out:json][timeout:25];(node["amenity"~"^(bank|atm|post_office|police|fire_station)$"](${bbox});way["amenity"~"^(bank|atm|post_office|police|fire_station)$"](${bbox}););out center;`,
                accommodation: `[out:json][timeout:25];(node["tourism"~"^(hotel|motel|hostel|guest_house)$"](${bbox});way["tourism"~"^(hotel|motel|hostel|guest_house)$"](${bbox}););out center;`,
                entertainment: `[out:json][timeout:25];(node["amenity"~"^(cinema|theatre|pub|bar|nightclub|museum)$"](${bbox});way["amenity"~"^(cinema|theatre|pub|bar|nightclub|museum)$"](${bbox}););out center;`
            };

            if (customQuery && category === 'general') {
                // Try to extract meaningful terms for a general search
                const searchTerm = customQuery.replace(/\b(near|in|around|at|the|a|an)\b/g, '').trim();
                return `[out:json][timeout:25];(node[~"."~"${searchTerm}",i](${bbox});way[~"."~"${searchTerm}",i](${bbox}););out center;`;
            }

            return queryTemplates[category] || queryTemplates.general;
        }

        async function executeOverpassQuery(query) {
            const overpassUrl = 'https://overpass-api.de/api/interpreter';
            
            try {
                showLayerNotification('Querying OpenStreetMap data...');
                
                const response = await fetch(overpassUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `data=${encodeURIComponent(query)}`
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Overpass query failed:', error);
                showLayerNotification('Failed to query OSM data. Please try again.', 'error');
                return null;
            }
        }

        function displayOSMResults(data, originalQuery) {
            if (!data || !data.elements || data.elements.length === 0) {
                updateResultsCount(0);
                showLayerNotification('No results found for your query');
                return;
            }

            // Clear previous results
            if (osmResultsLayer) {
                map.removeLayer(osmResultsLayer);
            }

            // Create new layer group
            osmResultsLayer = L.layerGroup();

            const icons = {
                restaurant: '🍽️',
                cafe: '☕',
                school: '🏫',
                hospital: '🏥',
                park: '🌳',
                shop: '🛍️',
                default: '📍'
            };

            let resultCount = 0;
            data.elements.forEach(element => {
                let lat, lon;

                if (element.type === 'node') {
                    lat = element.lat;
                    lon = element.lon;
                } else if (element.center) {
                    lat = element.center.lat;
                    lon = element.center.lon;
                } else {
                    return; // Skip if no coordinates
                }

                const tags = element.tags || {};
                const name = tags.name || tags.amenity || tags.shop || tags.leisure || 'Unnamed';
                const category = tags.amenity || tags.shop || tags.leisure || 'other';
                const icon = icons[category] || icons.default;

                // Create custom marker
                const marker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        html: `<div style="background: white; border: 2px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">${icon}</div>`,
                        className: 'osm-marker',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                });

                // Store feature data for inspection
                const featureData = {
                    lat: lat,
                    lon: lon,
                    tags: tags,
                    name: name,
                    category: category,
                    id: element.id || null,
                    type: element.type || 'node'
                };

                // Create popup content with right-click hint
                const popupContent = `
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 8px 0; color: #333;">${name}</h4>
                        <p style="margin: 0 0 4px 0; color: #666;"><strong>Type:</strong> ${category}</p>
                        ${tags.operator ? `<p style="margin: 0 0 4px 0; color: #666;"><strong>Operator:</strong> ${tags.operator}</p>` : ''}
                        ${tags.website ? `<p style="margin: 0 0 4px 0;"><a href="${tags.website}" target="_blank" style="color: #4CAF50;">Website</a></p>` : ''}
                        ${tags.phone ? `<p style="margin: 0 0 4px 0; color: #666;"><strong>Phone:</strong> ${tags.phone}</p>` : ''}
                        <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}</p>
                        <div style="margin-top: 8px; padding: 8px; background: #f0f7ff; border-radius: 4px; border-left: 3px solid #4CAF50;">
                            <p style="margin: 0; font-size: 12px; color: #555;">💡 <strong>Tip:</strong> Right-click this marker and select "Inspect Feature" for detailed information!</p>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent);

                // Add right-click context menu
                marker.on('contextmenu', function(e) {
                    showOSMContextMenu(e.originalEvent, featureData);
                });

                // Also allow double-click to inspect
                marker.on('dblclick', function(e) {
                    e.originalEvent.preventDefault();
                    inspectFeature(featureData);
                });
                osmResultsLayer.addLayer(marker);
                resultCount++;
            });

            // Add to map
            osmResultsLayer.addTo(map);
            
            // Update results count
            updateResultsCount(resultCount);
            
            // Add to history
            addToQueryHistory(originalQuery, resultCount);
            
            showLayerNotification(`Found ${resultCount} results for "${originalQuery}"`);
        }

        function updateResultsCount(count) {
            const resultCountElement = document.getElementById('resultCount');
            if (resultCountElement) {
                resultCountElement.textContent = count > 0 ? `(${count})` : '';
            }
        }

        function addToQueryHistory(query, resultCount) {
            const historyItem = {
                query: query,
                timestamp: new Date().toISOString(),
                resultCount: resultCount
            };

            // Add to beginning of history
            queryHistory.unshift(historyItem);
            
            // Keep only last 10 items
            queryHistory = queryHistory.slice(0, 10);
            
            // Save to localStorage
            localStorage.setItem('osmQueryHistory', JSON.stringify(queryHistory));
            
            // Update UI
            updateHistoryUI();
        }

        function updateHistoryUI() {
            const historyContainer = document.getElementById('queryHistory');
            if (!historyContainer) return;

            historyContainer.innerHTML = '';
            
            queryHistory.forEach(item => {
                const historyElement = document.createElement('div');
                historyElement.className = 'history-item';
                historyElement.innerHTML = `
                    <span class="history-query">${item.query} (${item.resultCount} results)</span>
                    <button class="history-rerun" data-query="${item.query}">
                        <i class="material-symbols-rounded">refresh</i>
                    </button>
                    <button class="history-favorite" data-query="${item.query}">
                        <i class="material-symbols-rounded">star_border</i>
                    </button>
                `;
                historyContainer.appendChild(historyElement);
            });

            // Add event listeners to new buttons
            historyContainer.querySelectorAll('.history-rerun').forEach(btn => {
                btn.addEventListener('click', function() {
                    const query = this.getAttribute('data-query');
                    executeSmartQuery(query);
                });
            });

            historyContainer.querySelectorAll('.history-favorite').forEach(btn => {
                btn.addEventListener('click', function() {
                    const query = this.getAttribute('data-query');
                    toggleFavorite(query, this);
                });
            });
        }

        async function executeSmartQuery(query) {
            const processedQuery = processSmartQuery(query);
            const data = await executeOverpassQuery(processedQuery.overpassQuery);
            if (data) {
                displayOSMResults(data, query);
            }
        }

        // Feature Toggle System - using global activeFeatureLayers
        // const activeFeatureLayers = new Map(); // REMOVED DUPLICATE
        let activeFeatureCount = 0;

        // Initialize feature toggle listeners
        document.querySelectorAll('.feature-toggle input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const featureType = this.getAttribute('data-feature');
                const label = this.closest('.feature-toggle').querySelector('.feature-label').textContent;
                
                if (this.checked) {
                    loadFeatureData(featureType, label);
                } else {
                    removeFeatureData(featureType, label);
                }
            });
        });

        async function loadFeatureData(featureType, label) {
            try {
                showLayerNotification(`Loading ${label}...`);
                
                const bounds = getCurrentMapBounds();
                const query = generateFeatureQuery(featureType, bounds);
                const data = await executeOverpassQuery(query);
                
                if (data && data.elements && data.elements.length > 0) {
                    const layer = createFeatureLayer(data, featureType, label);
                    activeFeatureLayers.set(featureType, {
                        layer: layer,
                        count: data.elements.length,
                        label: label
                    });
                    
                    layer.addTo(map);
                    updateActiveFeaturesList();
                    addToQueryHistory(label, data.elements.length);
                    showLayerNotification(`Loaded ${data.elements.length} ${label}`);
                } else {
                    showLayerNotification(`No ${label} found in this area`);
                    // Uncheck the toggle since no data was found
                    document.getElementById(`toggle-${featureType}`).checked = false;
                }
            } catch (error) {
                console.error(`Error loading ${featureType}:`, error);
                showLayerNotification(`Failed to load ${label}`, 'error');
                document.getElementById(`toggle-${featureType}`).checked = false;
            }
        }

        function removeFeatureData(featureType, label) {
            const featureData = activeFeatureLayers.get(featureType);
            if (featureData) {
                map.removeLayer(featureData.layer);
                activeFeatureLayers.delete(featureType);
                updateActiveFeaturesList();
                showLayerNotification(`Removed ${label}`);
            }
        }

        function generateFeatureQuery(featureType, bounds) {
            const bbox = `${bounds.south},${bounds.west},${bounds.north},${bounds.east}`;
            
            const queries = {
                restaurants: `[out:json][timeout:25];(node["amenity"="restaurant"](${bbox});way["amenity"="restaurant"](${bbox}););out center;`,
                cafes: `[out:json][timeout:25];(node["amenity"="cafe"](${bbox});way["amenity"="cafe"](${bbox}););out center;`,
                bars: `[out:json][timeout:25];(node["amenity"~"^(bar|pub)$"](${bbox});way["amenity"~"^(bar|pub)$"](${bbox}););out center;`,
                fastfood: `[out:json][timeout:25];(node["amenity"="fast_food"](${bbox});way["amenity"="fast_food"](${bbox}););out center;`,
                schools: `[out:json][timeout:25];(node["amenity"="school"](${bbox});way["amenity"="school"](${bbox}););out center;`,
                universities: `[out:json][timeout:25];(node["amenity"~"^(university|college)$"](${bbox});way["amenity"~"^(university|college)$"](${bbox}););out center;`,
                hospitals: `[out:json][timeout:25];(node["amenity"="hospital"](${bbox});way["amenity"="hospital"](${bbox}););out center;`,
                pharmacies: `[out:json][timeout:25];(node["amenity"="pharmacy"](${bbox});way["amenity"="pharmacy"](${bbox}););out center;`,
                transport: `[out:json][timeout:25];(node["public_transport"](${bbox});node["highway"="bus_stop"](${bbox});node["railway"="station"](${bbox});way["public_transport"](${bbox}););out center;`,
                parking: `[out:json][timeout:25];(node["amenity"="parking"](${bbox});way["amenity"="parking"](${bbox}););out center;`,
                fuel: `[out:json][timeout:25];(node["amenity"="fuel"](${bbox});way["amenity"="fuel"](${bbox}););out center;`,
                shops: `[out:json][timeout:25];(node["shop"](${bbox});way["shop"](${bbox}););out center;`,
                banks: `[out:json][timeout:25];(node["amenity"="bank"](${bbox});way["amenity"="bank"](${bbox}););out center;`,
                supermarkets: `[out:json][timeout:25];(node["shop"="supermarket"](${bbox});way["shop"="supermarket"](${bbox}););out center;`,
                postoffice: `[out:json][timeout:25];(node["amenity"="post_office"](${bbox});way["amenity"="post_office"](${bbox}););out center;`,
                parks: `[out:json][timeout:25];(node["leisure"="park"](${bbox});way["leisure"="park"](${bbox});relation["leisure"="park"](${bbox}););out geom;`,
                hotels: `[out:json][timeout:25];(node["tourism"="hotel"](${bbox});way["tourism"="hotel"](${bbox}););out center;`,
                museums: `[out:json][timeout:25];(node["tourism"="museum"](${bbox});way["tourism"="museum"](${bbox}););out center;`,
                cinemas: `[out:json][timeout:25];(node["amenity"="cinema"](${bbox});way["amenity"="cinema"](${bbox}););out center;`,
                // New polygon features
                buildings: `[out:json][timeout:25];(way["building"](${bbox});relation["building"](${bbox}););out geom;`,
                residential: `[out:json][timeout:25];(way["landuse"="residential"](${bbox});relation["landuse"="residential"](${bbox}););out geom;`,
                industrial: `[out:json][timeout:25];(way["landuse"="industrial"](${bbox});relation["landuse"="industrial"](${bbox}););out geom;`,
                commercial: `[out:json][timeout:25];(way["landuse"="commercial"](${bbox});relation["landuse"="commercial"](${bbox}););out geom;`,
                farmland: `[out:json][timeout:25];(way["landuse"="farmland"](${bbox});relation["landuse"="farmland"](${bbox}););out geom;`,
                forest: `[out:json][timeout:25];(way["landuse"="forest"](${bbox});way["natural"="wood"](${bbox});relation["landuse"="forest"](${bbox});relation["natural"="wood"](${bbox}););out geom;`,
                grassland: `[out:json][timeout:25];(way["landuse"="grass"](${bbox});way["landuse"="meadow"](${bbox});way["natural"="grassland"](${bbox});relation["landuse"="grass"](${bbox});relation["landuse"="meadow"](${bbox});relation["natural"="grassland"](${bbox}););out geom;`,
                water: `[out:json][timeout:25];(way["natural"="water"](${bbox});way["waterway"](${bbox});relation["natural"="water"](${bbox});relation["waterway"](${bbox}););out geom;`
            };
            
            return queries[featureType] || queries.restaurants;
        }

        function createFeatureLayer(data, featureType, label) {
            const layer = L.layerGroup();
            
            const icons = {
                restaurants: '🍽️', cafes: '☕', bars: '🍺', fastfood: '🍔',
                schools: '🏫', universities: '🎓', hospitals: '🏥', pharmacies: '💊',
                transport: '🚌', parking: '🅿️', fuel: '⛽',
                shops: '🛍️', banks: '🏦', supermarkets: '🛒', postoffice: '📮',
                parks: '🌳', hotels: '🏨', museums: '🏛️', cinemas: '🎬',
                buildings: '🏢', residential: '🏘️', industrial: '🏭', commercial: '🏬',
                farmland: '🌾', forest: '🌲', grassland: '🌱', water: '💧'
            };
            
            const polygonTypes = ['parks', 'buildings', 'residential', 'industrial', 'commercial', 'farmland', 'forest', 'grassland', 'water'];
            const isPolygonType = polygonTypes.includes(featureType);
            
            const icon = icons[featureType] || '📍';
            
            data.elements.forEach(element => {
                const tags = element.tags || {};
                const name = tags.name || tags.amenity || tags.shop || tags.leisure || tags.landuse || tags.natural || tags.building || 'Unnamed Area';
                
                if (isPolygonType && element.type === 'way' && element.geometry) {
                    // Create polygon for area features
                    const coords = element.geometry.map(coord => [coord.lat, coord.lon]);
                    
                    if (coords.length > 2) {
                        const polygon = L.polygon(coords, {
                            color: getPolygonColor(featureType),
                            fillColor: getPolygonColor(featureType),
                            fillOpacity: 0.3,
                            weight: 2,
                            opacity: 0.8
                        });
                        
                        const featureData = {
                            element: element,
                            tags: tags,
                            name: name,
                            category: featureType,
                            id: element.id || null,
                            type: element.type || 'way',
                            geometry: element.geometry,
                            area: calculatePolygonArea(coords)
                        };
                        
                        polygon.bindPopup(`
                            <div style="min-width: 200px;">
                                <h4 style="margin: 0 0 8px 0; color: #333;">${name}</h4>
                                <p style="margin: 0 0 4px 0; color: #666;"><strong>Type:</strong> ${featureType}</p>
                                <p style="margin: 0 0 4px 0; color: #666;"><strong>Area:</strong> ${(featureData.area / 10000).toFixed(2)} hectares</p>
                                <div style="margin-top: 8px; padding: 8px; background: #f0f7ff; border-radius: 4px; border-left: 3px solid #4CAF50;">
                                    <p style="margin: 0; font-size: 12px; color: #555;">💡 <strong>Click this area</strong> to see detailed information in the side panel!</p>
                                </div>
                            </div>
                        `);
                        
                        polygon.on('click', function(e) {
                            e.originalEvent.stopPropagation();
                            selectPolygon(polygon, featureData);
                        });

                        polygon.on('contextmenu', function(e) {
                            e.originalEvent.preventDefault();
                            e.originalEvent.stopPropagation();
                            showPolygonContextMenu(e.originalEvent, featureData, polygon);
                        });
                        
                        layer.addLayer(polygon);
                    }
                } else {
                    // Create point marker for point features
                    let lat, lon;
                    
                    if (element.type === 'node') {
                        lat = element.lat;
                        lon = element.lon;
                    } else if (element.center) {
                        lat = element.center.lat;
                        lon = element.center.lon;
                    } else {
                        return;
                    }
                    
                    const marker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            html: `<div style="background: white; border: 2px solid #4CAF50; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">${icon}</div>`,
                            className: 'osm-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    });
                    
                    const featureData = {
                        lat: lat, lon: lon, tags: tags, name: name,
                        category: featureType, id: element.id || null, type: element.type || 'node'
                    };
                    
                    const popupContent = `
                        <div style="min-width: 200px;">
                            <h4 style="margin: 0 0 8px 0; color: #333;">${name}</h4>
                            <p style="margin: 0 0 4px 0; color: #666;"><strong>Type:</strong> ${featureType}</p>
                            ${tags.operator ? `<p style="margin: 0 0 4px 0; color: #666;"><strong>Operator:</strong> ${tags.operator}</p>` : ''}
                            ${tags.website ? `<p style="margin: 0 0 4px 0;"><a href="${tags.website}" target="_blank" style="color: #4CAF50;">Website</a></p>` : ''}
                            ${tags.phone ? `<p style="margin: 0 0 4px 0; color: #666;"><strong>Phone:</strong> ${tags.phone}</p>` : ''}
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #999;">Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}</p>
                            <div style="margin-top: 8px; padding: 8px; background: #f0f7ff; border-radius: 4px; border-left: 3px solid #4CAF50;">
                                <p style="margin: 0; font-size: 12px; color: #555;">💡 <strong>Tip:</strong> Right-click this marker and select "Inspect Feature" for detailed information!</p>
                            </div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    marker.on('contextmenu', function(e) {
                        showOSMContextMenu(e.originalEvent, featureData);
                    });
                    marker.on('dblclick', function(e) {
                        e.originalEvent.preventDefault();
                        inspectFeature(featureData);
                    });
                    
                    layer.addLayer(marker);
                }
            });
            
            return layer;
        }

        function getPolygonColor(featureType) {
            const colors = {
                parks: '#4CAF50',          // Green
                buildings: '#9E9E9E',      // Gray
                residential: '#FF9800',    // Orange
                industrial: '#795548',     // Brown
                commercial: '#E91E63',     // Pink
                farmland: '#CDDC39',       // Light Green
                forest: '#2E7D32',         // Dark Green
                grassland: '#8BC34A',      // Light Green
                water: '#2196F3'           // Blue
            };
            return colors[featureType] || '#4CAF50';
        }

        function calculatePolygonArea(coords) {
            // Simple area calculation using shoelace formula (approximate)
            let area = 0;
            const n = coords.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += coords[i][0] * coords[j][1];
                area -= coords[j][0] * coords[i][1];
            }
            
            return Math.abs(area) * 0.5 * 111319.9 * 111319.9; // Rough conversion to square meters
        }

        function updateActiveFeaturesList() {
            const container = document.getElementById('activeFeaturesInfo');
            const resultCount = document.getElementById('resultCount');
            
            if (activeFeatureLayers.size === 0) {
                container.innerHTML = '<p class="no-features">No features currently displayed. Toggle features above to see them on the map.</p>';
                resultCount.textContent = '';
            } else {
                let totalCount = 0;
                let html = '';
                
                activeFeatureLayers.forEach((data, featureType) => {
                    totalCount += data.count;
                    html += `
                        <div class="active-feature-item">
                            <div class="active-feature-info">
                                <span class="active-feature-name">${data.label}</span>
                                <span class="active-feature-count">${data.count} items</span>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                resultCount.textContent = `(${totalCount})`;
            }
        }

        // Clear all features button
        const clearAllBtn = document.getElementById('clearAllFeatures');
        if (clearAllBtn) {
            clearAllBtn.addEventListener('click', function() {
                // Clear all layers
                activeFeatureLayers.forEach((data, featureType) => {
                    map.removeLayer(data.layer);
                    document.getElementById(`toggle-${featureType}`).checked = false;
                });
                
                activeFeatureLayers.clear();
                updateActiveFeaturesList();
                showLayerNotification('All features cleared');
            });
        }

        // Initialize history UI on load
        updateHistoryUI();

        // ========== Polygon Selection and Information System ==========
        
        const polygonInfoPanel = document.getElementById('polygonInfoPanel');
        const polygonPanelClose = document.getElementById('polygonPanelClose');
        const polygonTitle = document.getElementById('polygonTitle');
        const polygonContent = document.getElementById('polygonContent');

        // Close polygon panel
        if (polygonPanelClose) {
            polygonPanelClose.addEventListener('click', function() {
                polygonInfoPanel.classList.remove('visible');
                if (selectedPolygon && originalPolygonStyle) {
                    selectedPolygon.setStyle(originalPolygonStyle);
                    selectedPolygon = null;
                    originalPolygonStyle = null;
                }
                showLayerNotification('Area information closed');
            });
        }

        function selectPolygon(polygon, featureData) {
            // Deselect previous polygon
            if (selectedPolygon && originalPolygonStyle) {
                selectedPolygon.setStyle(originalPolygonStyle);
            }

            // Store original style and apply highlight
            originalPolygonStyle = {
                color: polygon.options.color,
                fillColor: polygon.options.fillColor,
                fillOpacity: polygon.options.fillOpacity,
                weight: polygon.options.weight,
                opacity: polygon.options.opacity
            };

            // Highlight selected polygon
            polygon.setStyle({
                color: '#FF5722',
                fillColor: '#FF5722',
                fillOpacity: 0.5,
                weight: 4,
                opacity: 1
            });

            selectedPolygon = polygon;

            // Show polygon information panel
            showPolygonInformation(featureData);
            
            // Close other panels
            if (osmPanel.classList.contains('visible')) {
                osmPanel.classList.remove('visible');
            }
            if (inspectionPanel && inspectionPanel.classList.contains('visible')) {
                inspectionPanel.classList.remove('visible');
            }
        }

        async function showPolygonInformation(featureData) {
            // Show panel and loading state
            polygonInfoPanel.classList.add('visible');
            polygonTitle.textContent = 'Area Information';
            polygonContent.innerHTML = `
                <div class="polygon-loading">
                    <i class="material-symbols-rounded spinning">refresh</i>
                    <p>Analyzing area information...</p>
                </div>
            `;

            try {
                // Get enhanced information
                const enhancedData = await getEnhancedPolygonData(featureData);
                displayPolygonInformation(enhancedData);
                showLayerNotification('Area information loaded');
            } catch (error) {
                console.error('Failed to get polygon info:', error);
                polygonContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--md-sys-color-error);">
                        <i class="material-symbols-rounded" style="font-size: 48px; margin-bottom: 16px;">error</i>
                        <p>Failed to load area information</p>
                    </div>
                `;
            }
        }

        async function getEnhancedPolygonData(featureData) {
            // Simulate API delay and enhance data
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const enhanced = {
                ...featureData,
                lastSurveyed: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                osmId: featureData.id || `way/${Math.floor(Math.random() * 1000000)}`,
                version: Math.floor(Math.random() * 10) + 1,
                perimeter: calculatePerimeter(featureData.geometry),
                landValue: calculateLandValue(featureData.area, featureData.category),
                biodiversityScore: Math.floor(Math.random() * 40) + 60,
                soilType: getSoilType(featureData.category),
                drainage: getDrainageInfo(featureData.category),
                access: getAccessInfo(featureData.category)
            };

            return enhanced;
        }

        function displayPolygonInformation(data) {
            const tags = data.tags || {};
            const areaHa = (data.area / 10000).toFixed(2);
            const perimeterKm = (data.perimeter / 1000).toFixed(2);
            
            const categoryIcons = {
                parks: '🌳', buildings: '🏢', residential: '🏘️', industrial: '🏭', 
                commercial: '🏬', farmland: '🌾', forest: '🌲', grassland: '🌱', water: '💧'
            };

            const icon = categoryIcons[data.category] || '🗺️';

            polygonContent.innerHTML = `
                <div class="area-header">
                    <div class="area-icon">${icon}</div>
                    <div class="area-info">
                        <h1 class="area-name">${data.name}</h1>
                        <p class="area-type">${data.category.charAt(0).toUpperCase() + data.category.slice(1)} Area</p>
                        <p class="area-size">${areaHa} hectares • ${perimeterKm} km perimeter</p>
                    </div>
                </div>

                <div class="area-stats">
                    <div class="stat-card">
                        <div class="stat-value">${areaHa}</div>
                        <div class="stat-label">Hectares</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.biodiversityScore}/100</div>
                        <div class="stat-label">Bio Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">£${(data.landValue).toLocaleString()}</div>
                        <div class="stat-label">Est. Value</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${perimeterKm} km</div>
                        <div class="stat-label">Perimeter</div>
                    </div>
                </div>

                <div class="area-details">
                    <div class="detail-section">
                        <h4><i class="material-symbols-rounded">info</i> Basic Information</h4>
                        <div class="detail-list">
                            <div class="detail-item">
                                <span class="detail-label">OSM ID</span>
                                <span class="detail-value">${data.osmId}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Last Surveyed</span>
                                <span class="detail-value">${data.lastSurveyed}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Version</span>
                                <span class="detail-value">${data.version}</span>
                            </div>
                            ${tags.operator ? `
                            <div class="detail-item">
                                <span class="detail-label">Operator</span>
                                <span class="detail-value">${tags.operator}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4><i class="material-symbols-rounded">landscape</i> Land Characteristics</h4>
                        <div class="detail-list">
                            <div class="detail-item">
                                <span class="detail-label">Soil Type</span>
                                <span class="detail-value">${data.soilType}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Drainage</span>
                                <span class="detail-value">${data.drainage}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Access</span>
                                <span class="detail-value">${data.access}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Biodiversity</span>
                                <span class="detail-value">${data.biodiversityScore}/100 (${data.biodiversityScore > 80 ? 'Excellent' : data.biodiversityScore > 60 ? 'Good' : 'Fair'})</span>
                            </div>
                        </div>
                    </div>

                    ${Object.keys(tags).length > 0 ? `
                    <div class="detail-section">
                        <h4><i class="material-symbols-rounded">label</i> OSM Properties</h4>
                        <div class="detail-list">
                            ${Object.entries(tags).filter(([key]) => key !== 'name').map(([key, value]) => `
                                <div class="detail-item">
                                    <span class="detail-label">${key.replace('_', ' ')}</span>
                                    <span class="detail-value">${value}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>

                <div class="polygon-actions">
                    <button class="polygon-btn primary" onclick="zoomToPolygon()">
                        <i class="material-symbols-rounded">zoom_in</i>
                        Zoom to Area
                    </button>
                    <button class="polygon-btn secondary" onclick="exportPolygonData('${data.name}')">
                        <i class="material-symbols-rounded">download</i>
                        Export Data
                    </button>
                </div>
            `;

            polygonTitle.textContent = `${data.name} - Area Details`;
        }

        function calculatePerimeter(geometry) {
            if (!geometry || geometry.length < 2) return 0;
            
            let perimeter = 0;
            for (let i = 0; i < geometry.length - 1; i++) {
                const p1 = geometry[i];
                const p2 = geometry[i + 1];
                const distance = Math.sqrt(
                    Math.pow((p2.lat - p1.lat) * 111319.9, 2) + 
                    Math.pow((p2.lon - p1.lon) * 111319.9 * Math.cos(p1.lat * Math.PI / 180), 2)
                );
                perimeter += distance;
            }
            return perimeter;
        }

        function calculateLandValue(area, category) {
            const areaHa = area / 10000;
            const baseValues = {
                farmland: 8500, residential: 50000, commercial: 120000, industrial: 25000,
                forest: 3500, grassland: 4500, parks: 15000, water: 2000, buildings: 180000
            };
            return Math.round((baseValues[category] || 5000) * areaHa);
        }

        function getSoilType(category) {
            const soilTypes = {
                farmland: 'Loamy Clay', residential: 'Sandy Loam', commercial: 'Clay',
                industrial: 'Clay', forest: 'Organic Rich', grassland: 'Sandy Loam',
                parks: 'Loamy', water: 'N/A', buildings: 'Compacted'
            };
            return soilTypes[category] || 'Mixed';
        }

        function getDrainageInfo(category) {
            const drainage = {
                farmland: 'Well Drained', residential: 'Good', commercial: 'Fair',
                industrial: 'Poor', forest: 'Excellent', grassland: 'Good',
                parks: 'Good', water: 'N/A', buildings: 'Managed'
            };
            return drainage[category] || 'Unknown';
        }

        function getAccessInfo(category) {
            const access = {
                farmland: 'Farm Track', residential: 'Road Access', commercial: 'Good Road Access',
                industrial: 'Industrial Access', forest: 'Footpath', grassland: 'Field Access',
                parks: 'Public Access', water: 'Limited', buildings: 'Direct Access'
            };
            return access[category] || 'Unknown';
        }

        function zoomToPolygon() {
            if (selectedPolygon) {
                map.fitBounds(selectedPolygon.getBounds(), { padding: [20, 20] });
                showLayerNotification('Zoomed to selected area');
            }
        }

        function exportPolygonData(name) {
            showLayerNotification(`Exporting data for ${name}...`);
            // In a real implementation, this would export the polygon data
            setTimeout(() => {
                showLayerNotification('Export functionality coming soon');
            }, 1500);
        }

        function initializeContextMenuAndPlans() {
            try {
                // Initialize context menu
                contextMenu = document.getElementById('contextMenu');
                planSelectionModal = document.getElementById('planSelectionModal');
                
                if (contextMenu) {
                    // Context menu event handlers
                    document.addEventListener('click', function(e) {
                        if (contextMenu && !contextMenu.contains(e.target)) {
                            hideContextMenu();
                        }
                    });

                    contextMenu.addEventListener('click', function(e) {
                        const action = e.target.closest('.context-menu-item')?.dataset.action;
                        
                        if (action && currentFeatureData) {
                            hideContextMenu();
                            handleContextMenuAction(action);
                        }
                    });
                }
                
                console.log('Context menu and plans initialized successfully');
            } catch (error) {
                console.error('Context menu and plans initialization failed:', error);
            }
        }

        // ========== Context Menu and Plan Selection Functionality ==========
        
        // Context menu variables - moved to global section

        function showPolygonContextMenu(event, featureData, polygonObj = null) {
            currentFeatureData = featureData;
            currentPolygonObj = polygonObj;
            
            // Position context menu at mouse location
            const x = event.clientX;
            const y = event.clientY;
            
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            contextMenu.style.display = 'block';
            
            // Adjust position if menu would go off screen
            setTimeout(() => {
                const menuRect = contextMenu.getBoundingClientRect();
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                
                if (menuRect.right > windowWidth) {
                    contextMenu.style.left = (x - menuRect.width) + 'px';
                }
                if (menuRect.bottom > windowHeight) {
                    contextMenu.style.top = (y - menuRect.height) + 'px';
                }
            }, 10);
        }

        function hideContextMenu() {
            contextMenu.style.display = 'none';
        }

        function showPlanSelectionModal() {
            planSelectionModal.classList.add('visible');
            // Reset plan selection
            selectedPlan = null;
            document.querySelectorAll('.plan-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.getElementById('confirmPlanCopy').disabled = true;
        }

        function hidePlanSelectionModal() {
            planSelectionModal.classList.remove('visible');
            selectedPlan = null;
        }

        function copyFeatureToPlan(featureData, planId) {
            // Simulate copying feature to plan
            const planNames = {
                'habitat-restoration': 'Habitat Restoration Project',
                'land-development': 'Land Development Plan',
                'conservation': 'Conservation Strategy',
                'agriculture': 'Agricultural Optimization',
                'monitoring': 'Environmental Monitoring'
            };
            
            const planName = planNames[planId] || 'Selected Plan';
            const featureName = featureData.name || 'Unnamed Feature';
            
            showLayerNotification(`✅ "${featureName}" copied to ${planName}`);
            
            // In a real implementation, this would:
            // 1. Add the feature geometry to the selected plan
            // 2. Store the feature data and properties
            // 3. Update the plan's analysis and calculations
            // 4. Refresh the left panel to show the updated plan
            
            console.log('Feature copied to plan:', {
                feature: featureData,
                plan: planId,
                planName: planName
            });
        }

        // Context menu event handlers
        document.addEventListener('click', function(e) {
            if (contextMenu && !contextMenu.contains(e.target)) {
                hideContextMenu();
            }
        });

        if (contextMenu) {
            contextMenu.addEventListener('click', function(e) {
            const action = e.target.closest('.context-menu-item')?.dataset.action;
            
            if (action && currentFeatureData) {
                hideContextMenu();
                
                switch (action) {
                    case 'inspect':
                        if (currentPolygonObj) {
                            selectPolygon(currentPolygonObj, currentFeatureData);
                        }
                        break;
                    case 'copy-to-plan':
                        showPlanSelectionModal();
                        break;
                    case 'export':
                        exportPolygonData(currentFeatureData.name);
                        break;
                    case 'view-source':
                        const osmId = currentFeatureData.id;
                        if (osmId) {
                            window.open(`https://www.openstreetmap.org/${currentFeatureData.type}/${osmId}`, '_blank');
                        }
                        break;
                }
            }
            });
        }

        // Plan selection modal event handlers
        document.querySelectorAll('.plan-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remove previous selection
                document.querySelectorAll('.plan-option').forEach(opt => opt.classList.remove('selected'));
                
                // Select this option
                this.classList.add('selected');
                selectedPlan = this.dataset.plan;
                
                // Enable confirm button
                document.getElementById('confirmPlanCopy').disabled = false;
            });
        });

        const cancelPlanSelectionBtn = document.getElementById('cancelPlanSelection');
        if (cancelPlanSelectionBtn) {
            cancelPlanSelectionBtn.addEventListener('click', function() {
                hidePlanSelectionModal();
            });
        }

        const confirmPlanCopyBtn = document.getElementById('confirmPlanCopy');
        if (confirmPlanCopyBtn) {
            confirmPlanCopyBtn.addEventListener('click', function() {
                if (selectedPlan && currentFeatureData) {
                    copyFeatureToPlan(currentFeatureData, selectedPlan);
                    hidePlanSelectionModal();
                }
            });
        }

        // Close modal when clicking outside
        if (planSelectionModal) {
            planSelectionModal.addEventListener('click', function(e) {
                if (e.target === planSelectionModal) {
                    hidePlanSelectionModal();
                }
            });
        }

        // ========== OSM Feature Inspection Functionality ==========
        const inspectionPanelClose = document.getElementById('inspectionPanelClose');
        const inspectionTitle = document.getElementById('inspectionTitle');
        const inspectionContent = document.getElementById('inspectionContent');

        // Close inspection panel
        if (inspectionPanelClose) {
            inspectionPanelClose.addEventListener('click', function() {
                inspectionPanel.classList.remove('visible');
                showLayerNotification('Feature inspection closed');
            });
        }

        // Custom context menu for OSM markers
        // contextMenu and currentFeatureData moved to global section

        function createContextMenu() {
            const menu = document.createElement('div');
            menu.className = 'osm-context-menu';
            menu.style.cssText = `
                position: fixed;
                background: white;
                border: 1px solid var(--md-sys-color-outline-variant);
                border-radius: 8px;
                box-shadow: var(--md-sys-elevation-level3);
                z-index: 2000;
                min-width: 180px;
                padding: 8px 0;
                display: none;
            `;
            
            menu.innerHTML = `
                <div class="context-menu-item" data-action="inspect">
                    <i class="material-symbols-rounded">info</i>
                    <span>Inspect Feature</span>
                </div>
                <div class="context-menu-item" data-action="center">
                    <i class="material-symbols-rounded">center_focus_strong</i>
                    <span>Center on Map</span>
                </div>
                <div class="context-menu-item" data-action="directions">
                    <i class="material-symbols-rounded">directions</i>
                    <span>Get Directions</span>
                </div>
            `;

            // Add CSS for menu items
            const style = document.createElement('style');
            style.textContent = `
                .context-menu-item {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    padding: 12px 16px;
                    cursor: pointer;
                    transition: background-color 0.2s;
                    color: var(--md-sys-color-on-surface);
                }
                .context-menu-item:hover {
                    background: var(--md-sys-color-surface-container-high);
                }
                .context-menu-item i {
                    font-size: 20px;
                    color: var(--md-sys-color-on-surface-variant);
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(menu);
            return menu;
        }

        function showOSMContextMenu(e, featureData) {
            if (e && typeof e.preventDefault === 'function') {
                e.preventDefault();
            }
            
            if (!contextMenu) {
                contextMenu = createContextMenu();
            }

            currentFeatureData = featureData;
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.clientX + 'px';
            contextMenu.style.top = e.clientY + 'px';

            // Add event listeners to menu items
            contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    handleContextMenuAction(action, currentFeatureData);
                    hideContextMenu();
                });
            });
        }

        function hideContextMenu() {
            if (contextMenu) {
                contextMenu.style.display = 'none';
            }
        }

        function handleContextMenuAction(action, featureData) {
            switch (action) {
                case 'inspect':
                    inspectFeature(featureData);
                    break;
                case 'center':
                    map.setView([featureData.lat, featureData.lon], 18);
                    showLayerNotification('Centered on feature');
                    break;
                case 'directions':
                    getDirections(featureData);
                    break;
            }
        }

        async function inspectFeature(featureData) {
            // Show panel and loading state
            inspectionPanel.classList.add('visible');
            inspectionTitle.textContent = 'Feature Details';
            inspectionContent.innerHTML = `
                <div class="inspection-loading">
                    <i class="material-symbols-rounded spinning">refresh</i>
                    <p>Loading detailed feature information...</p>
                </div>
            `;

            // Close OSM panel if open to give more space
            if (osmPanel.classList.contains('visible')) {
                osmPanel.classList.remove('visible');
            }

            try {
                // Get detailed feature information
                const detailedInfo = await getDetailedFeatureInfo(featureData);
                displayFeatureDetails(detailedInfo);
                showLayerNotification('Feature inspection opened');
            } catch (error) {
                console.error('Failed to get detailed feature info:', error);
                inspectionContent.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--md-sys-color-error);">
                        <i class="material-symbols-rounded" style="font-size: 48px; margin-bottom: 16px;">error</i>
                        <p>Failed to load feature details</p>
                        <button class="action-btn secondary" onclick="inspectionPanel.classList.remove('visible')">Close</button>
                    </div>
                `;
            }
        }

        async function getDetailedFeatureInfo(featureData) {
            // In a real implementation, this would make additional API calls
            // For now, we'll enhance the existing data and simulate additional info
            
            const enhanced = {
                ...featureData,
                lastUpdated: new Date().toLocaleDateString(),
                osmId: featureData.id || 'N/A',
                version: Math.floor(Math.random() * 10) + 1,
                changeset: Math.floor(Math.random() * 100000000),
                contributors: Math.floor(Math.random() * 5) + 1
            };

            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000));

            return enhanced;
        }

        function displayFeatureDetails(featureData) {
            const tags = featureData.tags || {};
            const name = tags.name || tags.amenity || tags.shop || tags.leisure || 'Unnamed Feature';
            const category = tags.amenity || tags.shop || tags.leisure || tags.highway || tags.natural || 'other';
            
            const categoryIcons = {
                restaurant: '🍽️',
                cafe: '☕',
                school: '🏫',
                hospital: '🏥',
                park: '🌳',
                shop: '🛍️',
                bank: '🏦',
                pharmacy: '💊',
                fuel: '⛽',
                hotel: '🏨',
                default: '📍'
            };

            const icon = categoryIcons[category] || categoryIcons.default;

            inspectionContent.innerHTML = `
                <div class="feature-header">
                    <div class="feature-icon">${icon}</div>
                    <div class="feature-title">
                        <h1 class="feature-name">${name}</h1>
                        <p class="feature-category">${category.replace('_', ' ')}</p>
                    </div>
                </div>

                <div class="coordinates-section">
                    <h4><i class="material-symbols-rounded">location_on</i> Location</h4>
                    <div class="coordinates-grid">
                        <div class="coord-item">
                            <div class="coord-label">Latitude</div>
                            <div class="coord-value">${featureData.lat.toFixed(6)}</div>
                        </div>
                        <div class="coord-item">
                            <div class="coord-label">Longitude</div>
                            <div class="coord-value">${featureData.lon.toFixed(6)}</div>
                        </div>
                    </div>
                </div>

                ${Object.keys(tags).length > 0 ? `
                <div class="feature-section">
                    <h4><i class="material-symbols-rounded">label</i> Properties</h4>
                    ${Object.entries(tags).map(([key, value]) => {
                        if (key === 'name') return '';
                        
                        let displayValue = value;
                        if (key === 'website' && value) {
                            displayValue = `<a href="${value}" target="_blank">${value}</a>`;
                        } else if (key === 'phone' && value) {
                            displayValue = `<a href="tel:${value}">${value}</a>`;
                        } else if (key === 'email' && value) {
                            displayValue = `<a href="mailto:${value}">${value}</a>`;
                        }
                        
                        return `
                            <div class="feature-property">
                                <span class="property-label">${key.replace('_', ' ')}</span>
                                <span class="property-value">${displayValue}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
                ` : ''}

                <div class="feature-section">
                    <h4><i class="material-symbols-rounded">info</i> OpenStreetMap Data</h4>
                    <div class="feature-property">
                        <span class="property-label">OSM ID</span>
                        <span class="property-value">${featureData.osmId}</span>
                    </div>
                    <div class="feature-property">
                        <span class="property-label">Version</span>
                        <span class="property-value">${featureData.version}</span>
                    </div>
                    <div class="feature-property">
                        <span class="property-label">Last Updated</span>
                        <span class="property-value">${featureData.lastUpdated}</span>
                    </div>
                    <div class="feature-property">
                        <span class="property-label">Contributors</span>
                        <span class="property-value">${featureData.contributors} users</span>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="action-btn primary" onclick="centerOnFeature(${featureData.lat}, ${featureData.lon})">
                        <i class="material-symbols-rounded">center_focus_strong</i>
                        Center on Map
                    </button>
                    <button class="action-btn secondary" onclick="getDirections({lat: ${featureData.lat}, lon: ${featureData.lon}, name: '${name}'})">
                        <i class="material-symbols-rounded">directions</i>
                        Directions
                    </button>
                </div>

                ${tags.amenity ? `
                <div class="feature-section">
                    <h4><i class="material-symbols-rounded">nearby</i> Related Features</h4>
                    <div class="related-features">
                        <div class="related-item">
                            <div class="related-icon">🏪</div>
                            <div class="related-info">
                                <p class="related-name">Similar amenities nearby</p>
                                <p class="related-distance">Search within 500m</p>
                            </div>
                        </div>
                        <div class="related-item">
                            <div class="related-icon">🚌</div>
                            <div class="related-info">
                                <p class="related-name">Public transport</p>
                                <p class="related-distance">Find nearest stops</p>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;

            inspectionTitle.textContent = `${name} - Details`;
        }

        function centerOnFeature(lat, lon) {
            map.setView([lat, lon], 18);
            showLayerNotification('Centered on feature');
        }

        function getDirections(featureData) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    const url = `https://www.google.com/maps/dir/${userLat},${userLon}/${featureData.lat},${featureData.lon}`;
                    window.open(url, '_blank');
                    showLayerNotification('Opening directions in Google Maps');
                }, function() {
                    const url = `https://www.google.com/maps/dir//${featureData.lat},${featureData.lon}`;
                    window.open(url, '_blank');
                    showLayerNotification('Opening directions in Google Maps');
                });
            } else {
                const url = `https://www.google.com/maps/dir//${featureData.lat},${featureData.lon}`;
                window.open(url, '_blank');
                showLayerNotification('Opening directions in Google Maps');
            }
        }

        // Hide context menu when clicking elsewhere
        document.addEventListener('click', hideContextMenu);

        // Prevent context menu from closing when clicking on it
        document.addEventListener('click', function(e) {
            if (contextMenu && contextMenu.contains(e.target)) {
                e.stopPropagation();
            }
        });
    </script>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="inspect">
            <i class="material-symbols-rounded">info</i>
            <span>Inspect Feature</span>
        </div>
        <div class="context-menu-item" data-action="copy-to-plan">
            <i class="material-symbols-rounded">content_copy</i>
            <span>Copy to Plan</span>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="export">
            <i class="material-symbols-rounded">download</i>
            <span>Export Data</span>
        </div>
        <div class="context-menu-item" data-action="view-source">
            <i class="material-symbols-rounded">open_in_new</i>
            <span>View in OSM</span>
        </div>
    </div>

    <!-- Plan Selection Modal -->
    <div class="plan-selection-modal" id="planSelectionModal">
        <div class="plan-selection-dialog">
            <div class="plan-selection-header">
                <i class="material-symbols-rounded">folder_copy</i>
                <h3>Copy to Plan</h3>
            </div>
            <div class="plan-selection-content">
                <div class="plan-option" data-plan="habitat-restoration">
                    <div class="plan-option-icon">
                        <i class="material-symbols-rounded">eco</i>
                    </div>
                    <div class="plan-option-info">
                        <h4>Habitat Restoration Project</h4>
                        <p>Biodiversity enhancement and ecosystem restoration</p>
                    </div>
                </div>
                <div class="plan-option" data-plan="land-development">
                    <div class="plan-option-icon">
                        <i class="material-symbols-rounded">construction</i>
                    </div>
                    <div class="plan-option-info">
                        <h4>Land Development Plan</h4>
                        <p>Sustainable development and urban planning</p>
                    </div>
                </div>
                <div class="plan-option" data-plan="conservation">
                    <div class="plan-option-icon">
                        <i class="material-symbols-rounded">forest</i>
                    </div>
                    <div class="plan-option-info">
                        <h4>Conservation Strategy</h4>
                        <p>Protected area management and wildlife conservation</p>
                    </div>
                </div>
                <div class="plan-option" data-plan="agriculture">
                    <div class="plan-option-icon">
                        <i class="material-symbols-rounded">agriculture</i>
                    </div>
                    <div class="plan-option-info">
                        <h4>Agricultural Optimization</h4>
                        <p>Sustainable farming and crop management</p>
                    </div>
                </div>
                <div class="plan-option" data-plan="monitoring">
                    <div class="plan-option-icon">
                        <i class="material-symbols-rounded">monitoring</i>
                    </div>
                    <div class="plan-option-info">
                        <h4>Environmental Monitoring</h4>
                        <p>Long-term environmental health tracking</p>
                    </div>
                </div>
            </div>
            <div class="plan-selection-actions">
                <button class="plan-action-btn secondary" id="cancelPlanSelection">Cancel</button>
                <button class="plan-action-btn primary" id="confirmPlanCopy">Copy to Plan</button>
            </div>
        </div>
    </div>
</body>
</html>